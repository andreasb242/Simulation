<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>(AB)² Simulation: /home/andreas/git/SimulationBA/NetbeansDirchooser/src/org/netbeans/swing/dirchooser/DirectoryChooserUI.java Quellcode</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Erzeugt von Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Suchen');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="simulation.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">(AB)² Simulation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Hauptseite</span></a></li>
      <li><a href="pages.html"><span>Zusätzliche&#160;Informationen</span></a></li>
      <li><a href="namespaces.html"><span>Pakete</span></a></li>
      <li><a href="annotated.html"><span>Klassen</span></a></li>
      <li class="current"><a href="files.html"><span>Dateien</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Suchen" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Auflistung&#160;der&#160;Dateien</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_directory_chooser_u_i_8java.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>/home/andreas/git/SimulationBA/NetbeansDirchooser/src/org/netbeans/swing/dirchooser/DirectoryChooserUI.java</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright 1997-2010 Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Oracle and Java are registered trademarks of Oracle and/or its affiliates.</span>
<a name="l00007"></a>00007 <span class="comment"> * Other names may be trademarks of their respective owners.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * The contents of this file are subject to the terms of either the GNU</span>
<a name="l00010"></a>00010 <span class="comment"> * General Public License Version 2 only (&quot;GPL&quot;) or the Common</span>
<a name="l00011"></a>00011 <span class="comment"> * Development and Distribution License(&quot;CDDL&quot;) (collectively, the</span>
<a name="l00012"></a>00012 <span class="comment"> * &quot;License&quot;). You may not use this file except in compliance with the</span>
<a name="l00013"></a>00013 <span class="comment"> * License. You can obtain a copy of the License at</span>
<a name="l00014"></a>00014 <span class="comment"> * http://www.netbeans.org/cddl-gplv2.html</span>
<a name="l00015"></a>00015 <span class="comment"> * or nbbuild/licenses/CDDL-GPL-2-CP. See the License for the</span>
<a name="l00016"></a>00016 <span class="comment"> * specific language governing permissions and limitations under the</span>
<a name="l00017"></a>00017 <span class="comment"> * License.  When distributing the software, include this License Header</span>
<a name="l00018"></a>00018 <span class="comment"> * Notice in each file and include the License file at</span>
<a name="l00019"></a>00019 <span class="comment"> * nbbuild/licenses/CDDL-GPL-2-CP.  Oracle designates this</span>
<a name="l00020"></a>00020 <span class="comment"> * particular file as subject to the &quot;Classpath&quot; exception as provided</span>
<a name="l00021"></a>00021 <span class="comment"> * by Oracle in the GPL Version 2 section of the License file that</span>
<a name="l00022"></a>00022 <span class="comment"> * accompanied this code. If applicable, add the following below the</span>
<a name="l00023"></a>00023 <span class="comment"> * License Header, with the fields enclosed by brackets [] replaced by</span>
<a name="l00024"></a>00024 <span class="comment"> * your own identifying information:</span>
<a name="l00025"></a>00025 <span class="comment"> * &quot;Portions Copyrighted [year] [name of copyright owner]&quot;</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * Contributor(s):</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * The Original Software is NetBeans. The Initial Developer of the Original</span>
<a name="l00030"></a>00030 <span class="comment"> * Software is Sun Microsystems, Inc. Portions Copyright 1997-2006 Sun</span>
<a name="l00031"></a>00031 <span class="comment"> * Microsystems, Inc. All Rights Reserved.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * If you wish your version of this file to be governed by only the CDDL</span>
<a name="l00034"></a>00034 <span class="comment"> * or only the GPL Version 2, indicate your decision by adding</span>
<a name="l00035"></a>00035 <span class="comment"> * &quot;[Contributor] elects to include this software in this distribution</span>
<a name="l00036"></a>00036 <span class="comment"> * under the [CDDL or GPL Version 2] license.&quot; If you do not indicate a</span>
<a name="l00037"></a>00037 <span class="comment"> * single choice of license, a recipient has the option to distribute</span>
<a name="l00038"></a>00038 <span class="comment"> * your version of this file under either the CDDL, the GPL Version 2 or</span>
<a name="l00039"></a>00039 <span class="comment"> * to extend the choice of license to its licensees as provided above.</span>
<a name="l00040"></a>00040 <span class="comment"> * However, if you add GPL Version 2 code and therefore, elected the GPL</span>
<a name="l00041"></a>00041 <span class="comment"> * Version 2 license, then the option applies only if the new code is</span>
<a name="l00042"></a>00042 <span class="comment"> * made subject to such option by the copyright holder.</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * Contributor(s): Soot Phengsy</span>
<a name="l00045"></a>00045 <span class="comment"> */</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">package </span>org.netbeans.swing.dirchooser;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keyword">import</span> java.awt.AWTKeyStroke;
<a name="l00050"></a>00050 <span class="keyword">import</span> java.awt.BorderLayout;
<a name="l00051"></a>00051 <span class="keyword">import</span> java.awt.Color;
<a name="l00052"></a>00052 <span class="keyword">import</span> java.awt.Component;
<a name="l00053"></a>00053 <span class="keyword">import</span> java.awt.ComponentOrientation;
<a name="l00054"></a>00054 <span class="keyword">import</span> java.awt.Cursor;
<a name="l00055"></a>00055 <span class="keyword">import</span> java.awt.Dimension;
<a name="l00056"></a>00056 <span class="keyword">import</span> java.awt.EventQueue;
<a name="l00057"></a>00057 <span class="keyword">import</span> java.awt.Font;
<a name="l00058"></a>00058 <span class="keyword">import</span> java.awt.Graphics;
<a name="l00059"></a>00059 <span class="keyword">import</span> java.awt.KeyboardFocusManager;
<a name="l00060"></a>00060 <span class="keyword">import</span> java.awt.Rectangle;
<a name="l00061"></a>00061 <span class="keyword">import</span> java.awt.Toolkit;
<a name="l00062"></a>00062 <span class="keyword">import</span> java.awt.Window;
<a name="l00063"></a>00063 <span class="keyword">import</span> java.awt.event.ActionEvent;
<a name="l00064"></a>00064 <span class="keyword">import</span> java.awt.event.ActionListener;
<a name="l00065"></a>00065 <span class="keyword">import</span> java.awt.event.FocusAdapter;
<a name="l00066"></a>00066 <span class="keyword">import</span> java.awt.event.FocusEvent;
<a name="l00067"></a>00067 <span class="keyword">import</span> java.awt.event.FocusListener;
<a name="l00068"></a>00068 <span class="keyword">import</span> java.awt.event.KeyAdapter;
<a name="l00069"></a>00069 <span class="keyword">import</span> java.awt.event.KeyEvent;
<a name="l00070"></a>00070 <span class="keyword">import</span> java.awt.event.MouseAdapter;
<a name="l00071"></a>00071 <span class="keyword">import</span> java.awt.event.MouseEvent;
<a name="l00072"></a>00072 <span class="keyword">import</span> java.beans.PropertyChangeEvent;
<a name="l00073"></a>00073 <span class="keyword">import</span> java.beans.PropertyChangeListener;
<a name="l00074"></a>00074 <span class="keyword">import</span> java.io.File;
<a name="l00075"></a>00075 <span class="keyword">import</span> java.io.IOException;
<a name="l00076"></a>00076 <span class="keyword">import</span> java.lang.ref.WeakReference;
<a name="l00077"></a>00077 <span class="keyword">import</span> java.lang.reflect.Constructor;
<a name="l00078"></a>00078 <span class="keyword">import</span> java.security.AccessControlException;
<a name="l00079"></a>00079 <span class="keyword">import</span> java.text.MessageFormat;
<a name="l00080"></a>00080 <span class="keyword">import</span> java.util.ArrayList;
<a name="l00081"></a>00081 <span class="keyword">import</span> java.util.Arrays;
<a name="l00082"></a>00082 <span class="keyword">import</span> java.util.HashMap;
<a name="l00083"></a>00083 <span class="keyword">import</span> java.util.HashSet;
<a name="l00084"></a>00084 <span class="keyword">import</span> java.util.LinkedList;
<a name="l00085"></a>00085 <span class="keyword">import</span> java.util.List;
<a name="l00086"></a>00086 <span class="keyword">import</span> java.util.Locale;
<a name="l00087"></a>00087 <span class="keyword">import</span> java.util.Map;
<a name="l00088"></a>00088 <span class="keyword">import</span> java.util.ResourceBundle;
<a name="l00089"></a>00089 <span class="keyword">import</span> java.util.Set;
<a name="l00090"></a>00090 <span class="keyword">import</span> java.util.Vector;
<a name="l00091"></a>00091 <span class="keyword">import</span> java.util.logging.Level;
<a name="l00092"></a>00092 <span class="keyword">import</span> java.util.logging.Logger;
<a name="l00093"></a>00093 <span class="keyword">import</span> java.util.regex.Matcher;
<a name="l00094"></a>00094 <span class="keyword">import</span> java.util.regex.Pattern;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="keyword">import</span> javax.swing.AbstractAction;
<a name="l00097"></a>00097 <span class="keyword">import</span> javax.swing.AbstractListModel;
<a name="l00098"></a>00098 <span class="keyword">import</span> javax.swing.Action;
<a name="l00099"></a>00099 <span class="keyword">import</span> javax.swing.ActionMap;
<a name="l00100"></a>00100 <span class="keyword">import</span> javax.swing.BorderFactory;
<a name="l00101"></a>00101 <span class="keyword">import</span> javax.swing.Box;
<a name="l00102"></a>00102 <span class="keyword">import</span> javax.swing.BoxLayout;
<a name="l00103"></a>00103 <span class="keyword">import</span> javax.swing.ComboBoxModel;
<a name="l00104"></a>00104 <span class="keyword">import</span> javax.swing.Icon;
<a name="l00105"></a>00105 <span class="keyword">import</span> javax.swing.JButton;
<a name="l00106"></a>00106 <span class="keyword">import</span> javax.swing.JComboBox;
<a name="l00107"></a>00107 <span class="keyword">import</span> javax.swing.JComponent;
<a name="l00108"></a>00108 <span class="keyword">import</span> javax.swing.JFileChooser;
<a name="l00109"></a>00109 <span class="keyword">import</span> javax.swing.JLabel;
<a name="l00110"></a>00110 <span class="keyword">import</span> javax.swing.JList;
<a name="l00111"></a>00111 <span class="keyword">import</span> javax.swing.JMenuItem;
<a name="l00112"></a>00112 <span class="keyword">import</span> javax.swing.JOptionPane;
<a name="l00113"></a>00113 <span class="keyword">import</span> javax.swing.JPanel;
<a name="l00114"></a>00114 <span class="keyword">import</span> javax.swing.JPopupMenu;
<a name="l00115"></a>00115 <span class="keyword">import</span> javax.swing.JRootPane;
<a name="l00116"></a>00116 <span class="keyword">import</span> javax.swing.JScrollPane;
<a name="l00117"></a>00117 <span class="keyword">import</span> javax.swing.JTextField;
<a name="l00118"></a>00118 <span class="keyword">import</span> javax.swing.JToolBar;
<a name="l00119"></a>00119 <span class="keyword">import</span> javax.swing.JTree;
<a name="l00120"></a>00120 <span class="keyword">import</span> javax.swing.ListCellRenderer;
<a name="l00121"></a>00121 <span class="keyword">import</span> javax.swing.SwingUtilities;
<a name="l00122"></a>00122 <span class="keyword">import</span> javax.swing.Timer;
<a name="l00123"></a>00123 <span class="keyword">import</span> javax.swing.UIManager;
<a name="l00124"></a>00124 <span class="keyword">import</span> javax.swing.border.EmptyBorder;
<a name="l00125"></a>00125 <span class="keyword">import</span> javax.swing.event.CellEditorListener;
<a name="l00126"></a>00126 <span class="keyword">import</span> javax.swing.event.ChangeEvent;
<a name="l00127"></a>00127 <span class="keyword">import</span> javax.swing.event.DocumentEvent;
<a name="l00128"></a>00128 <span class="keyword">import</span> javax.swing.event.DocumentListener;
<a name="l00129"></a>00129 <span class="keyword">import</span> javax.swing.event.TreeExpansionEvent;
<a name="l00130"></a>00130 <span class="keyword">import</span> javax.swing.event.TreeExpansionListener;
<a name="l00131"></a>00131 <span class="keyword">import</span> javax.swing.event.TreeSelectionEvent;
<a name="l00132"></a>00132 <span class="keyword">import</span> javax.swing.event.TreeSelectionListener;
<a name="l00133"></a>00133 <span class="keyword">import</span> javax.swing.filechooser.FileFilter;
<a name="l00134"></a>00134 <span class="keyword">import</span> javax.swing.filechooser.FileSystemView;
<a name="l00135"></a>00135 <span class="keyword">import</span> javax.swing.filechooser.FileView;
<a name="l00136"></a>00136 <span class="keyword">import</span> javax.swing.plaf.ActionMapUIResource;
<a name="l00137"></a>00137 <span class="keyword">import</span> javax.swing.plaf.ComponentUI;
<a name="l00138"></a>00138 <span class="keyword">import</span> javax.swing.plaf.UIResource;
<a name="l00139"></a>00139 <span class="keyword">import</span> javax.swing.plaf.basic.BasicFileChooserUI;
<a name="l00140"></a>00140 <span class="keyword">import</span> javax.swing.tree.DefaultTreeCellRenderer;
<a name="l00141"></a>00141 <span class="keyword">import</span> javax.swing.tree.DefaultTreeModel;
<a name="l00142"></a>00142 <span class="keyword">import</span> javax.swing.tree.TreeCellEditor;
<a name="l00143"></a>00143 <span class="keyword">import</span> javax.swing.tree.TreeCellRenderer;
<a name="l00144"></a>00144 <span class="keyword">import</span> javax.swing.tree.TreeNode;
<a name="l00145"></a>00145 <span class="keyword">import</span> javax.swing.tree.TreePath;
<a name="l00146"></a>00146 <span class="keyword">import</span> javax.swing.tree.TreeSelectionModel;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="keyword">import</span> org.jdesktop.swingx.util.OS;
<a name="l00149"></a>00149 <span class="keyword">import</span> org.openide.util.RequestProcessor;
<a name="l00150"></a>00150 
<a name="l00156"></a><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">00156</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a> <span class="keyword">extends</span> BasicFileChooserUI {
<a name="l00157"></a>00157     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Dimension horizontalStrut1 = <span class="keyword">new</span> Dimension(25, 1);
<a name="l00158"></a>00158     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Dimension verticalStrut1 = <span class="keyword">new</span> Dimension(1, 4);
<a name="l00159"></a>00159     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Dimension verticalStrut2 = <span class="keyword">new</span> Dimension(1, 6);
<a name="l00160"></a>00160     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Dimension verticalStrut3 = <span class="keyword">new</span> Dimension(1, 8);
<a name="l00161"></a>00161     <span class="keyword">private</span> <span class="keyword">static</span> Dimension PREF_SIZE = <span class="keyword">new</span> Dimension(425, 245);
<a name="l00162"></a>00162     <span class="keyword">private</span> <span class="keyword">static</span> Dimension MIN_SIZE = <span class="keyword">new</span> Dimension(425, 245);
<a name="l00163"></a>00163     <span class="keyword">private</span> <span class="keyword">static</span> Dimension TREE_PREF_SIZE = <span class="keyword">new</span> Dimension(380, 230);
<a name="l00164"></a>00164     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> ACCESSORY_WIDTH = 250;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = Logger.getLogger(<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a>.class.getName());
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a> RP = <span class="keyword">new</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>(<span class="stringliteral">&quot;DirChooser Update Worker&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="keyword">private</span> JPanel centerPanel;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keyword">private</span> JLabel lookInComboBoxLabel;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keyword">private</span> JComboBox directoryComboBox;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keyword">private</span> DirectoryComboBoxModel directoryComboBoxModel;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keyword">private</span> ActionListener directoryComboBoxAction = <span class="keyword">new</span> DirectoryComboBoxAction();
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="keyword">private</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_filter_type_combo_box_model.html">FilterTypeComboBoxModel</a> filterTypeComboBoxModel;
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="keyword">private</span> JTextField filenameTextField;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <span class="keyword">private</span> JComponent placesBar;
<a name="l00185"></a>00185     <span class="keyword">private</span> <span class="keywordtype">boolean</span> placesBarFailed = <span class="keyword">false</span>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keyword">private</span> JButton approveButton;
<a name="l00188"></a>00188     <span class="keyword">private</span> JButton cancelButton;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keyword">private</span> JPanel buttonPanel;
<a name="l00191"></a>00191     <span class="keyword">private</span> JPanel bottomPanel;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keyword">private</span> JComboBox filterTypeComboBox;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keyword">private</span> <span class="keywordtype">int</span> lookInLabelMnemonic = 0;
<a name="l00196"></a>00196     <span class="keyword">private</span> String lookInLabelText = null;
<a name="l00197"></a>00197     <span class="keyword">private</span> String saveInLabelText = null;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keyword">private</span> <span class="keywordtype">int</span> fileNameLabelMnemonic = 0;
<a name="l00200"></a>00200     <span class="keyword">private</span> String fileNameLabelText = null;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keyword">private</span> <span class="keywordtype">int</span> filesOfTypeLabelMnemonic = 0;
<a name="l00203"></a>00203     <span class="keyword">private</span> String filesOfTypeLabelText = null;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="keyword">private</span> String upFolderToolTipText = null;
<a name="l00206"></a>00206     <span class="keyword">private</span> String upFolderAccessibleName = null;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keyword">private</span> String newFolderToolTipText = null;
<a name="l00209"></a>00209     <span class="keyword">private</span> String newFolderAccessibleName = null;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keyword">private</span> String homeFolderTooltipText = null;
<a name="l00212"></a>00212     <span class="keyword">private</span> String homeFolderAccessibleName = null;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keyword">private</span> Action newFolderAction = <span class="keyword">new</span> NewDirectoryAction();
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keyword">private</span> BasicFileView fileView = <span class="keyword">new</span> DirectoryChooserFileView();
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keyword">private</span> <span class="keyword">static</span> JTree tree;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="keyword">private</span> DirectoryTreeModel model;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keyword">private</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_node.html">DirectoryNode</a> newFolderNode;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     <span class="keyword">private</span> JComponent treeViewPanel;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="keyword">private</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_input_blocker.html">InputBlocker</a> blocker;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <span class="keyword">private</span> <span class="keyword">static</span> JFileChooser fileChooser;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keyword">private</span> <span class="keywordtype">boolean</span> changeDirectory = <span class="keyword">true</span>;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="keyword">private</span> <span class="keywordtype">boolean</span> showPopupCompletion = <span class="keyword">false</span>;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="keyword">private</span> <span class="keywordtype">boolean</span> addNewDirectory = <span class="keyword">false</span>;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keyword">private</span> JPopupMenu popupMenu;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <span class="keyword">private</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_file_completion_popup.html">FileCompletionPopup</a> completionPopup;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keyword">private</span> <span class="keyword">final</span> UpdateWorker updateWorker = <span class="keyword">new</span> UpdateWorker();
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keyword">private</span> <span class="keywordtype">boolean</span> useShellFolder = <span class="keyword">false</span>;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="keyword">private</span> JButton upFolderButton;
<a name="l00245"></a>00245     <span class="keyword">private</span> JButton newFolderButton;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="keyword">private</span> JComponent topCombo, topComboWrapper, topToolbar;
<a name="l00248"></a>00248     <span class="keyword">private</span> JPanel slownessPanel;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keyword">private</span> <span class="keyword">final</span> ListFilesWorker listFilesWorker = <span class="keyword">new</span> ListFilesWorker();
<a name="l00251"></a>00251     <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>.Task listFilesTask = RP.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acfe8a3bcca7e5767bbf5b1d2623b7919">create</a>(listFilesWorker);
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="keyword">public</span> <span class="keyword">static</span> ComponentUI createUI(JComponent c) {
<a name="l00254"></a>00254         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a>((JFileChooser) c);
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keyword">public</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a>(JFileChooser filechooser) {
<a name="l00258"></a>00258         super(filechooser);
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     @Override
<a name="l00262"></a>00262     <span class="keyword">public</span> <span class="keywordtype">void</span> installUI(JComponent c) {
<a name="l00263"></a>00263         super.installUI(c);
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     @Override
<a name="l00267"></a>00267     <span class="keyword">public</span> <span class="keywordtype">void</span> uninstallComponents(JFileChooser fc) {
<a name="l00268"></a>00268         fc.removeAll();
<a name="l00269"></a>00269         super.uninstallComponents(fc);
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     @Override
<a name="l00273"></a>00273     <span class="keyword">public</span> <span class="keywordtype">void</span> installComponents(JFileChooser fc) {
<a name="l00274"></a>00274         fileChooser = fc;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         fc.setFocusCycleRoot(<span class="keyword">true</span>);
<a name="l00277"></a>00277         fc.setBorder(<span class="keyword">new</span> EmptyBorder(4, 10, 10, 10));
<a name="l00278"></a>00278         fc.setLayout(<span class="keyword">new</span> BorderLayout(8, 8));
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         updateUseShellFolder();
<a name="l00281"></a>00281         createCenterPanel(fc);
<a name="l00282"></a>00282         fc.add(centerPanel, BorderLayout.CENTER);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (fc.isMultiSelectionEnabled()) {
<a name="l00285"></a>00285             setFileName(getStringOfFileNames(fc.getSelectedFiles()));
<a name="l00286"></a>00286         } <span class="keywordflow">else</span> {
<a name="l00287"></a>00287             setFileName(getStringOfFileName(fc.getSelectedFile()));
<a name="l00288"></a>00288         }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (fc.getControlButtonsAreShown()) {
<a name="l00291"></a>00291             addControlButtons();
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         createPopup();
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         initUpdateWorker();
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299     @Override
<a name="l00300"></a>00300     <span class="keyword">public</span> String getDialogTitle(JFileChooser fc) {
<a name="l00301"></a>00301         String title = super.getDialogTitle(fc);
<a name="l00302"></a>00302         fc.getAccessibleContext().setAccessibleDescription(title);
<a name="l00303"></a>00303         <span class="keywordflow">return</span> title;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keyword">private</span> <span class="keywordtype">void</span> updateUseShellFolder() {
<a name="l00307"></a>00307         <span class="comment">// Decide whether to use the ShellFolder class to populate shortcut</span>
<a name="l00308"></a>00308         <span class="comment">// panel and combobox.</span>
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         Boolean prop = (Boolean) fileChooser.getClientProperty(<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_delegating_chooser_u_i.html">DelegatingChooserUI</a>.USE_SHELL_FOLDER);
<a name="l00311"></a>00311         <span class="keywordflow">if</span> (prop != null) {
<a name="l00312"></a>00312             useShellFolder = prop.booleanValue();
<a name="l00313"></a>00313         } <span class="keywordflow">else</span> {
<a name="l00314"></a>00314             <span class="comment">// See if FileSystemView.getRoots() returns the desktop folder,</span>
<a name="l00315"></a>00315             <span class="comment">// i.e. the normal Windows hierarchy.</span>
<a name="l00316"></a>00316             useShellFolder = <span class="keyword">false</span>;
<a name="l00317"></a>00317             File[] roots = fileChooser.getFileSystemView().getRoots();
<a name="l00318"></a>00318             <span class="keywordflow">if</span> (roots != null &amp;&amp; roots.length == 1) {
<a name="l00319"></a>00319                 File[] cbFolders = getShellFolderRoots();
<a name="l00320"></a>00320                 <span class="keywordflow">if</span> (cbFolders != null &amp;&amp; cbFolders.length &gt; 0 &amp;&amp; Arrays.asList(cbFolders).contains(roots[0])) {
<a name="l00321"></a>00321                     useShellFolder = <span class="keyword">true</span>;
<a name="l00322"></a>00322                 }
<a name="l00323"></a>00323             }
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         <span class="keywordflow">if</span> (<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#a0d284bdff73dc37bcbb17d6dcc22dc83">isWindows</a>()) {
<a name="l00327"></a>00327             <span class="keywordflow">if</span> (useShellFolder) {
<a name="l00328"></a>00328                 <span class="keywordflow">if</span> (placesBar == null) {
<a name="l00329"></a>00329                     placesBar = getPlacesBar();
<a name="l00330"></a>00330                 }
<a name="l00331"></a>00331                 <span class="keywordflow">if</span> (placesBar != null) {
<a name="l00332"></a>00332                     fileChooser.add(placesBar, BorderLayout.BEFORE_LINE_BEGINS);
<a name="l00333"></a>00333                     <span class="keywordflow">if</span> (placesBar instanceof PropertyChangeListener) {
<a name="l00334"></a>00334                         fileChooser.addPropertyChangeListener((PropertyChangeListener) placesBar);
<a name="l00335"></a>00335                     }
<a name="l00336"></a>00336                 }
<a name="l00337"></a>00337             } <span class="keywordflow">else</span> {
<a name="l00338"></a>00338                 <span class="keywordflow">if</span> (placesBar != null) {
<a name="l00339"></a>00339                     fileChooser.remove(placesBar);
<a name="l00340"></a>00340                     <span class="keywordflow">if</span> (placesBar instanceof PropertyChangeListener) {
<a name="l00341"></a>00341                         fileChooser.removePropertyChangeListener((PropertyChangeListener) placesBar);
<a name="l00342"></a>00342                     }
<a name="l00343"></a>00343                     placesBar = null;
<a name="l00344"></a>00344                 }
<a name="l00345"></a>00345             }
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348 
<a name="l00352"></a>00352     <span class="keyword">private</span> JComponent getPlacesBar() {
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (placesBarFailed) {
<a name="l00354"></a>00354             <span class="keywordflow">return</span> null;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         <span class="keywordflow">try</span> {
<a name="l00357"></a>00357             Class&lt;?&gt; clazz = Class.forName(<span class="stringliteral">&quot;sun.swing.WindowsPlacesBar&quot;</span>);
<a name="l00358"></a>00358             Class&lt;?&gt;[] params = <span class="keyword">new</span> Class&lt;?&gt;[] { JFileChooser.class, Boolean.TYPE };
<a name="l00359"></a>00359             Constructor&lt;?&gt; constr = clazz.getConstructor(params);
<a name="l00360"></a>00360             <span class="keywordflow">return</span> (JComponent) constr.newInstance(fileChooser, isXPStyle().booleanValue());
<a name="l00361"></a>00361         } <span class="keywordflow">catch</span> (Exception exc) {
<a name="l00362"></a>00362             <span class="comment">// reflection not succesfull, just log the exception and return null</span>
<a name="l00363"></a>00363             Logger.getLogger(<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a>.class.getName()).log(Level.FINE, <span class="stringliteral">&quot;WindowsPlacesBar class can&#39;t be instantiated.&quot;</span>, exc);
<a name="l00364"></a>00364             placesBarFailed = <span class="keyword">true</span>;
<a name="l00365"></a>00365             <span class="keywordflow">return</span> null;
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368 
<a name="l00372"></a>00372     <span class="keyword">private</span> File getShellFolderForFile(File file) {
<a name="l00373"></a>00373         <span class="keywordflow">try</span> {
<a name="l00374"></a>00374             Class&lt;?&gt; clazz = Class.forName(<span class="stringliteral">&quot;sun.awt.shell.ShellFolder&quot;</span>);
<a name="l00375"></a>00375             <span class="keywordflow">return</span> (File) clazz.getMethod(<span class="stringliteral">&quot;getShellFolder&quot;</span>, File.class).invoke(null, file);
<a name="l00376"></a>00376         } <span class="keywordflow">catch</span> (Exception exc) {
<a name="l00377"></a>00377             <span class="comment">// reflection not succesfull, just log the exception and return null</span>
<a name="l00378"></a>00378             Logger.getLogger(<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a>.class.getName()).log(Level.FINE, <span class="stringliteral">&quot;ShellFolder can&#39;t be used.&quot;</span>, exc);
<a name="l00379"></a>00379             <span class="keywordflow">return</span> null;
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00387"></a>00387     <span class="keyword">private</span> File[] getShellFolderRoots() {
<a name="l00388"></a>00388         <span class="keywordflow">try</span> {
<a name="l00389"></a>00389             Class&lt;?&gt; clazz = Class.forName(<span class="stringliteral">&quot;sun.awt.shell.ShellFolder&quot;</span>);
<a name="l00390"></a>00390             <span class="keywordflow">return</span> (File[]) clazz.getMethod(<span class="stringliteral">&quot;get&quot;</span>, String.class).invoke(null, <span class="stringliteral">&quot;fileChooserComboBoxFolders&quot;</span>);
<a name="l00391"></a>00391         } <span class="keywordflow">catch</span> (Exception exc) {
<a name="l00392"></a>00392             <span class="comment">// reflection not succesfull, just log the exception and return null</span>
<a name="l00393"></a>00393             Logger.getLogger(<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html">DirectoryChooserUI</a>.class.getName()).log(Level.FINE, <span class="stringliteral">&quot;ShellFolder can&#39;t be used.&quot;</span>, exc);
<a name="l00394"></a>00394             <span class="keywordflow">return</span> null;
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396     }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     <span class="keyword">private</span> <span class="keywordtype">void</span> createBottomPanel(JFileChooser fc) {
<a name="l00399"></a>00399         bottomPanel = <span class="keyword">new</span> JPanel();
<a name="l00400"></a>00400         bottomPanel.setLayout(<span class="keyword">new</span> BoxLayout(bottomPanel, BoxLayout.LINE_AXIS));
<a name="l00401"></a>00401         JPanel labelPanel = <span class="keyword">new</span> JPanel();
<a name="l00402"></a>00402         labelPanel.setLayout(<span class="keyword">new</span> BoxLayout(labelPanel, BoxLayout.PAGE_AXIS));
<a name="l00403"></a>00403         labelPanel.add(Box.createRigidArea(verticalStrut1));
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         JLabel fnl = <span class="keyword">new</span> JLabel(fileNameLabelText);
<a name="l00406"></a>00406         fnl.setDisplayedMnemonic(fileNameLabelMnemonic);
<a name="l00407"></a>00407         fnl.setAlignmentY(0);
<a name="l00408"></a>00408         labelPanel.add(fnl);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         labelPanel.add(Box.createRigidArea(<span class="keyword">new</span> Dimension(1, 12)));
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         JLabel ftl = <span class="keyword">new</span> JLabel(filesOfTypeLabelText);
<a name="l00413"></a>00413         ftl.setDisplayedMnemonic(filesOfTypeLabelMnemonic);
<a name="l00414"></a>00414         labelPanel.add(ftl);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         bottomPanel.add(labelPanel);
<a name="l00417"></a>00417         bottomPanel.add(Box.createRigidArea(<span class="keyword">new</span> Dimension(15, 0)));
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         JPanel fileAndFilterPanel = <span class="keyword">new</span> JPanel();
<a name="l00420"></a>00420         fileAndFilterPanel.add(Box.createRigidArea(verticalStrut3));
<a name="l00421"></a>00421         fileAndFilterPanel.setLayout(<span class="keyword">new</span> BoxLayout(fileAndFilterPanel, BoxLayout.Y_AXIS));
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         filenameTextField = <span class="keyword">new</span> JTextField(24) {
<a name="l00424"></a>00424             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426             @Override
<a name="l00427"></a>00427             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a4d66402cd668312068dbb25bd2fee1ec">getMaximumSize</a>() {
<a name="l00428"></a>00428                 <span class="keywordflow">return</span> <span class="keyword">new</span> Dimension(Short.MAX_VALUE, super.getPreferredSize().height);
<a name="l00429"></a>00429             }
<a name="l00430"></a>00430         };
<a name="l00431"></a>00431 
<a name="l00432"></a>00432         filenameTextField.getDocument().addDocumentListener(<span class="keyword">new</span> DocumentListener() {
<a name="l00433"></a>00433             @Override
<a name="l00434"></a>00434             <span class="keyword">public</span> <span class="keywordtype">void</span> insertUpdate(DocumentEvent e) {
<a name="l00435"></a>00435                 updateCompletions();
<a name="l00436"></a>00436             }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438             @Override
<a name="l00439"></a>00439             <span class="keyword">public</span> <span class="keywordtype">void</span> removeUpdate(DocumentEvent e) {
<a name="l00440"></a>00440                 updateCompletions();
<a name="l00441"></a>00441             }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443             @Override
<a name="l00444"></a>00444             <span class="keyword">public</span> <span class="keywordtype">void</span> changedUpdate(DocumentEvent e) {
<a name="l00445"></a>00445             }
<a name="l00446"></a>00446         });
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         filenameTextField.addKeyListener(<span class="keyword">new</span> TextFieldKeyListener());
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         fnl.setLabelFor(filenameTextField);
<a name="l00451"></a>00451         filenameTextField.addFocusListener(<span class="keyword">new</span> FocusAdapter() {
<a name="l00452"></a>00452             @Override
<a name="l00453"></a>00453             <span class="keyword">public</span> <span class="keywordtype">void</span> focusGained(FocusEvent e) {
<a name="l00454"></a>00454                 <span class="keywordflow">if</span> (!getFileChooser().isMultiSelectionEnabled()) {
<a name="l00455"></a>00455                     tree.clearSelection();
<a name="l00456"></a>00456                 }
<a name="l00457"></a>00457             }
<a name="l00458"></a>00458         });
<a name="l00459"></a>00459 
<a name="l00460"></a>00460         <span class="comment">// disable TAB focus transfer, we need it for completion</span>
<a name="l00461"></a>00461         Set&lt;AWTKeyStroke&gt; tKeys = filenameTextField.getFocusTraversalKeys(java.awt.KeyboardFocusManager.FORWARD_TRAVERSAL_KEYS);
<a name="l00462"></a>00462         Set&lt;AWTKeyStroke&gt; newTKeys = <span class="keyword">new</span> HashSet&lt;AWTKeyStroke&gt;(tKeys);
<a name="l00463"></a>00463         newTKeys.remove(AWTKeyStroke.getAWTKeyStroke(KeyEvent.VK_TAB, 0));
<a name="l00464"></a>00464         <span class="comment">// #107305: enable at least Ctrl+TAB if we have TAB for completion</span>
<a name="l00465"></a>00465         newTKeys.add(AWTKeyStroke.getAWTKeyStroke(KeyEvent.VK_TAB, KeyEvent.CTRL_DOWN_MASK));
<a name="l00466"></a>00466         filenameTextField.setFocusTraversalKeys(KeyboardFocusManager.FORWARD_TRAVERSAL_KEYS, newTKeys);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         fileAndFilterPanel.add(filenameTextField);
<a name="l00469"></a>00469         fileAndFilterPanel.add(Box.createRigidArea(verticalStrut3));
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         filterTypeComboBoxModel = createFilterComboBoxModel();
<a name="l00472"></a>00472         fc.addPropertyChangeListener(filterTypeComboBoxModel);
<a name="l00473"></a>00473         filterTypeComboBox = <span class="keyword">new</span> JComboBox(filterTypeComboBoxModel);
<a name="l00474"></a>00474         ftl.setLabelFor(filterTypeComboBox);
<a name="l00475"></a>00475         filterTypeComboBox.setRenderer(createFilterComboBoxRenderer());
<a name="l00476"></a>00476         fileAndFilterPanel.add(filterTypeComboBox);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478         bottomPanel.add(fileAndFilterPanel);
<a name="l00479"></a>00479         bottomPanel.add(Box.createRigidArea(horizontalStrut1));
<a name="l00480"></a>00480         createButtonsPanel(fc);
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keyword">private</span> <span class="keywordtype">void</span> createButtonsPanel(JFileChooser fc) {
<a name="l00484"></a>00484         buttonPanel = <span class="keyword">new</span> JPanel();
<a name="l00485"></a>00485         buttonPanel.setLayout(<span class="keyword">new</span> BoxLayout(buttonPanel, BoxLayout.Y_AXIS));
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         approveButton = <span class="keyword">new</span> JButton(getApproveButtonText(fc)) {
<a name="l00488"></a>00488             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490             @Override
<a name="l00491"></a>00491             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a4d66402cd668312068dbb25bd2fee1ec">getMaximumSize</a>() {
<a name="l00492"></a>00492                 <span class="keywordflow">return</span> approveButton.getPreferredSize().width &gt; cancelButton.getPreferredSize().width ? approveButton.getPreferredSize() : cancelButton
<a name="l00493"></a>00493                         .getPreferredSize();
<a name="l00494"></a>00494             }
<a name="l00495"></a>00495         };
<a name="l00496"></a>00496         <span class="comment">// #107791: No mnemonics desirable on Mac</span>
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (!<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#af4cc2299b416e5a026c8e5cac0093286">isMacOSX</a>()) {
<a name="l00498"></a>00498             approveButton.setMnemonic(getApproveButtonMnemonic(fc));
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500         approveButton.addActionListener(getApproveSelectionAction());
<a name="l00501"></a>00501         approveButton.setToolTipText(getApproveButtonToolTipText(fc));
<a name="l00502"></a>00502         buttonPanel.add(Box.createRigidArea(verticalStrut1));
<a name="l00503"></a>00503         buttonPanel.add(approveButton);
<a name="l00504"></a>00504         buttonPanel.add(Box.createRigidArea(verticalStrut2));
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         cancelButton = <span class="keyword">new</span> JButton(cancelButtonText) {
<a name="l00507"></a>00507             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509             @Override
<a name="l00510"></a>00510             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a4d66402cd668312068dbb25bd2fee1ec">getMaximumSize</a>() {
<a name="l00511"></a>00511                 <span class="keywordflow">return</span> approveButton.getPreferredSize().width &gt; cancelButton.getPreferredSize().width ? approveButton.getPreferredSize() : cancelButton
<a name="l00512"></a>00512                         .getPreferredSize();
<a name="l00513"></a>00513             }
<a name="l00514"></a>00514         };
<a name="l00515"></a>00515         <span class="comment">// #107791: No mnemonics desirable on Mac</span>
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (!<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#af4cc2299b416e5a026c8e5cac0093286">isMacOSX</a>()) {
<a name="l00517"></a>00517             cancelButton.setMnemonic(cancelButtonMnemonic);
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         cancelButton.setToolTipText(cancelButtonToolTipText);
<a name="l00520"></a>00520         cancelButton.addActionListener(getCancelSelectionAction());
<a name="l00521"></a>00521         buttonPanel.add(cancelButton);
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="keyword">private</span> <span class="keywordtype">void</span> createCenterPanel(<span class="keyword">final</span> JFileChooser fc) {
<a name="l00525"></a>00525         centerPanel = <span class="keyword">new</span> JPanel(<span class="keyword">new</span> BorderLayout());
<a name="l00526"></a>00526         treeViewPanel = createTree();
<a name="l00527"></a>00527         treeViewPanel.setPreferredSize(TREE_PREF_SIZE);
<a name="l00528"></a>00528         JPanel treePanel = <span class="keyword">new</span> JPanel();
<a name="l00529"></a>00529         treePanel.setLayout(<span class="keyword">new</span> BorderLayout());
<a name="l00530"></a>00530         JComponent accessory = fc.getAccessory();
<a name="l00531"></a>00531         topToolbar = createTopToolbar();
<a name="l00532"></a>00532         topCombo = createTopCombo(fc);
<a name="l00533"></a>00533         topComboWrapper = <span class="keyword">new</span> JPanel(<span class="keyword">new</span> BorderLayout());
<a name="l00534"></a>00534         topComboWrapper.add(topCombo, BorderLayout.CENTER);
<a name="l00535"></a>00535         <span class="keywordflow">if</span> (accessory == null) {
<a name="l00536"></a>00536             topComboWrapper.add(topToolbar, BorderLayout.EAST);
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538         treePanel.add(topComboWrapper, BorderLayout.NORTH);
<a name="l00539"></a>00539         treePanel.add(treeViewPanel, BorderLayout.CENTER);
<a name="l00540"></a>00540         centerPanel.add(treePanel, BorderLayout.CENTER);
<a name="l00541"></a>00541         <span class="comment">// control width of accessory panel, don&#39;t allow to jump (change width)</span>
<a name="l00542"></a>00542         JPanel wrapAccessory = <span class="keyword">new</span> JPanel() {
<a name="l00543"></a>00543             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545             <span class="keyword">private</span> Dimension prefSize = <span class="keyword">new</span> Dimension(ACCESSORY_WIDTH, 0);
<a name="l00546"></a>00546             <span class="keyword">private</span> Dimension minSize = <span class="keyword">new</span> Dimension(ACCESSORY_WIDTH, 0);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548             @Override
<a name="l00549"></a>00549             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a1995e6e2081d79f1d6e10cba0ff91c97">getMinimumSize</a>() {
<a name="l00550"></a>00550                 <span class="keywordflow">if</span> (fc.getAccessory() != null) {
<a name="l00551"></a>00551                     minSize.height = getAccessoryPanel().getMinimumSize().height;
<a name="l00552"></a>00552                     <span class="keywordflow">return</span> minSize;
<a name="l00553"></a>00553                 }
<a name="l00554"></a>00554                 <span class="keywordflow">return</span> super.getMinimumSize();
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557             @Override
<a name="l00558"></a>00558             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#ad5ad9317d4fd70004c4b6306b2077611">getPreferredSize</a>() {
<a name="l00559"></a>00559                 <span class="keywordflow">if</span> (fc.getAccessory() != null) {
<a name="l00560"></a>00560                     Dimension origPref = getAccessoryPanel().getPreferredSize();
<a name="l00561"></a>00561                     LOG.fine(<span class="stringliteral">&quot;AccessoryWrapper.getPreferredSize: orig pref size: &quot;</span> + origPref);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                     prefSize.height = origPref.height;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                     prefSize.width = Math.max(prefSize.width, origPref.width);
<a name="l00566"></a>00566                     <span class="keywordtype">int</span> centerW = centerPanel.getWidth();
<a name="l00567"></a>00567                     <span class="keywordflow">if</span> (centerW != 0 &amp;&amp; prefSize.width &gt; centerW / 2) {
<a name="l00568"></a>00568                         prefSize.width = centerW / 2;
<a name="l00569"></a>00569                     }
<a name="l00570"></a>00570                     LOG.fine(<span class="stringliteral">&quot;AccessoryWrapper.getPreferredSize: resulting pref size: &quot;</span> + prefSize);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                     <span class="keywordflow">return</span> prefSize;
<a name="l00573"></a>00573                 }
<a name="l00574"></a>00574                 <span class="keywordflow">return</span> super.getPreferredSize();
<a name="l00575"></a>00575             }
<a name="l00576"></a>00576         };
<a name="l00577"></a>00577         wrapAccessory.setLayout(<span class="keyword">new</span> BorderLayout());
<a name="l00578"></a>00578         JPanel accessoryPanel = getAccessoryPanel();
<a name="l00579"></a>00579         <span class="keywordflow">if</span> (accessory != null) {
<a name="l00580"></a>00580             accessoryPanel.add(topToolbar, BorderLayout.NORTH);
<a name="l00581"></a>00581             accessoryPanel.add(accessory, BorderLayout.CENTER);
<a name="l00582"></a>00582         }
<a name="l00583"></a>00583         wrapAccessory.add(accessoryPanel, BorderLayout.CENTER);
<a name="l00584"></a>00584         centerPanel.add(wrapAccessory, BorderLayout.EAST);
<a name="l00585"></a>00585         createBottomPanel(fc);
<a name="l00586"></a>00586         centerPanel.add(bottomPanel, BorderLayout.SOUTH);
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <span class="keyword">private</span> JComponent createTopCombo(JFileChooser fc) {
<a name="l00590"></a>00590         JPanel panel = <span class="keyword">new</span> JPanel();
<a name="l00591"></a>00591         <span class="keywordflow">if</span> (fc.getAccessory() != null) {
<a name="l00592"></a>00592             panel.setBorder(BorderFactory.createEmptyBorder(4, 0, 8, 0));
<a name="l00593"></a>00593         } <span class="keywordflow">else</span> {
<a name="l00594"></a>00594             panel.setBorder(BorderFactory.createEmptyBorder(6, 0, 10, 0));
<a name="l00595"></a>00595         }
<a name="l00596"></a>00596         panel.setLayout(<span class="keyword">new</span> BorderLayout());
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         Box labelBox = Box.createHorizontalBox();
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         lookInComboBoxLabel = <span class="keyword">new</span> JLabel(lookInLabelText);
<a name="l00601"></a>00601         lookInComboBoxLabel.setDisplayedMnemonic(lookInLabelMnemonic);
<a name="l00602"></a>00602         lookInComboBoxLabel.setAlignmentX(JComponent.LEFT_ALIGNMENT);
<a name="l00603"></a>00603         lookInComboBoxLabel.setAlignmentY(JComponent.CENTER_ALIGNMENT);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         labelBox.add(lookInComboBoxLabel);
<a name="l00606"></a>00606         labelBox.add(Box.createRigidArea(<span class="keyword">new</span> Dimension(9, 0)));
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <span class="comment">// fixed #97525, made the height of the</span>
<a name="l00609"></a>00609         <span class="comment">// combo box bigger.</span>
<a name="l00610"></a>00610         directoryComboBox = <span class="keyword">new</span> JComboBox() {
<a name="l00611"></a>00611             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l00612"></a>00612 
<a name="l00613"></a>00613             @Override
<a name="l00614"></a>00614             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a1995e6e2081d79f1d6e10cba0ff91c97">getMinimumSize</a>() {
<a name="l00615"></a>00615                 Dimension d = super.getMinimumSize();
<a name="l00616"></a>00616                 d.width = 60;
<a name="l00617"></a>00617                 <span class="keywordflow">return</span> d;
<a name="l00618"></a>00618             }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620             @Override
<a name="l00621"></a>00621             <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#ad5ad9317d4fd70004c4b6306b2077611">getPreferredSize</a>() {
<a name="l00622"></a>00622                 Dimension d = super.getPreferredSize();
<a name="l00623"></a>00623                 <span class="comment">// Must be small enough to not affect total width and height.</span>
<a name="l00624"></a>00624                 d.height = 24;
<a name="l00625"></a>00625                 d.width = 150;
<a name="l00626"></a>00626                 <span class="keywordflow">return</span> d;
<a name="l00627"></a>00627             }
<a name="l00628"></a>00628         };
<a name="l00629"></a>00629         directoryComboBox.putClientProperty(<span class="stringliteral">&quot;JComboBox.lightweightKeyboardNavigation&quot;</span>, <span class="stringliteral">&quot;Lightweight&quot;</span>);
<a name="l00630"></a>00630         lookInComboBoxLabel.setLabelFor(directoryComboBox);
<a name="l00631"></a>00631         directoryComboBoxModel = createDirectoryComboBoxModel(fc);
<a name="l00632"></a>00632         directoryComboBox.setModel(directoryComboBoxModel);
<a name="l00633"></a>00633         directoryComboBox.addActionListener(directoryComboBoxAction);
<a name="l00634"></a>00634         directoryComboBox.setRenderer(createDirectoryComboBoxRenderer(fc));
<a name="l00635"></a>00635         directoryComboBox.setAlignmentX(JComponent.LEFT_ALIGNMENT);
<a name="l00636"></a>00636         directoryComboBox.setAlignmentY(JComponent.CENTER_ALIGNMENT);
<a name="l00637"></a>00637         directoryComboBox.setMaximumRowCount(8);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         panel.add(labelBox, BorderLayout.WEST);
<a name="l00640"></a>00640         panel.add(directoryComboBox, BorderLayout.CENTER);
<a name="l00641"></a>00641 
<a name="l00642"></a>00642         <span class="keywordflow">return</span> panel;
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="keyword">private</span> JComponent createTopToolbar() {
<a name="l00646"></a>00646         JToolBar topPanel = <span class="keyword">new</span> JToolBar();
<a name="l00647"></a>00647         topPanel.setFloatable(<span class="keyword">false</span>);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         <span class="keywordflow">if</span> (<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#a0d284bdff73dc37bcbb17d6dcc22dc83">isWindows</a>()) {
<a name="l00650"></a>00650             topPanel.putClientProperty(<span class="stringliteral">&quot;JToolBar.isRollover&quot;</span>, Boolean.TRUE);
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         upFolderButton = <span class="keyword">new</span> JButton(getChangeToParentDirectoryAction());
<a name="l00654"></a>00654         upFolderButton.setText(null);
<a name="l00655"></a>00655         <span class="comment">// fixed bug #97049</span>
<a name="l00656"></a>00656         <span class="keyword">final</span> <span class="keywordtype">boolean</span> isMac = <a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#af4cc2299b416e5a026c8e5cac0093286">isMacOSX</a>();
<a name="l00657"></a>00657         Icon upOneLevelIcon = null;
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (!isMac) {
<a name="l00659"></a>00659             upOneLevelIcon = UIManager.getIcon(<span class="stringliteral">&quot;FileChooser.upFolderIcon&quot;</span>);
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661         <span class="comment">// on Mac all icons from UIManager are the same, some default, so load</span>
<a name="l00662"></a>00662         <span class="comment">// our own.</span>
<a name="l00663"></a>00663         <span class="comment">// it&#39;s also fallback if icon from UIManager not found, may happen</span>
<a name="l00664"></a>00664         <span class="keywordflow">if</span> (isMac || upOneLevelIcon == null || jdkBug6840086Workaround()) {
<a name="l00665"></a>00665             <span class="keywordflow">if</span> (isMac) {
<a name="l00666"></a>00666                 upOneLevelIcon = <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_image_utilities.html">ImageUtilities</a>.loadImageIcon(<span class="stringliteral">&quot;org/netbeans/swing/dirchooser/resources/upFolderIcon_mac.png&quot;</span>, <span class="keyword">false</span>);
<a name="l00667"></a>00667             } <span class="keywordflow">else</span> {
<a name="l00668"></a>00668                 upOneLevelIcon = <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_image_utilities.html">ImageUtilities</a>.loadImageIcon(<span class="stringliteral">&quot;org/netbeans/swing/dirchooser/resources/upFolderIcon.gif&quot;</span>, <span class="keyword">false</span>);
<a name="l00669"></a>00669             }
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671         upFolderButton.setIcon(upOneLevelIcon);
<a name="l00672"></a>00672         upFolderButton.setToolTipText(upFolderToolTipText);
<a name="l00673"></a>00673         upFolderButton.getAccessibleContext().setAccessibleName(upFolderAccessibleName);
<a name="l00674"></a>00674         upFolderButton.setAlignmentX(JComponent.RIGHT_ALIGNMENT);
<a name="l00675"></a>00675         upFolderButton.setAlignmentY(JComponent.CENTER_ALIGNMENT);
<a name="l00676"></a>00676 
<a name="l00677"></a>00677         <span class="keywordflow">if</span> (useShellFolder) {
<a name="l00678"></a>00678             upFolderButton.setFocusPainted(<span class="keyword">false</span>);
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         topPanel.add(upFolderButton);
<a name="l00682"></a>00682         topPanel.add(Box.createRigidArea(<span class="keyword">new</span> Dimension(2, 0)));
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         <span class="comment">// no home on Win platform</span>
<a name="l00685"></a>00685         <span class="keywordflow">if</span> (!<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#a0d284bdff73dc37bcbb17d6dcc22dc83">isWindows</a>()) {
<a name="l00686"></a>00686             JButton homeButton = <span class="keyword">new</span> JButton(getGoHomeAction());
<a name="l00687"></a>00687             Icon homeIcon = null;
<a name="l00688"></a>00688             <span class="keywordflow">if</span> (!isMac) {
<a name="l00689"></a>00689                 homeIcon = UIManager.getIcon(<span class="stringliteral">&quot;FileChooser.homeFolderIcon&quot;</span>);
<a name="l00690"></a>00690             }
<a name="l00691"></a>00691             <span class="keywordflow">if</span> (isMac || homeIcon == null) {
<a name="l00692"></a>00692                 <span class="keywordflow">if</span> (isMac) {
<a name="l00693"></a>00693                     homeIcon = <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_image_utilities.html">ImageUtilities</a>.loadImageIcon(<span class="stringliteral">&quot;org/netbeans/swing/dirchooser/resources/homeIcon_mac.png&quot;</span>, <span class="keyword">false</span>);
<a name="l00694"></a>00694                 } <span class="keywordflow">else</span> {
<a name="l00695"></a>00695                     homeIcon = <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_image_utilities.html">ImageUtilities</a>.loadImageIcon(<span class="stringliteral">&quot;org/netbeans/swing/dirchooser/resources/homeIcon.gif&quot;</span>, <span class="keyword">false</span>);
<a name="l00696"></a>00696                 }
<a name="l00697"></a>00697             }
<a name="l00698"></a>00698             homeButton.setIcon(homeIcon);
<a name="l00699"></a>00699             homeButton.setText(null);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701             String tooltip = homeButton.getToolTipText();
<a name="l00702"></a>00702             <span class="keywordflow">if</span> (tooltip == null) {
<a name="l00703"></a>00703                 tooltip = homeFolderTooltipText;
<a name="l00704"></a>00704                 <span class="keywordflow">if</span> (tooltip == null) {
<a name="l00705"></a>00705                     tooltip = getBundle().getString(<span class="stringliteral">&quot;TLTP_HomeFolder&quot;</span>);
<a name="l00706"></a>00706                 }
<a name="l00707"></a>00707                 homeButton.setToolTipText(tooltip);
<a name="l00708"></a>00708             }
<a name="l00709"></a>00709             <span class="keywordflow">if</span> (null != homeFolderAccessibleName)
<a name="l00710"></a>00710                 homeButton.getAccessibleContext().setAccessibleName(homeFolderAccessibleName);
<a name="l00711"></a>00711             topPanel.add(homeButton);
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         newFolderButton = <span class="keyword">new</span> JButton(newFolderAction);
<a name="l00715"></a>00715         newFolderButton.setText(null);
<a name="l00716"></a>00716         <span class="comment">// fixed bug #97049</span>
<a name="l00717"></a>00717         Icon newFoldIcon = null;
<a name="l00718"></a>00718         <span class="keywordflow">if</span> (!isMac) {
<a name="l00719"></a>00719             newFoldIcon = UIManager.getIcon(<span class="stringliteral">&quot;FileChooser.newFolderIcon&quot;</span>);
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721         <span class="comment">// on Mac all icons from UIManager are the same, some default, so load</span>
<a name="l00722"></a>00722         <span class="comment">// our own.</span>
<a name="l00723"></a>00723         <span class="comment">// it&#39;s also fallback if icon from UIManager not found, may happen</span>
<a name="l00724"></a>00724         <span class="keywordflow">if</span> (isMac || newFoldIcon == null || jdkBug6840086Workaround()) {
<a name="l00725"></a>00725             <span class="keywordflow">if</span> (isMac) {
<a name="l00726"></a>00726                 newFoldIcon = <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_image_utilities.html">ImageUtilities</a>.loadImageIcon(<span class="stringliteral">&quot;org/netbeans/swing/dirchooser/resources/newFolderIcon_mac.png&quot;</span>, <span class="keyword">false</span>);
<a name="l00727"></a>00727             } <span class="keywordflow">else</span> {
<a name="l00728"></a>00728                 newFoldIcon = <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_image_utilities.html">ImageUtilities</a>.loadImageIcon(<span class="stringliteral">&quot;org/netbeans/swing/dirchooser/resources/newFolderIcon.gif&quot;</span>, <span class="keyword">false</span>);
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730         }
<a name="l00731"></a>00731         newFolderButton.setIcon(newFoldIcon);
<a name="l00732"></a>00732         newFolderButton.setToolTipText(newFolderToolTipText);
<a name="l00733"></a>00733         newFolderButton.getAccessibleContext().setAccessibleName(newFolderAccessibleName);
<a name="l00734"></a>00734         newFolderButton.setAlignmentX(JComponent.RIGHT_ALIGNMENT);
<a name="l00735"></a>00735         newFolderButton.setAlignmentY(JComponent.CENTER_ALIGNMENT);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (useShellFolder) {
<a name="l00738"></a>00738             newFolderButton.setFocusPainted(<span class="keyword">false</span>);
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         topPanel.add(newFolderButton);
<a name="l00742"></a>00742         topPanel.add(Box.createRigidArea(<span class="keyword">new</span> Dimension(2, 0)));
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         JPanel panel = <span class="keyword">new</span> JPanel();
<a name="l00745"></a>00745         panel.setLayout(<span class="keyword">new</span> BorderLayout());
<a name="l00746"></a>00746         panel.setBorder(BorderFactory.createEmptyBorder(4, 9, 8, 0));
<a name="l00747"></a>00747         panel.add(topPanel, BorderLayout.CENTER);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <span class="keywordflow">return</span> panel;
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="keyword">private</span> JComponent createTree() {
<a name="l00753"></a>00753         <span class="keyword">final</span> DirectoryHandler dirHandler = createDirectoryHandler(fileChooser);
<a name="l00754"></a>00754         <span class="comment">// #106011: don&#39;t show &quot;colors, food, sports&quot; sample model after init</span>
<a name="l00755"></a>00755         <span class="comment">// :-)</span>
<a name="l00756"></a>00756         tree = <span class="keyword">new</span> JTree(<span class="keyword">new</span> Object[0]) {
<a name="l00757"></a>00757             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759             @Override
<a name="l00760"></a>00760             <span class="keyword">protected</span> <span class="keywordtype">void</span> processMouseEvent(MouseEvent e) {
<a name="l00761"></a>00761                 dirHandler.preprocessMouseEvent(e);
<a name="l00762"></a>00762                 super.processMouseEvent(e);
<a name="l00763"></a>00763             }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765             <span class="comment">// For speed (#127170):</span>
<a name="l00766"></a>00766             @Override
<a name="l00767"></a>00767             <span class="keyword">public</span> <span class="keywordtype">boolean</span> isLargeModel() {
<a name="l00768"></a>00768                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00769"></a>00769             }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771             <span class="comment">// #169303: on GTK or Nimbus L&amp;F the row height can be initially set</span>
<a name="l00772"></a>00772             <span class="comment">// to 0 which disables the &quot;large model&quot; optimizations (#127170)</span>
<a name="l00773"></a>00773             @Override
<a name="l00774"></a>00774             <span class="keyword">public</span> <span class="keywordtype">void</span> setRowHeight(<span class="keywordtype">int</span> rowHeight) {
<a name="l00775"></a>00775                 <span class="keywordflow">if</span> (rowHeight &gt; 0) {
<a name="l00776"></a>00776                     super.setRowHeight(rowHeight);
<a name="l00777"></a>00777                 }
<a name="l00778"></a>00778             }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780             <span class="comment">// To work with different font sizes (#106223); see:</span>
<a name="l00781"></a>00781             <span class="comment">// http://www.javalobby.org/java/forums/t19562.html</span>
<a name="l00782"></a>00782             <span class="keyword">private</span> <span class="keywordtype">boolean</span> firstPaint = <span class="keyword">true</span>;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784             @Override
<a name="l00785"></a>00785             <span class="keyword">public</span> <span class="keywordtype">void</span> setFont(Font f) {
<a name="l00786"></a>00786                 firstPaint = <span class="keyword">true</span>;
<a name="l00787"></a>00787                 super.setFont(f);
<a name="l00788"></a>00788             }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790             @Override
<a name="l00791"></a>00791             <span class="keyword">public</span> <span class="keywordtype">void</span> paint(Graphics g) {
<a name="l00792"></a>00792                 <span class="keywordflow">if</span> (firstPaint) {
<a name="l00793"></a>00793                     g.setFont(getFont());
<a name="l00794"></a>00794                     setRowHeight(Math.max(<span class="comment">/* icon height plus insets? */</span>17, g.getFontMetrics().getHeight()));
<a name="l00795"></a>00795                     firstPaint = <span class="keyword">false</span>;
<a name="l00796"></a>00796                     <span class="comment">// Setting the fixed height will generate another paint</span>
<a name="l00797"></a>00797                     <span class="comment">// request, no need to complete this one</span>
<a name="l00798"></a>00798                     <span class="keywordflow">return</span>;
<a name="l00799"></a>00799                 }
<a name="l00800"></a>00800                 super.paint(g);
<a name="l00801"></a>00801             }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803         };
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         tree.setFocusable(<span class="keyword">true</span>);
<a name="l00806"></a>00806         tree.setOpaque(<span class="keyword">true</span>);
<a name="l00807"></a>00807         tree.setRootVisible(<span class="keyword">false</span>);
<a name="l00808"></a>00808         tree.setShowsRootHandles(<span class="keyword">true</span>);
<a name="l00809"></a>00809         tree.setToggleClickCount(0);
<a name="l00810"></a>00810         tree.addTreeExpansionListener(<span class="keyword">new</span> TreeExpansionHandler());
<a name="l00811"></a>00811         <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_tree_key_handler.html">TreeKeyHandler</a> keyHandler = <span class="keyword">new</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_tree_key_handler.html">TreeKeyHandler</a>();
<a name="l00812"></a>00812         tree.addKeyListener(keyHandler);
<a name="l00813"></a>00813         tree.addFocusListener(keyHandler);
<a name="l00814"></a>00814         tree.addMouseListener(dirHandler);
<a name="l00815"></a>00815         tree.addFocusListener(dirHandler);
<a name="l00816"></a>00816         tree.addTreeSelectionListener(dirHandler);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (fileChooser.isMultiSelectionEnabled()) {
<a name="l00819"></a>00819             tree.getSelectionModel().setSelectionMode(TreeSelectionModel.DISCONTIGUOUS_TREE_SELECTION);
<a name="l00820"></a>00820         } <span class="keywordflow">else</span> {
<a name="l00821"></a>00821             tree.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824         TreeCellEditor tce = <span class="keyword">new</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_cell_editor.html">DirectoryCellEditor</a>(tree, fileChooser, <span class="keyword">new</span> JTextField());
<a name="l00825"></a>00825         tree.setCellEditor(tce);
<a name="l00826"></a>00826         tce.addCellEditorListener(dirHandler);
<a name="l00827"></a>00827         tree.setCellRenderer(<span class="keyword">new</span> DirectoryTreeRenderer());
<a name="l00828"></a>00828         JScrollPane scrollBar = <span class="keyword">new</span> JScrollPane(tree);
<a name="l00829"></a>00829         scrollBar.setViewportView(tree);
<a name="l00830"></a>00830         tree.setInvokesStopCellEditing(<span class="keyword">true</span>);
<a name="l00831"></a>00831 
<a name="l00832"></a>00832         <span class="keywordflow">return</span> scrollBar;
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     <span class="keyword">private</span> <span class="keywordtype">boolean</span> jdkBug6840086Workaround() {
<a name="l00836"></a>00836         <span class="comment">// see issue #167080</span>
<a name="l00837"></a>00837         <span class="keywordflow">return</span> <a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html">OS</a>.<a class="code" href="classorg_1_1jdesktop_1_1swingx_1_1util_1_1_o_s.html#a0d284bdff73dc37bcbb17d6dcc22dc83">isWindows</a>() &amp;&amp; <span class="stringliteral">&quot;Windows 7&quot;</span>.equals(System.getProperty(<span class="stringliteral">&quot;os.name&quot;</span>)) &amp;&amp; <span class="stringliteral">&quot;1.6.0_16&quot;</span>.compareTo(System.getProperty(<span class="stringliteral">&quot;java.version&quot;</span>)) &gt;= 0;
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839 
<a name="l00843"></a><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_tree_key_handler.html">00843</a>     <span class="keyword">class </span><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_tree_key_handler.html">TreeKeyHandler</a> <span class="keyword">extends</span> KeyAdapter implements FocusListener {
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         StringBuffer searchBuf = <span class="keyword">new</span> StringBuffer();
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         java.util.List&lt;TreePath&gt; paths;
<a name="l00848"></a>00848         <span class="keyword">private</span> <span class="keyword">final</span> Timer resetBufferTimer = <span class="keyword">new</span> Timer(2000, <span class="keyword">new</span> ActionListener() {
<a name="l00849"></a>00849             @Override
<a name="l00850"></a>00850             <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l00851"></a>00851                 resetBuffer();
<a name="l00852"></a>00852             }
<a name="l00853"></a>00853         });
<a name="l00854"></a>00854 
<a name="l00855"></a>00855         @Override
<a name="l00856"></a>00856         <span class="keyword">public</span> <span class="keywordtype">void</span> keyPressed(KeyEvent evt) {
<a name="l00857"></a>00857             <span class="keywordflow">if</span> (evt.getKeyCode() == KeyEvent.VK_DELETE) {
<a name="l00858"></a>00858                 deleteAction();
<a name="l00859"></a>00859             }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861             <span class="comment">// F2 as rename shortcut</span>
<a name="l00862"></a>00862             <span class="keywordflow">if</span> (evt.getKeyCode() == KeyEvent.VK_F2) {
<a name="l00863"></a>00863                 <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_node.html">DirectoryNode</a> node = (<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_node.html">DirectoryNode</a>) tree.getLastSelectedPathComponent();
<a name="l00864"></a>00864                 <span class="keywordflow">if</span> (node != null) {
<a name="l00865"></a>00865                     applyEdit(node);
<a name="l00866"></a>00866                 }
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869             <span class="keywordflow">if</span> (isCharForSearch(evt)) {
<a name="l00870"></a>00870                 evt.consume();
<a name="l00871"></a>00871             } <span class="keywordflow">else</span> {
<a name="l00872"></a>00872                 resetBuffer();
<a name="l00873"></a>00873             }
<a name="l00874"></a>00874 
<a name="l00875"></a>00875             <span class="comment">// #105527: keyboard invocation of tree&#39;s popup menu</span>
<a name="l00876"></a>00876             <span class="keywordflow">if</span> ((evt.getKeyCode() == KeyEvent.VK_F10) &amp;&amp; evt.isShiftDown() &amp;&amp; !popupMenu.isShowing()) {
<a name="l00877"></a>00877                 JTree tree = (JTree) evt.getSource();
<a name="l00878"></a>00878                 <span class="keywordtype">int</span> selRow = tree.getLeadSelectionRow();
<a name="l00879"></a>00879                 <span class="keywordflow">if</span> (selRow &gt;= 0) {
<a name="l00880"></a>00880                     Rectangle bounds = tree.getRowBounds(selRow);
<a name="l00881"></a>00881                     popupMenu.show(tree, bounds.x + bounds.width / 2, bounds.y + bounds.height * 3 / 5);
<a name="l00882"></a>00882                     evt.consume();
<a name="l00883"></a>00883                 }
<a name="l00884"></a>00884             }
<a name="l00885"></a>00885         }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887         @Override
<a name="l00888"></a>00888         <span class="keyword">public</span> <span class="keywordtype">void</span> keyTyped(KeyEvent evt) {
<a name="l00889"></a>00889             <span class="keywordtype">char</span> keyChar = evt.getKeyChar();
<a name="l00890"></a>00890             <span class="keywordflow">if</span> (isCharForSearch(evt)) {
<a name="l00891"></a>00891                 <span class="keywordflow">if</span> (paths == null) {
<a name="l00892"></a>00892                     paths = getVisiblePaths();
<a name="l00893"></a>00893                 }
<a name="l00894"></a>00894                 searchBuf.append(keyChar);
<a name="l00895"></a>00895                 resetBufferTimer.restart();
<a name="l00896"></a>00896                 TreePath activePath = tree.getSelectionPath();
<a name="l00897"></a>00897                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; ++i) {
<a name="l00898"></a>00898                     String searchedText = searchBuf.toString().toLowerCase();
<a name="l00899"></a>00899                     String curFileName = null;
<a name="l00900"></a>00900                     <span class="keywordflow">if</span> (i == 0 &amp;&amp; activePath != null
<a name="l00901"></a>00901                             &amp;&amp; (curFileName = fileChooser.getName(((<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_node.html">DirectoryNode</a>) activePath.getLastPathComponent()).getFile())) != null
<a name="l00902"></a>00902                             &amp;&amp; curFileName.toLowerCase().startsWith(searchedText)) {
<a name="l00903"></a>00903                         <span class="comment">// keep selection</span>
<a name="l00904"></a>00904                         <span class="keywordflow">return</span>;
<a name="l00905"></a>00905                     }
<a name="l00906"></a>00906                     <span class="keywordflow">for</span> (TreePath path : paths) {
<a name="l00907"></a>00907                         curFileName = fileChooser.getName(((<a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_node.html">DirectoryNode</a>) path.getLastPathComponent()).getFile());
<a name="l00908"></a>00908                         <span class="keywordflow">if</span> (curFileName != null &amp;&amp; curFileName.toLowerCase().startsWith(searchedText)) {
<a name="l00909"></a>00909                             tree.makeVisible(path);
<a name="l00910"></a>00910                             tree.scrollPathToVisible(path);
<a name="l00911"></a>00911                             tree.setSelectionPath(path);
<a name="l00912"></a>00912                             <span class="keywordflow">return</span>;
<a name="l00913"></a>00913                         }
<a name="l00914"></a>00914                     }
<a name="l00915"></a>00915                     searchBuf.delete(0, searchBuf.length() - 1);
<a name="l00916"></a>00916                 }
<a name="l00917"></a>00917             } <span class="keywordflow">else</span> {
<a name="l00918"></a>00918                 resetBuffer();
<a name="l00919"></a>00919             }
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922         @Override
<a name="l00923"></a>00923         <span class="keyword">public</span> <span class="keywordtype">void</span> focusGained(FocusEvent e) {
<a name="l00924"></a>00924             resetBuffer();
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927         @Override
<a name="l00928"></a>00928         <span class="keyword">public</span> <span class="keywordtype">void</span> focusLost(FocusEvent e) {
<a name="l00929"></a>00929             resetBuffer();
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932         <span class="keyword">private</span> <span class="keywordtype">boolean</span> isCharForSearch(KeyEvent evt) {
<a name="l00933"></a>00933             <span class="keywordtype">char</span> ch = evt.getKeyChar();
<a name="l00934"></a>00934             <span class="comment">// refuse backspace key</span>
<a name="l00935"></a>00935             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) ch == 8) {
<a name="l00936"></a>00936                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00937"></a>00937             }
<a name="l00938"></a>00938             <span class="comment">// #110975: refuse modifiers</span>
<a name="l00939"></a>00939             <span class="keywordflow">if</span> (evt.getModifiers() != 0) {
<a name="l00940"></a>00940                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00941"></a>00941             }
<a name="l00942"></a>00942             <span class="keywordflow">return</span> (Character.isJavaIdentifierPart(ch) &amp;&amp; !Character.isIdentifierIgnorable(ch)) || Character.isSpaceChar(ch);
<a name="l00943"></a>00943         }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945         <span class="keyword">private</span> <span class="keywordtype">void</span> resetBuffer() {
<a name="l00946"></a>00946             searchBuf.delete(0, searchBuf.length());
<a name="l00947"></a>00947             paths = null;
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     <span class="keyword">private</span> java.util.List&lt;TreePath&gt; getVisiblePaths() {
<a name="l00953"></a>00953         <span class="keywordtype">int</span> rowCount = tree.getRowCount();
<a name="l00954"></a>00954         java.util.List&lt;TreePath&gt; result = <span class="keyword">new</span> ArrayList&lt;TreePath&gt;(rowCount);
<a name="l00955"></a>00955         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; rowCount; i++) {
<a name="l00956"></a>00956             result.add(tree.getPathForRow(i));
<a name="l00957"></a>00957         }
<a name="l00958"></a>00958         <span class="keywordflow">return</span> result;
<a name="l00959"></a>00959     }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961     <span class="keyword">private</span> <span class="keywordtype">void</span> createPopup() {
<a name="l00962"></a>00962         popupMenu = <span class="keyword">new</span> JPopupMenu();
<a name="l00963"></a>00963         JMenuItem item1 = <span class="keyword">new</span> JMenuItem(getBundle().getString(<span class="stringliteral">&quot;LBL_NewFolder&quot;</span>));
<a name="l00964"></a>00964         item1.addActionListener(newFolderAction);
<a name="l00965"></a>00965 
<a name="l00966"></a>00966         JMenuItem item2 = <span class="keyword">new</span> JMenuItem(getBundle().getString(<span class="stringliteral">&quot;LBL_Rename&quot;</span>));
<a name="l00967"></a>00967         item2.addActionListener(<span class="keyword">new</span> ActionListener() {
<a name="l00968"></a>00968             @Override
<a name="l00969"></a>00969             <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l00970"></a>00970                 DirectoryNode node = (DirectoryNode) tree.getLastSelectedPathComponent();
<a name="l00971"></a>00971                 applyEdit(node);
<a name="l00972"></a>00972             }
<a name="l00973"></a>00973         });
<a name="l00974"></a>00974 
<a name="l00975"></a>00975         JMenuItem item3 = <span class="keyword">new</span> JMenuItem(getBundle().getString(<span class="stringliteral">&quot;LBL_Delete&quot;</span>));
<a name="l00976"></a>00976         item3.addActionListener(<span class="keyword">new</span> ActionListener() {
<a name="l00977"></a>00977             @Override
<a name="l00978"></a>00978             <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l00979"></a>00979                 deleteAction();
<a name="l00980"></a>00980             }
<a name="l00981"></a>00981         });
<a name="l00982"></a>00982 
<a name="l00983"></a>00983         popupMenu.add(item1);
<a name="l00984"></a>00984         popupMenu.add(item2);
<a name="l00985"></a>00985         popupMenu.add(item3);
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     <span class="comment">// remove multiple directories</span>
<a name="l00989"></a>00989     <span class="keyword">private</span> <span class="keywordtype">void</span> deleteAction() {
<a name="l00990"></a>00990         <span class="comment">// fixed #97079 to be able to delete one or more folders</span>
<a name="l00991"></a>00991         <span class="keyword">final</span> TreePath[] nodePath = tree.getSelectionPaths();
<a name="l00992"></a>00992 
<a name="l00993"></a>00993         <span class="keywordflow">if</span> (nodePath == null) {
<a name="l00994"></a>00994             <span class="keywordflow">return</span>;
<a name="l00995"></a>00995         }
<a name="l00996"></a>00996         String message = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998         <span class="keywordflow">if</span> (nodePath.length == 1) {
<a name="l00999"></a>00999 
<a name="l01000"></a>01000             File file = ((DirectoryNode) nodePath[0].getLastPathComponent()).getFile();
<a name="l01001"></a>01001             <span class="comment">// Don&#39;t do anything if it&#39;s a special file</span>
<a name="l01002"></a>01002             <span class="keywordflow">if</span> (!canWrite(file)) {
<a name="l01003"></a>01003                 <span class="keywordflow">return</span>;
<a name="l01004"></a>01004             }
<a name="l01005"></a>01005             message = MessageFormat.format(getBundle().getString(<span class="stringliteral">&quot;MSG_Delete&quot;</span>), file.getName());
<a name="l01006"></a>01006         } <span class="keywordflow">else</span> {
<a name="l01007"></a>01007             message = MessageFormat.format(getBundle().getString(<span class="stringliteral">&quot;MSG_Delete_Multiple&quot;</span>), nodePath.length);
<a name="l01008"></a>01008         }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         <span class="keywordtype">int</span> answer = JOptionPane.showConfirmDialog(fileChooser, message, getBundle().getString(<span class="stringliteral">&quot;MSG_Confirm&quot;</span>), JOptionPane.YES_NO_OPTION);
<a name="l01011"></a>01011 
<a name="l01012"></a>01012         <span class="keywordflow">if</span> (answer == JOptionPane.YES_OPTION) {
<a name="l01013"></a>01013 
<a name="l01014"></a>01014             RequestProcessor.getDefault().post(<span class="keyword">new</span> Runnable() {
<a name="l01015"></a>01015                 ArrayList&lt;File&gt; list = <span class="keyword">new</span> ArrayList&lt;File&gt;();
<a name="l01016"></a>01016                 <span class="keywordtype">int</span> cannotDelete;
<a name="l01017"></a>01017                 ArrayList&lt;DirectoryNode&gt; nodes2Remove = <span class="keyword">new</span> ArrayList&lt;DirectoryNode&gt;(nodePath.length);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019                 @Override
<a name="l01020"></a>01020                 <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01021"></a>01021                     <span class="keywordflow">if</span> (!EventQueue.isDispatchThread()) {
<a name="l01022"></a>01022                         <span class="comment">// first pass, out of EQ thread, deletes files</span>
<a name="l01023"></a>01023                         setCursor(fileChooser, Cursor.WAIT_CURSOR);
<a name="l01024"></a>01024                         cannotDelete = 0;
<a name="l01025"></a>01025                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nodePath.length; i++) {
<a name="l01026"></a>01026                             DirectoryNode nodeToDelete = (DirectoryNode) nodePath[i].getLastPathComponent();
<a name="l01027"></a>01027                             <span class="keywordflow">try</span> {
<a name="l01028"></a>01028                                 <span class="keyword">delete</span>(nodeToDelete.getFile());
<a name="l01029"></a>01029                                 nodes2Remove.add(nodeToDelete);
<a name="l01030"></a>01030                             } <span class="keywordflow">catch</span> (IOException ignore) {
<a name="l01031"></a>01031                                 cannotDelete++;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033                                 <span class="keywordflow">if</span> (canWrite(nodeToDelete.getFile())) {
<a name="l01034"></a>01034                                     list.add(nodeToDelete.getFile());
<a name="l01035"></a>01035                                 }
<a name="l01036"></a>01036                             }
<a name="l01037"></a>01037                         }
<a name="l01038"></a>01038                         <span class="comment">// send to second pass</span>
<a name="l01039"></a>01039                         EventQueue.invokeLater(<span class="keyword">this</span>);
<a name="l01040"></a>01040                     } <span class="keywordflow">else</span> {
<a name="l01041"></a>01041                         <span class="comment">// second pass, in EQ thread</span>
<a name="l01042"></a>01042                         <span class="keywordflow">for</span> (DirectoryNode curNode : nodes2Remove) {
<a name="l01043"></a>01043                             model.removeNodeFromParent(curNode);
<a name="l01044"></a>01044                         }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046                         setCursor(fileChooser, Cursor.DEFAULT_CURSOR);
<a name="l01047"></a>01047                         <span class="keywordflow">if</span> (cannotDelete &gt; 0) {
<a name="l01048"></a>01048                             String message = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050                             <span class="keywordflow">if</span> (cannotDelete == 1) {
<a name="l01051"></a>01051                                 message = cannotDelete + <span class="stringliteral">&quot; &quot;</span> + getBundle().getString(<span class="stringliteral">&quot;MSG_Sing_Delete&quot;</span>);
<a name="l01052"></a>01052                             } <span class="keywordflow">else</span> {
<a name="l01053"></a>01053                                 message = cannotDelete + <span class="stringliteral">&quot; &quot;</span> + getBundle().getString(<span class="stringliteral">&quot;MSG_Plur_Delete&quot;</span>);
<a name="l01054"></a>01054                             }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056                             setSelected((File[]) list.toArray(<span class="keyword">new</span> File[list.size()]));
<a name="l01057"></a>01057 
<a name="l01058"></a>01058                             JOptionPane.showConfirmDialog(fileChooser, message, getBundle().getString(<span class="stringliteral">&quot;MSG_Confirm&quot;</span>), JOptionPane.OK_OPTION);
<a name="l01059"></a>01059                         } <span class="keywordflow">else</span> {
<a name="l01060"></a>01060                             setSelected(<span class="keyword">new</span> File[] { null });
<a name="l01061"></a>01061                             setFileName(<span class="stringliteral">&quot;&quot;</span>);
<a name="l01062"></a>01062                         }
<a name="l01063"></a>01063                     }
<a name="l01064"></a>01064                 }
<a name="l01065"></a>01065             });
<a name="l01066"></a>01066         }
<a name="l01067"></a>01067     }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     <span class="keyword">private</span> <span class="keywordtype">void</span> <span class="keyword">delete</span>(File file) <span class="keywordflow">throws</span> IOException {
<a name="l01070"></a>01070         <span class="keywordflow">if</span> (!file.delete()) {
<a name="l01071"></a>01071             <span class="keywordflow">throw</span> <span class="keyword">new</span> IOException();
<a name="l01072"></a>01072         }
<a name="l01073"></a>01073     }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075     <span class="keyword">private</span> File lastDir;
<a name="l01076"></a>01076     <span class="keyword">private</span> File[] lastChildren;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     <span class="keyword">private</span> <span class="keywordtype">void</span> updateCompletions() {
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (showPopupCompletion) {
<a name="l01080"></a>01080             <span class="keyword">final</span> String name = normalizeFile(getFileName());
<a name="l01081"></a>01081             <span class="keywordtype">int</span> slash = name.lastIndexOf(File.separatorChar);
<a name="l01082"></a>01082             <span class="keywordflow">if</span> (slash != -1) {
<a name="l01083"></a>01083                 String prefix = name.substring(0, slash + 1);
<a name="l01084"></a>01084                 File dir = getFileChooser().getFileSystemView().createFileObject(prefix);
<a name="l01085"></a>01085                 File[] children;
<a name="l01086"></a>01086                 <span class="keyword">synchronized</span> (listFilesWorker) {
<a name="l01087"></a>01087                     <span class="keywordflow">if</span> (!dir.equals(lastDir)) {
<a name="l01088"></a>01088                         <span class="keywordflow">if</span> (completionPopup != null) {
<a name="l01089"></a>01089                             completionPopup.setDataList(<span class="keyword">new</span> Vector&lt;File&gt;(0));
<a name="l01090"></a>01090                             completionPopup.detach();
<a name="l01091"></a>01091                             completionPopup = null;
<a name="l01092"></a>01092                         }
<a name="l01093"></a>01093                         listFilesWorker.d = dir;
<a name="l01094"></a>01094                         listFilesTask.schedule(0);
<a name="l01095"></a>01095                         <span class="keywordflow">return</span>;
<a name="l01096"></a>01096                     } <span class="keywordflow">else</span> {
<a name="l01097"></a>01097                         children = lastChildren;
<a name="l01098"></a>01098                     }
<a name="l01099"></a>01099                 }
<a name="l01100"></a>01100                 <span class="keywordflow">if</span> (children != null) {
<a name="l01101"></a>01101                     Vector&lt;File&gt; list = buildList(name, children, 20);
<a name="l01102"></a>01102                     <span class="keywordflow">if</span> (completionPopup == null) {
<a name="l01103"></a>01103                         completionPopup = <span class="keyword">new</span> FileCompletionPopup(fileChooser, filenameTextField, list);
<a name="l01104"></a>01104                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (completionPopup.isShowing() || (showPopupCompletion &amp;&amp; fileChooser.isShowing())) {
<a name="l01105"></a>01105                         completionPopup.setDataList(list);
<a name="l01106"></a>01106                     }
<a name="l01107"></a>01107                     <span class="keywordflow">if</span> (fileChooser.isShowing() &amp;&amp; !completionPopup.isShowing()) {
<a name="l01108"></a>01108                         java.awt.Point los = filenameTextField.getLocation();
<a name="l01109"></a>01109                         <span class="keywordtype">int</span> popX = los.x;
<a name="l01110"></a>01110                         <span class="keywordtype">int</span> popY = los.y + filenameTextField.getHeight() - 6;
<a name="l01111"></a>01111                         completionPopup.showPopup(filenameTextField, popX, popY);
<a name="l01112"></a>01112                     }
<a name="l01113"></a>01113                 }
<a name="l01114"></a>01114             }
<a name="l01115"></a>01115         }
<a name="l01116"></a>01116     }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118     <span class="keyword">private</span> <span class="keyword">class </span>ListFilesWorker <span class="keyword">implements</span> Runnable {
<a name="l01119"></a>01119         <span class="keyword">private</span> File d;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121         @Override
<a name="l01122"></a>01122         <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01123"></a>01123             File dir;
<a name="l01124"></a>01124             <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {
<a name="l01125"></a>01125                 dir = d;
<a name="l01126"></a>01126             }
<a name="l01127"></a>01127             List&lt;File&gt; files = <span class="keyword">new</span> LinkedList&lt;File&gt;();
<a name="l01128"></a>01128             File[] children = dir.listFiles();
<a name="l01129"></a>01129             <span class="keywordflow">if</span> (children != null) {
<a name="l01130"></a>01130                 <span class="keywordflow">for</span> (File f : children) {
<a name="l01131"></a>01131                     <span class="keywordflow">if</span> (fileChooser.accept(f)) {
<a name="l01132"></a>01132                         <span class="keywordflow">if</span> (fileChooser.getFileSelectionMode() == JFileChooser.DIRECTORIES_ONLY) {
<a name="l01133"></a>01133                             <span class="keywordflow">if</span> (f.isDirectory()) {
<a name="l01134"></a>01134                                 files.add(f);
<a name="l01135"></a>01135                             }
<a name="l01136"></a>01136                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileChooser.getFileSelectionMode() == JFileChooser.FILES_ONLY) {
<a name="l01137"></a>01137                             <span class="keywordflow">if</span> (f.isFile()) {
<a name="l01138"></a>01138                                 files.add(f);
<a name="l01139"></a>01139                             }
<a name="l01140"></a>01140                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileChooser.getFileSelectionMode() == JFileChooser.FILES_AND_DIRECTORIES) {
<a name="l01141"></a>01141                             files.add(f);
<a name="l01142"></a>01142                         }
<a name="l01143"></a>01143                     }
<a name="l01144"></a>01144                 }
<a name="l01145"></a>01145             }
<a name="l01146"></a>01146             <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {
<a name="l01147"></a>01147                 lastDir = dir;
<a name="l01148"></a>01148                 lastChildren = files.toArray(<span class="keyword">new</span> File[files.size()]);
<a name="l01149"></a>01149             }
<a name="l01150"></a>01150             <span class="keywordflow">if</span> (lastChildren.length &gt; 0) {
<a name="l01151"></a>01151                 EventQueue.invokeLater(<span class="keyword">new</span> Runnable() {
<a name="l01152"></a>01152                     @Override
<a name="l01153"></a>01153                     <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01154"></a>01154                         updateCompletions();
<a name="l01155"></a>01155                     }
<a name="l01156"></a>01156                 });
<a name="l01157"></a>01157             }
<a name="l01158"></a>01158         }
<a name="l01159"></a>01159     }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     <span class="keyword">public</span> Vector&lt;File&gt; buildList(String text, File[] children, <span class="keywordtype">int</span> max) {
<a name="l01162"></a>01162         Vector&lt;File&gt; files = <span class="keyword">new</span> Vector&lt;File&gt;(children.length);
<a name="l01163"></a>01163         Arrays.sort(children, DirectoryNode.FILE_NAME_COMPARATOR);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165         <span class="keywordflow">for</span> (File completion : children) {
<a name="l01166"></a>01166             String path = completion.getAbsolutePath();
<a name="l01167"></a>01167             <span class="keywordflow">if</span> (path.regionMatches(<span class="keyword">true</span>, 0, text, 0, text.length())) {
<a name="l01168"></a>01168                 files.add(completion);
<a name="l01169"></a>01169             }
<a name="l01170"></a>01170             <span class="keywordflow">if</span> (files.size() &gt;= max) {
<a name="l01171"></a>01171                 <span class="keywordflow">break</span>;
<a name="l01172"></a>01172             }
<a name="l01173"></a>01173         }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175         <span class="keywordflow">return</span> files;
<a name="l01176"></a>01176     }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <span class="keyword">private</span> <span class="keyword">static</span> String normalizeFile(String text) {
<a name="l01179"></a>01179         <span class="comment">// See #21690 for background.</span>
<a name="l01180"></a>01180         <span class="comment">// XX X what are legal chars for var names? bash manual says only:</span>
<a name="l01181"></a>01181         <span class="comment">// &quot;The braces are required when PARAMETER [...] is followed by a</span>
<a name="l01182"></a>01182         <span class="comment">// character that is not to be interpreted as part of its name.&quot;</span>
<a name="l01183"></a>01183         Pattern p = Pattern.compile(<span class="stringliteral">&quot;(^|[^\\\\])\\$([a-zA-Z_0-9.]+)&quot;</span>);
<a name="l01184"></a>01184         Matcher m;
<a name="l01185"></a>01185         <span class="keywordflow">while</span> ((m = p.matcher(text)).find()) {
<a name="l01186"></a>01186             <span class="comment">// Have an env var to subst...</span>
<a name="l01187"></a>01187             <span class="comment">// XX X handle ${PATH} too? or don&#39;t bother</span>
<a name="l01188"></a>01188             String var = System.getenv(m.group(2));
<a name="l01189"></a>01189             <span class="keywordflow">if</span> (var == null) {
<a name="l01190"></a>01190                 <span class="comment">// Try Java system props too, and fall back to &quot;&quot;.</span>
<a name="l01191"></a>01191                 var = System.getProperty(m.group(2), <span class="stringliteral">&quot;&quot;</span>);
<a name="l01192"></a>01192             }
<a name="l01193"></a>01193             <span class="comment">// XX X full readline compat would mean vars were also completed with</span>
<a name="l01194"></a>01194             <span class="comment">// TAB...</span>
<a name="l01195"></a>01195             text = text.substring(0, m.end(1)) + var + text.substring(m.end(2));
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197         <span class="keywordflow">if</span> (text.equals(<span class="stringliteral">&quot;~&quot;</span>)) {
<a name="l01198"></a>01198             <span class="keywordflow">return</span> System.getProperty(<span class="stringliteral">&quot;user.home&quot;</span>);
<a name="l01199"></a>01199         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text.startsWith(<span class="stringliteral">&quot;~&quot;</span> + File.separatorChar)) {
<a name="l01200"></a>01200             <span class="keywordflow">return</span> System.getProperty(<span class="stringliteral">&quot;user.home&quot;</span>) + text.substring(1);
<a name="l01201"></a>01201         } <span class="keywordflow">else</span> {
<a name="l01202"></a>01202             <span class="keywordtype">int</span> i = text.lastIndexOf(<span class="stringliteral">&quot;//&quot;</span>);
<a name="l01203"></a>01203             <span class="keywordflow">if</span> (i != -1) {
<a name="l01204"></a>01204                 <span class="comment">// Treat /home/me//usr/local as /usr/local</span>
<a name="l01205"></a>01205                 <span class="comment">// (so that you can use &quot;//&quot; to start a new path, without</span>
<a name="l01206"></a>01206                 <span class="comment">// selecting &amp; deleting)</span>
<a name="l01207"></a>01207                 <span class="keywordflow">return</span> text.substring(i + 1);
<a name="l01208"></a>01208             }
<a name="l01209"></a>01209             i = text.lastIndexOf(File.separatorChar + <span class="stringliteral">&quot;~&quot;</span> + File.separatorChar);
<a name="l01210"></a>01210             <span class="keywordflow">if</span> (i != -1) {
<a name="l01211"></a>01211                 <span class="comment">// Treat /usr/local/~/stuff as /home/me/stuff</span>
<a name="l01212"></a>01212                 <span class="keywordflow">return</span> System.getProperty(<span class="stringliteral">&quot;user.home&quot;</span>) + text.substring(i + 2);
<a name="l01213"></a>01213             }
<a name="l01214"></a>01214             <span class="keywordflow">return</span> text;
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="keyword">private</span> <span class="keyword">static</span> ResourceBundle bundle = null;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220     <span class="keyword">private</span> <span class="keyword">static</span> ResourceBundle getBundle() {
<a name="l01221"></a>01221         <span class="keywordflow">if</span> (bundle == null) {
<a name="l01222"></a>01222             bundle = ResourceBundle.getBundle(<span class="stringliteral">&quot;Bundle&quot;</span>);
<a name="l01223"></a>01223         }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225         <span class="keywordflow">return</span> bundle;
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     @Override
<a name="l01229"></a>01229     <span class="keyword">public</span> <span class="keywordtype">void</span> rescanCurrentDirectory(JFileChooser fc) {
<a name="l01230"></a>01230         super.rescanCurrentDirectory(fc);
<a name="l01231"></a>01231         File curDir = fc.getCurrentDirectory();
<a name="l01232"></a>01232         <span class="keywordflow">if</span> (curDir == null) {
<a name="l01233"></a>01233             curDir = fc.getFileSystemView().getRoots()[0];
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235         updateWorker.updateTree(curDir);
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <span class="keyword">private</span> <span class="keywordtype">void</span> initUpdateWorker() {
<a name="l01239"></a>01239         updateWorker.attachFileChooser(<span class="keyword">this</span>);
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="keyword">private</span> <span class="keywordtype">void</span> markStartTime() {
<a name="l01243"></a>01243         <span class="keywordflow">if</span> (fileChooser.getClientProperty(DelegatingChooserUI.START_TIME) == null) {
<a name="l01244"></a>01244             fileChooser.putClientProperty(DelegatingChooserUI.START_TIME, Long.valueOf(System.currentTimeMillis()));
<a name="l01245"></a>01245         }
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     <span class="keyword">private</span> <span class="keywordtype">void</span> checkUpdate() {
<a name="l01249"></a>01249         <span class="keywordflow">if</span> (OS.isWindows() &amp;&amp; useShellFolder) {
<a name="l01250"></a>01250             Long startTime = (Long) fileChooser.getClientProperty(DelegatingChooserUI.START_TIME);
<a name="l01251"></a>01251             <span class="keywordflow">if</span> (startTime == null) {
<a name="l01252"></a>01252                 <span class="keywordflow">return</span>;
<a name="l01253"></a>01253             }
<a name="l01254"></a>01254             <span class="comment">// clean for future marking</span>
<a name="l01255"></a>01255             fileChooser.putClientProperty(DelegatingChooserUI.START_TIME, null);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257             <span class="keywordtype">long</span> elapsed = System.currentTimeMillis() - startTime.longValue();
<a name="l01258"></a>01258             <span class="keywordtype">long</span> timeOut = 10000;
<a name="l01259"></a>01259             <span class="keywordflow">if</span> (timeOut &gt; 0 &amp;&amp; elapsed &gt; timeOut &amp;&amp; slownessPanel == null) {
<a name="l01260"></a>01260                 JLabel slownessNote = <span class="keyword">new</span> JLabel(getBundle().getString(<span class="stringliteral">&quot;MSG_SlownessNote&quot;</span>));
<a name="l01261"></a>01261                 slownessNote.setForeground(Color.RED);
<a name="l01262"></a>01262                 slownessPanel = <span class="keyword">new</span> JPanel();
<a name="l01263"></a>01263                 JButton notShow = <span class="keyword">new</span> JButton(getBundle().getString(<span class="stringliteral">&quot;BTN_NotShow&quot;</span>));
<a name="l01264"></a>01264                 notShow.addActionListener(<span class="keyword">new</span> ActionListener() {
<a name="l01265"></a>01265                     @Override
<a name="l01266"></a>01266                     <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l01267"></a>01267                         centerPanel.remove(slownessPanel);
<a name="l01268"></a>01268                         centerPanel.revalidate();
<a name="l01269"></a>01269                     }
<a name="l01270"></a>01270                 });
<a name="l01271"></a>01271                 JPanel notShowP = <span class="keyword">new</span> JPanel();
<a name="l01272"></a>01272                 notShowP.add(notShow);
<a name="l01273"></a>01273                 slownessPanel.setLayout(<span class="keyword">new</span> BorderLayout());
<a name="l01274"></a>01274                 slownessPanel.setBorder(BorderFactory.createEmptyBorder(5, 0, 5, 0));
<a name="l01275"></a>01275                 slownessPanel.add(slownessNote, BorderLayout.CENTER);
<a name="l01276"></a>01276                 slownessPanel.add(notShowP, BorderLayout.SOUTH);
<a name="l01277"></a>01277                 centerPanel.add(slownessPanel, BorderLayout.NORTH);
<a name="l01278"></a>01278                 centerPanel.revalidate();
<a name="l01279"></a>01279             }
<a name="l01280"></a>01280         }
<a name="l01281"></a>01281     }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="keyword">private</span> Boolean isXPStyle() {
<a name="l01284"></a>01284         Toolkit toolkit = Toolkit.getDefaultToolkit();
<a name="l01285"></a>01285         Boolean themeActive = (Boolean) toolkit.getDesktopProperty(<span class="stringliteral">&quot;win.xpstyle.themeActive&quot;</span>);
<a name="l01286"></a>01286         <span class="keywordflow">if</span> (themeActive == null)
<a name="l01287"></a>01287             themeActive = Boolean.FALSE;
<a name="l01288"></a>01288         <span class="keywordflow">if</span> (themeActive.booleanValue() &amp;&amp; System.getProperty(<span class="stringliteral">&quot;swing.noxp&quot;</span>) == null) {
<a name="l01289"></a>01289             themeActive = Boolean.TRUE;
<a name="l01290"></a>01290         }
<a name="l01291"></a>01291         <span class="keywordflow">return</span> themeActive;
<a name="l01292"></a>01292     }
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     @Override
<a name="l01295"></a>01295     <span class="keyword">protected</span> <span class="keywordtype">void</span> installStrings(JFileChooser fc) {
<a name="l01296"></a>01296         super.installStrings(fc);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298         Locale l = fc.getLocale();
<a name="l01299"></a>01299 
<a name="l01300"></a>01300         lookInLabelMnemonic = UIManager.getInt(<span class="stringliteral">&quot;FileChooser.lookInLabelMnemonic&quot;</span>);
<a name="l01301"></a>01301         lookInLabelText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.lookInLabelText&quot;</span>, l);
<a name="l01302"></a>01302         saveInLabelText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.saveInLabelText&quot;</span>, l);
<a name="l01303"></a>01303 
<a name="l01304"></a>01304         fileNameLabelMnemonic = UIManager.getInt(<span class="stringliteral">&quot;FileChooser.fileNameLabelMnemonic&quot;</span>);
<a name="l01305"></a>01305         fileNameLabelText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.fileNameLabelText&quot;</span>, l);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         filesOfTypeLabelMnemonic = UIManager.getInt(<span class="stringliteral">&quot;FileChooser.filesOfTypeLabelMnemonic&quot;</span>);
<a name="l01308"></a>01308         filesOfTypeLabelText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.filesOfTypeLabelText&quot;</span>, l);
<a name="l01309"></a>01309 
<a name="l01310"></a>01310         upFolderToolTipText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.upFolderToolTipText&quot;</span>, l);
<a name="l01311"></a>01311         <span class="keywordflow">if</span> (null == upFolderToolTipText)
<a name="l01312"></a>01312             upFolderToolTipText = getBundle().getString(<span class="stringliteral">&quot;TLTP_UpFolder&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01313"></a>01313         upFolderAccessibleName = UIManager.getString(<span class="stringliteral">&quot;FileChooser.upFolderAccessibleName&quot;</span>, l);
<a name="l01314"></a>01314         <span class="keywordflow">if</span> (null == upFolderAccessibleName)
<a name="l01315"></a>01315             upFolderAccessibleName = getBundle().getString(<span class="stringliteral">&quot;ACN_UpFolder&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01316"></a>01316 
<a name="l01317"></a>01317         newFolderToolTipText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.newFolderToolTipText&quot;</span>, l);
<a name="l01318"></a>01318         <span class="keywordflow">if</span> (null == newFolderToolTipText)
<a name="l01319"></a>01319             newFolderToolTipText = getBundle().getString(<span class="stringliteral">&quot;TLTP_NewFolder&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01320"></a>01320         newFolderAccessibleName = getBundle().getString(<span class="stringliteral">&quot;ACN_NewFolder&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01321"></a>01321 
<a name="l01322"></a>01322         homeFolderTooltipText = UIManager.getString(<span class="stringliteral">&quot;FileChooser.homeFolderToolTipText&quot;</span>, l);
<a name="l01323"></a>01323         <span class="keywordflow">if</span> (null == homeFolderTooltipText)
<a name="l01324"></a>01324             homeFolderTooltipText = getBundle().getString(<span class="stringliteral">&quot;TLTP_HomeFolder&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01325"></a>01325         homeFolderAccessibleName = getBundle().getString(<span class="stringliteral">&quot;ACN_HomeFolder&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     @Override
<a name="l01330"></a>01330     <span class="keyword">protected</span> <span class="keywordtype">void</span> installListeners(JFileChooser fc) {
<a name="l01331"></a>01331         super.installListeners(fc);
<a name="l01332"></a>01332         ActionMap actionMap = getActionMap2();
<a name="l01333"></a>01333         SwingUtilities.replaceUIActionMap(fc, actionMap);
<a name="l01334"></a>01334     }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     <span class="keyword">protected</span> ActionMap getActionMap2() {
<a name="l01337"></a>01337         <span class="keywordflow">return</span> createActionMap2();
<a name="l01338"></a>01338     }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     <span class="keyword">protected</span> ActionMap createActionMap2() {
<a name="l01341"></a>01341         AbstractAction escAction = <span class="keyword">new</span> AbstractAction() {
<a name="l01342"></a>01342             <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01343"></a>01343 
<a name="l01344"></a>01344             @Override
<a name="l01345"></a>01345             <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l01346"></a>01346                 getFileChooser().cancelSelection();
<a name="l01347"></a>01347             }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349             @Override
<a name="l01350"></a>01350             <span class="keyword">public</span> <span class="keywordtype">boolean</span> isEnabled() {
<a name="l01351"></a>01351                 <span class="keywordflow">return</span> getFileChooser().isEnabled();
<a name="l01352"></a>01352             }
<a name="l01353"></a>01353         };
<a name="l01354"></a>01354         ActionMap map = <span class="keyword">new</span> ActionMapUIResource();
<a name="l01355"></a>01355         map.put(<span class="stringliteral">&quot;approveSelection&quot;</span>, getApproveSelectionAction());
<a name="l01356"></a>01356         map.put(<span class="stringliteral">&quot;cancelSelection&quot;</span>, escAction);
<a name="l01357"></a>01357         map.put(<span class="stringliteral">&quot;Go Up&quot;</span>, getChangeToParentDirectoryAction());
<a name="l01358"></a>01358         <span class="keywordflow">return</span> map;
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361     @Override
<a name="l01362"></a>01362     <span class="keyword">public</span> Action getNewFolderAction() {
<a name="l01363"></a>01363         <span class="keywordflow">return</span> newFolderAction;
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366     @Override
<a name="l01367"></a>01367     <span class="keyword">public</span> <span class="keywordtype">void</span> uninstallUI(JComponent c) {
<a name="l01368"></a>01368         c.removePropertyChangeListener(filterTypeComboBoxModel);
<a name="l01369"></a>01369         cancelButton.removeActionListener(getCancelSelectionAction());
<a name="l01370"></a>01370         approveButton.removeActionListener(getApproveSelectionAction());
<a name="l01371"></a>01371         filenameTextField.removeActionListener(getApproveSelectionAction());
<a name="l01372"></a>01372         super.uninstallUI(c);
<a name="l01373"></a>01373     }
<a name="l01374"></a>01374 
<a name="l01385"></a>01385     @Override
<a name="l01386"></a><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#ad5ad9317d4fd70004c4b6306b2077611">01386</a>     <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#ad5ad9317d4fd70004c4b6306b2077611">getPreferredSize</a>(JComponent c) {
<a name="l01387"></a>01387         <span class="keywordtype">int</span> prefWidth = PREF_SIZE.width;
<a name="l01388"></a>01388         Dimension d = c.getLayout().preferredLayoutSize(c);
<a name="l01389"></a>01389         <span class="keywordflow">if</span> (d != null) {
<a name="l01390"></a>01390             <span class="keywordflow">return</span> <span class="keyword">new</span> Dimension(d.width &lt; prefWidth ? prefWidth : d.width, d.height &lt; PREF_SIZE.height ? PREF_SIZE.height : d.height);
<a name="l01391"></a>01391         } <span class="keywordflow">else</span> {
<a name="l01392"></a>01392             <span class="keywordflow">return</span> <span class="keyword">new</span> Dimension(prefWidth, PREF_SIZE.height);
<a name="l01393"></a>01393         }
<a name="l01394"></a>01394     }
<a name="l01395"></a>01395 
<a name="l01404"></a>01404     @Override
<a name="l01405"></a><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a1995e6e2081d79f1d6e10cba0ff91c97">01405</a>     <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a1995e6e2081d79f1d6e10cba0ff91c97">getMinimumSize</a>(JComponent c) {
<a name="l01406"></a>01406         <span class="keywordflow">return</span> MIN_SIZE;
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408 
<a name="l01417"></a>01417     @Override
<a name="l01418"></a><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a4d66402cd668312068dbb25bd2fee1ec">01418</a>     <span class="keyword">public</span> Dimension <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i.html#a4d66402cd668312068dbb25bd2fee1ec">getMaximumSize</a>(JComponent c) {
<a name="l01419"></a>01419         <span class="keywordflow">return</span> <span class="keyword">new</span> Dimension(Integer.MAX_VALUE, Integer.MAX_VALUE);
<a name="l01420"></a>01420     }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <span class="keyword">private</span> String getStringOfFileName(File file) {
<a name="l01423"></a>01423         <span class="keywordflow">if</span> (file == null) {
<a name="l01424"></a>01424             <span class="keywordflow">return</span> null;
<a name="l01425"></a>01425         } <span class="keywordflow">else</span> {
<a name="l01426"></a>01426             JFileChooser fc = getFileChooser();
<a name="l01427"></a>01427             <span class="keywordflow">if</span> (fc.isDirectorySelectionEnabled() &amp;&amp; !fc.isFileSelectionEnabled()) {
<a name="l01428"></a>01428                 <span class="keywordflow">if</span> (fc.getFileSystemView().isDrive(file)) {
<a name="l01429"></a>01429                     <span class="keywordflow">return</span> file.getPath();
<a name="l01430"></a>01430                 } <span class="keywordflow">else</span> {
<a name="l01431"></a>01431                     <span class="keywordflow">return</span> file.getPath();
<a name="l01432"></a>01432                 }
<a name="l01433"></a>01433             } <span class="keywordflow">else</span> {
<a name="l01434"></a>01434                 <span class="keywordflow">return</span> file.getName();
<a name="l01435"></a>01435             }
<a name="l01436"></a>01436         }
<a name="l01437"></a>01437     }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="keyword">private</span> String getStringOfFileNames(File[] files) {
<a name="l01440"></a>01440         StringBuilder buf = <span class="keyword">new</span> StringBuilder();
<a name="l01441"></a>01441         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; files != null &amp;&amp; i &lt; files.length; i++) {
<a name="l01442"></a>01442             <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l01443"></a>01443                 buf.append(<span class="stringliteral">&quot; &quot;</span>);
<a name="l01444"></a>01444             }
<a name="l01445"></a>01445             <span class="keywordflow">if</span> (files.length &gt; 1) {
<a name="l01446"></a>01446                 buf.append(<span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l01447"></a>01447             }
<a name="l01448"></a>01448             buf.append(getStringOfFileName(files[i]));
<a name="l01449"></a>01449             <span class="keywordflow">if</span> (files.length &gt; 1) {
<a name="l01450"></a>01450                 buf.append(<span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l01451"></a>01451             }
<a name="l01452"></a>01452         }
<a name="l01453"></a>01453         <span class="keywordflow">return</span> buf.toString();
<a name="l01454"></a>01454     }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456     <span class="comment">/* The following methods are used by the PropertyChange Listener */</span>
<a name="l01457"></a>01457 
<a name="l01458"></a>01458     <span class="keyword">private</span> <span class="keywordtype">void</span> fireSelectedFileChanged(PropertyChangeEvent e) {
<a name="l01459"></a>01459         File f = (File) e.getNewValue();
<a name="l01460"></a>01460         JFileChooser fc = getFileChooser();
<a name="l01461"></a>01461         <span class="keywordflow">if</span> (f != null &amp;&amp; ((fc.isFileSelectionEnabled() &amp;&amp; !f.isDirectory()) || (f.isDirectory() &amp;&amp; fc.isDirectorySelectionEnabled()))) {
<a name="l01462"></a>01462 
<a name="l01463"></a>01463             setFileName(getStringOfFileName(f));
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465     }
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="keyword">private</span> <span class="keywordtype">void</span> fireSelectedFilesChanged(PropertyChangeEvent e) {
<a name="l01468"></a>01468         File[] files = (File[]) e.getNewValue();
<a name="l01469"></a>01469         JFileChooser fc = getFileChooser();
<a name="l01470"></a>01470         <span class="keywordflow">if</span> (files != null &amp;&amp; files.length &gt; 0 &amp;&amp; (files.length &gt; 1 || fc.isDirectorySelectionEnabled() || !files[0].isDirectory())) {
<a name="l01471"></a>01471             setFileName(getStringOfFileNames(files));
<a name="l01472"></a>01472         }
<a name="l01473"></a>01473     }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475     <span class="keyword">private</span> <span class="keywordtype">void</span> fireDirectoryChanged(PropertyChangeEvent e) {
<a name="l01476"></a>01476         JFileChooser fc = getFileChooser();
<a name="l01477"></a>01477         FileSystemView fsv = fc.getFileSystemView();
<a name="l01478"></a>01478         showPopupCompletion = <span class="keyword">false</span>;
<a name="l01479"></a>01479         setFileName(<span class="stringliteral">&quot;&quot;</span>);
<a name="l01480"></a>01480         clearIconCache();
<a name="l01481"></a>01481         File currentDirectory = fc.getCurrentDirectory();
<a name="l01482"></a>01482         <span class="keywordflow">if</span> (currentDirectory != null) {
<a name="l01483"></a>01483             directoryComboBoxModel.addItem(currentDirectory);
<a name="l01484"></a>01484             newFolderAction.setEnabled(currentDirectory.canWrite());
<a name="l01485"></a>01485             getChangeToParentDirectoryAction().setEnabled(!fsv.isRoot(currentDirectory));
<a name="l01486"></a>01486             updateWorker.updateTree(currentDirectory);
<a name="l01487"></a>01487             <span class="keywordflow">if</span> (fc.isDirectorySelectionEnabled() &amp;&amp; !fc.isFileSelectionEnabled()) {
<a name="l01488"></a>01488                 <span class="keywordflow">if</span> (fsv.isFileSystem(currentDirectory)) {
<a name="l01489"></a>01489                     setFileName(getStringOfFileName(currentDirectory));
<a name="l01490"></a>01490                 } <span class="keywordflow">else</span> {
<a name="l01491"></a>01491                     setFileName(null);
<a name="l01492"></a>01492                 }
<a name="l01493"></a>01493             }
<a name="l01494"></a>01494         }
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     <span class="keyword">private</span> <span class="keywordtype">void</span> fireFilterChanged(PropertyChangeEvent e) {
<a name="l01498"></a>01498         clearIconCache();
<a name="l01499"></a>01499     }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     <span class="keyword">private</span> <span class="keywordtype">void</span> fireFileSelectionModeChanged(PropertyChangeEvent e) {
<a name="l01502"></a>01502         clearIconCache();
<a name="l01503"></a>01503         JFileChooser fc = getFileChooser();
<a name="l01504"></a>01504 
<a name="l01505"></a>01505         File currentDirectory = fc.getCurrentDirectory();
<a name="l01506"></a>01506         <span class="keywordflow">if</span> (currentDirectory != null &amp;&amp; fc.isDirectorySelectionEnabled() &amp;&amp; !fc.isFileSelectionEnabled()
<a name="l01507"></a>01507                 &amp;&amp; fc.getFileSystemView().isFileSystem(currentDirectory)) {
<a name="l01508"></a>01508 
<a name="l01509"></a>01509             setFileName(currentDirectory.getPath());
<a name="l01510"></a>01510         } <span class="keywordflow">else</span> {
<a name="l01511"></a>01511             setFileName(null);
<a name="l01512"></a>01512         }
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515     <span class="keyword">private</span> <span class="keywordtype">void</span> fireMultiSelectionChanged(PropertyChangeEvent e) {
<a name="l01516"></a>01516         <span class="keywordflow">if</span> (getFileChooser().isMultiSelectionEnabled()) {
<a name="l01517"></a>01517             tree.getSelectionModel().setSelectionMode(TreeSelectionModel.DISCONTIGUOUS_TREE_SELECTION);
<a name="l01518"></a>01518         } <span class="keywordflow">else</span> {
<a name="l01519"></a>01519             tree.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);
<a name="l01520"></a>01520             getFileChooser().setSelectedFiles(null);
<a name="l01521"></a>01521         }
<a name="l01522"></a>01522     }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524     <span class="keyword">private</span> <span class="keywordtype">void</span> fireAccessoryChanged(PropertyChangeEvent e) {
<a name="l01525"></a>01525         <span class="keywordflow">if</span> (getAccessoryPanel() != null) {
<a name="l01526"></a>01526             JComponent oldAcc = (JComponent) e.getOldValue();
<a name="l01527"></a>01527             JComponent newAcc = (JComponent) e.getNewValue();
<a name="l01528"></a>01528             JComponent accessoryPanel = getAccessoryPanel();
<a name="l01529"></a>01529             <span class="keywordflow">if</span> (oldAcc != null) {
<a name="l01530"></a>01530                 accessoryPanel.remove(oldAcc);
<a name="l01531"></a>01531             }
<a name="l01532"></a>01532             <span class="keywordflow">if</span> (oldAcc != null &amp;&amp; newAcc == null) {
<a name="l01533"></a>01533                 accessoryPanel.remove(topToolbar);
<a name="l01534"></a>01534                 topComboWrapper.add(topToolbar, BorderLayout.EAST);
<a name="l01535"></a>01535                 topCombo.setBorder(BorderFactory.createEmptyBorder(6, 0, 10, 0));
<a name="l01536"></a>01536                 topCombo.revalidate();
<a name="l01537"></a>01537             }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539             <span class="keywordflow">if</span> (newAcc != null) {
<a name="l01540"></a>01540                 getAccessoryPanel().add(newAcc, BorderLayout.CENTER);
<a name="l01541"></a>01541             }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543             <span class="keywordflow">if</span> (oldAcc == null &amp;&amp; newAcc != null) {
<a name="l01544"></a>01544                 topComboWrapper.remove(topToolbar);
<a name="l01545"></a>01545                 topCombo.setBorder(BorderFactory.createEmptyBorder(4, 0, 8, 0));
<a name="l01546"></a>01546                 accessoryPanel.add(topToolbar, BorderLayout.NORTH);
<a name="l01547"></a>01547             }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549         }
<a name="l01550"></a>01550     }
<a name="l01551"></a>01551 
<a name="l01552"></a>01552     <span class="keyword">private</span> <span class="keywordtype">void</span> fireApproveButtonTextChanged(PropertyChangeEvent e) {
<a name="l01553"></a>01553         JFileChooser chooser = getFileChooser();
<a name="l01554"></a>01554         approveButton.setText(getApproveButtonText(chooser));
<a name="l01555"></a>01555         approveButton.setToolTipText(getApproveButtonToolTipText(chooser));
<a name="l01556"></a>01556         <span class="comment">// #107791: No mnemonics desirable on Mac</span>
<a name="l01557"></a>01557         <span class="keywordflow">if</span> (!OS.isMacOSX()) {
<a name="l01558"></a>01558             approveButton.setMnemonic(getApproveButtonMnemonic(chooser));
<a name="l01559"></a>01559         }
<a name="l01560"></a>01560     }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="keyword">private</span> <span class="keywordtype">void</span> fireDialogTypeChanged(PropertyChangeEvent e) {
<a name="l01563"></a>01563         JFileChooser chooser = getFileChooser();
<a name="l01564"></a>01564         approveButton.setText(getApproveButtonText(chooser));
<a name="l01565"></a>01565         approveButton.setToolTipText(getApproveButtonToolTipText(chooser));
<a name="l01566"></a>01566         <span class="comment">// #107791: No mnemonics desirable on Mac</span>
<a name="l01567"></a>01567         <span class="keywordflow">if</span> (!OS.isMacOSX()) {
<a name="l01568"></a>01568             approveButton.setMnemonic(getApproveButtonMnemonic(chooser));
<a name="l01569"></a>01569         }
<a name="l01570"></a>01570         <span class="keywordflow">if</span> (chooser.getDialogType() == JFileChooser.SAVE_DIALOG) {
<a name="l01571"></a>01571             lookInComboBoxLabel.setText(saveInLabelText);
<a name="l01572"></a>01572         } <span class="keywordflow">else</span> {
<a name="l01573"></a>01573             lookInComboBoxLabel.setText(lookInLabelText);
<a name="l01574"></a>01574         }
<a name="l01575"></a>01575     }
<a name="l01576"></a>01576 
<a name="l01577"></a>01577     <span class="keyword">private</span> <span class="keywordtype">void</span> fireApproveButtonMnemonicChanged(PropertyChangeEvent e) {
<a name="l01578"></a>01578         <span class="comment">// #107791: No mnemonics desirable on Mac</span>
<a name="l01579"></a>01579         <span class="keywordflow">if</span> (!OS.isMacOSX()) {
<a name="l01580"></a>01580             approveButton.setMnemonic(getApproveButtonMnemonic(getFileChooser()));
<a name="l01581"></a>01581         }
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583 
<a name="l01584"></a>01584     <span class="keyword">private</span> <span class="keywordtype">void</span> fireControlButtonsChanged(PropertyChangeEvent e) {
<a name="l01585"></a>01585         <span class="keywordflow">if</span> (getFileChooser().getControlButtonsAreShown()) {
<a name="l01586"></a>01586             addControlButtons();
<a name="l01587"></a>01587         } <span class="keywordflow">else</span> {
<a name="l01588"></a>01588             removeControlButtons();
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <span class="comment">/*</span>
<a name="l01593"></a>01593 <span class="comment">     * Listen for filechooser property changes, such as the selected file</span>
<a name="l01594"></a>01594 <span class="comment">     * changing, or the type of the dialog changing.</span>
<a name="l01595"></a>01595 <span class="comment">     */</span>
<a name="l01596"></a>01596     @Override
<a name="l01597"></a>01597     <span class="keyword">public</span> PropertyChangeListener createPropertyChangeListener(JFileChooser fc) {
<a name="l01598"></a>01598         <span class="keywordflow">return</span> <span class="keyword">new</span> PropertyChangeListener() {
<a name="l01599"></a>01599             @Override
<a name="l01600"></a>01600             <span class="keyword">public</span> <span class="keywordtype">void</span> propertyChange(PropertyChangeEvent e) {
<a name="l01601"></a>01601                 String s = e.getPropertyName();
<a name="l01602"></a>01602                 <span class="keywordflow">if</span> (s.equals(JFileChooser.SELECTED_FILE_CHANGED_PROPERTY)) {
<a name="l01603"></a>01603                     fireSelectedFileChanged(e);
<a name="l01604"></a>01604                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.SELECTED_FILES_CHANGED_PROPERTY)) {
<a name="l01605"></a>01605                     fireSelectedFilesChanged(e);
<a name="l01606"></a>01606                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.DIRECTORY_CHANGED_PROPERTY) &amp;&amp; changeDirectory) {
<a name="l01607"></a>01607                     fireDirectoryChanged(e);
<a name="l01608"></a>01608                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.FILE_FILTER_CHANGED_PROPERTY)) {
<a name="l01609"></a>01609                     fireFilterChanged(e);
<a name="l01610"></a>01610                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.FILE_SELECTION_MODE_CHANGED_PROPERTY)) {
<a name="l01611"></a>01611                     fireFileSelectionModeChanged(e);
<a name="l01612"></a>01612                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.MULTI_SELECTION_ENABLED_CHANGED_PROPERTY)) {
<a name="l01613"></a>01613                     fireMultiSelectionChanged(e);
<a name="l01614"></a>01614                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.ACCESSORY_CHANGED_PROPERTY)) {
<a name="l01615"></a>01615                     fireAccessoryChanged(e);
<a name="l01616"></a>01616                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.APPROVE_BUTTON_TEXT_CHANGED_PROPERTY) || s.equals(JFileChooser.APPROVE_BUTTON_TOOL_TIP_TEXT_CHANGED_PROPERTY)) {
<a name="l01617"></a>01617                     fireApproveButtonTextChanged(e);
<a name="l01618"></a>01618                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.DIALOG_TYPE_CHANGED_PROPERTY)) {
<a name="l01619"></a>01619                     fireDialogTypeChanged(e);
<a name="l01620"></a>01620                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.APPROVE_BUTTON_MNEMONIC_CHANGED_PROPERTY)) {
<a name="l01621"></a>01621                     fireApproveButtonMnemonicChanged(e);
<a name="l01622"></a>01622                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(JFileChooser.CONTROL_BUTTONS_ARE_SHOWN_CHANGED_PROPERTY)) {
<a name="l01623"></a>01623                     fireControlButtonsChanged(e);
<a name="l01624"></a>01624                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(DelegatingChooserUI.USE_SHELL_FOLDER)) {
<a name="l01625"></a>01625                     updateUseShellFolder();
<a name="l01626"></a>01626                     fireDirectoryChanged(e);
<a name="l01627"></a>01627                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(<span class="stringliteral">&quot;componentOrientation&quot;</span>)) {
<a name="l01628"></a>01628                     ComponentOrientation o = (ComponentOrientation) e.getNewValue();
<a name="l01629"></a>01629                     JFileChooser cc = (JFileChooser) e.getSource();
<a name="l01630"></a>01630                     <span class="keywordflow">if</span> (o != (ComponentOrientation) e.getOldValue()) {
<a name="l01631"></a>01631                         cc.applyComponentOrientation(o);
<a name="l01632"></a>01632                     }
<a name="l01633"></a>01633                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.equals(<span class="stringliteral">&quot;ancestor&quot;</span>)) {
<a name="l01634"></a>01634                     <span class="keywordflow">if</span> (e.getOldValue() == null &amp;&amp; e.getNewValue() != null) {
<a name="l01635"></a>01635                         filenameTextField.selectAll();
<a name="l01636"></a>01636                         filenameTextField.requestFocus();
<a name="l01637"></a>01637                     }
<a name="l01638"></a>01638                 }
<a name="l01639"></a>01639             }
<a name="l01640"></a>01640         };
<a name="l01641"></a>01641     }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643     <span class="keyword">protected</span> <span class="keywordtype">void</span> removeControlButtons() {
<a name="l01644"></a>01644         bottomPanel.remove(buttonPanel);
<a name="l01645"></a>01645     }
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     <span class="keyword">protected</span> <span class="keywordtype">void</span> addControlButtons() {
<a name="l01648"></a>01648         bottomPanel.add(buttonPanel);
<a name="l01649"></a>01649     }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651     @Override
<a name="l01652"></a>01652     <span class="keyword">public</span> String getFileName() {
<a name="l01653"></a>01653         <span class="keywordflow">if</span> (filenameTextField != null) {
<a name="l01654"></a>01654             <span class="keywordflow">return</span> filenameTextField.getText();
<a name="l01655"></a>01655         } <span class="keywordflow">else</span> {
<a name="l01656"></a>01656             <span class="keywordflow">return</span> null;
<a name="l01657"></a>01657         }
<a name="l01658"></a>01658     }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660     @Override
<a name="l01661"></a>01661     <span class="keyword">public</span> <span class="keywordtype">void</span> setFileName(String filename) {
<a name="l01662"></a>01662         <span class="keywordflow">if</span> (filenameTextField != null) {
<a name="l01663"></a>01663             filenameTextField.setText(filename);
<a name="l01664"></a>01664         }
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666 
<a name="l01667"></a>01667     <span class="keyword">private</span> DirectoryComboBoxRenderer createDirectoryComboBoxRenderer(JFileChooser fc) {
<a name="l01668"></a>01668         <span class="keywordflow">return</span> <span class="keyword">new</span> DirectoryComboBoxRenderer();
<a name="l01669"></a>01669     }
<a name="l01670"></a>01670 
<a name="l01671"></a>01671     <span class="keyword">private</span> DirectoryComboBoxModel createDirectoryComboBoxModel(JFileChooser fc) {
<a name="l01672"></a>01672         <span class="keywordflow">return</span> <span class="keyword">new</span> DirectoryComboBoxModel();
<a name="l01673"></a>01673     }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675     <span class="keyword">private</span> FilterComboBoxRenderer createFilterComboBoxRenderer() {
<a name="l01676"></a>01676         <span class="keywordflow">return</span> <span class="keyword">new</span> FilterComboBoxRenderer();
<a name="l01677"></a>01677     }
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="keyword">protected</span> FilterTypeComboBoxModel createFilterComboBoxModel() {
<a name="l01680"></a>01680         <span class="keywordflow">return</span> <span class="keyword">new</span> FilterTypeComboBoxModel();
<a name="l01681"></a>01681     }
<a name="l01682"></a>01682 
<a name="l01683"></a>01683     @Override
<a name="l01684"></a>01684     <span class="keyword">protected</span> JButton getApproveButton(JFileChooser fc) {
<a name="l01685"></a>01685         <span class="keywordflow">return</span> approveButton;
<a name="l01686"></a>01686     }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688     @Override
<a name="l01689"></a>01689     <span class="keyword">public</span> FileView getFileView(JFileChooser fc) {
<a name="l01690"></a>01690 
<a name="l01691"></a>01691         <span class="comment">// fix bug #96957, should use DirectoryChooserFileView</span>
<a name="l01692"></a>01692         <span class="comment">// only on windows</span>
<a name="l01693"></a>01693         <span class="keywordflow">if</span> (OS.isWindows()) {
<a name="l01694"></a>01694             <span class="keywordflow">if</span> (useShellFolder) {
<a name="l01695"></a>01695                 fileView = <span class="keyword">new</span> DirectoryChooserFileView();
<a name="l01696"></a>01696             }
<a name="l01697"></a>01697         } <span class="keywordflow">else</span> {
<a name="l01698"></a>01698             fileView = (BasicFileView) super.getFileView(fileChooser);
<a name="l01699"></a>01699         }
<a name="l01700"></a>01700         <span class="keywordflow">return</span> fileView;
<a name="l01701"></a>01701     }
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="keyword">private</span> <span class="keywordtype">void</span> setSelected(File[] files) {
<a name="l01704"></a>01704         changeDirectory = <span class="keyword">false</span>;
<a name="l01705"></a>01705         fileChooser.setSelectedFiles(files);
<a name="l01706"></a>01706         changeDirectory = <span class="keyword">true</span>;
<a name="l01707"></a>01707     }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709     <span class="keyword">private</span> DirectoryHandler createDirectoryHandler(JFileChooser chooser) {
<a name="l01710"></a>01710         <span class="keywordflow">return</span> <span class="keyword">new</span> DirectoryHandler(chooser);
<a name="l01711"></a>01711     }
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     <span class="keyword">private</span> <span class="keywordtype">void</span> addNewDirectory(<span class="keyword">final</span> TreePath path) {
<a name="l01714"></a>01714         RequestProcessor.getDefault().post(<span class="keyword">new</span> Runnable() {
<a name="l01715"></a>01715             @Override
<a name="l01716"></a>01716             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01717"></a>01717                 EventQueue.invokeLater(<span class="keyword">new</span> Runnable() {
<a name="l01718"></a>01718                     @Override
<a name="l01719"></a>01719                     <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01720"></a>01720                         DirectoryNode selectedNode = (DirectoryNode) path.getLastPathComponent();
<a name="l01721"></a>01721 
<a name="l01722"></a>01722                         <span class="keywordflow">if</span> (selectedNode == null || !canWrite(selectedNode.getFile())) {
<a name="l01723"></a>01723                             <span class="keywordflow">return</span>;
<a name="l01724"></a>01724                         }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726                         <span class="keywordflow">try</span> {
<a name="l01727"></a>01727                             newFolderNode = <span class="keyword">new</span> DirectoryNode(fileChooser.getFileSystemView().createNewFolder(selectedNode.getFile()));
<a name="l01728"></a>01728                             model.insertNodeInto(newFolderNode, selectedNode, selectedNode.getChildCount());
<a name="l01729"></a>01729                             applyEdit(newFolderNode);
<a name="l01730"></a>01730                         } <span class="keywordflow">catch</span> (IOException ex) {
<a name="l01731"></a>01731                             ex.printStackTrace();
<a name="l01732"></a>01732                         }
<a name="l01733"></a>01733                     }
<a name="l01734"></a>01734                 });
<a name="l01735"></a>01735             }
<a name="l01736"></a>01736         });
<a name="l01737"></a>01737     }
<a name="l01738"></a>01738 
<a name="l01739"></a>01739     <span class="keyword">private</span> <span class="keywordtype">void</span> applyEdit(DirectoryNode node) {
<a name="l01740"></a>01740         TreeNode[] nodes = model.getPathToRoot(node);
<a name="l01741"></a>01741         TreePath editingPath = <span class="keyword">new</span> TreePath(nodes);
<a name="l01742"></a>01742         tree.setEditable(<span class="keyword">true</span>);
<a name="l01743"></a>01743         tree.makeVisible(editingPath);
<a name="l01744"></a>01744         tree.scrollPathToVisible(editingPath);
<a name="l01745"></a>01745         tree.setSelectionPath(editingPath);
<a name="l01746"></a>01746         tree.startEditingAtPath(editingPath);
<a name="l01747"></a>01747 
<a name="l01748"></a>01748         JTextField editField = DirectoryCellEditor.getTextField();
<a name="l01749"></a>01749         editField.setCursor(Cursor.getPredefinedCursor(Cursor.TEXT_CURSOR));
<a name="l01750"></a>01750         editField.setRequestFocusEnabled(<span class="keyword">true</span>);
<a name="l01751"></a>01751         editField.requestFocus();
<a name="l01752"></a>01752         editField.setSelectionStart(0);
<a name="l01753"></a>01753         editField.setSelectionEnd(editField.getText().length());
<a name="l01754"></a>01754     }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span> canWrite(File f) {
<a name="l01757"></a>01757         <span class="keywordtype">boolean</span> writeable = <span class="keyword">false</span>;
<a name="l01758"></a>01758         <span class="keywordflow">if</span> (f != null) {
<a name="l01759"></a>01759             <span class="keywordflow">try</span> {
<a name="l01760"></a>01760                 writeable = f.canWrite();
<a name="l01761"></a>01761             } <span class="keywordflow">catch</span> (AccessControlException ex) {
<a name="l01762"></a>01762                 writeable = <span class="keyword">false</span>;
<a name="l01763"></a>01763             }
<a name="l01764"></a>01764         }
<a name="l01765"></a>01765         <span class="keywordflow">return</span> writeable;
<a name="l01766"></a>01766     }
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="keyword">private</span> <span class="keywordtype">void</span> expandNode(<span class="keyword">final</span> JFileChooser fileChooser, <span class="keyword">final</span> TreePath path) {
<a name="l01769"></a>01769 
<a name="l01770"></a>01770         RequestProcessor.getDefault().post(<span class="keyword">new</span> Runnable() {
<a name="l01771"></a>01771             DirectoryNode node;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773             @Override
<a name="l01774"></a>01774             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01775"></a>01775                 <span class="keywordflow">if</span> (!EventQueue.isDispatchThread()) {
<a name="l01776"></a>01776                     <span class="comment">// first pass, out of EQ thread, loads data</span>
<a name="l01777"></a>01777                     markStartTime();
<a name="l01778"></a>01778                     setCursor(fileChooser, Cursor.WAIT_CURSOR);
<a name="l01779"></a>01779                     node = (DirectoryNode) path.getLastPathComponent();
<a name="l01780"></a>01780                     node.loadChildren(fileChooser, <span class="keyword">true</span>);
<a name="l01781"></a>01781                     <span class="comment">// send to second pass</span>
<a name="l01782"></a>01782                     EventQueue.invokeLater(<span class="keyword">this</span>);
<a name="l01783"></a>01783                 } <span class="keywordflow">else</span> {
<a name="l01784"></a>01784                     <span class="comment">// second pass, in EQ thread</span>
<a name="l01785"></a>01785                     ((DefaultTreeModel) tree.getModel()).nodeStructureChanged(node);
<a name="l01786"></a>01786                     <span class="comment">/*</span>
<a name="l01787"></a>01787 <span class="comment">                     * This happens when the add new directory action is called</span>
<a name="l01788"></a>01788 <span class="comment">                     * and the node is not loaded. Furthermore, it ensures that</span>
<a name="l01789"></a>01789 <span class="comment">                     * adding a new directory execute after the UI has finished</span>
<a name="l01790"></a>01790 <span class="comment">                     * displaying the children of the expanded node.</span>
<a name="l01791"></a>01791 <span class="comment">                     */</span>
<a name="l01792"></a>01792                     <span class="keywordflow">if</span> (addNewDirectory) {
<a name="l01793"></a>01793                         addNewDirectory(path);
<a name="l01794"></a>01794                         addNewDirectory = <span class="keyword">false</span>;
<a name="l01795"></a>01795                     }
<a name="l01796"></a>01796                     setCursor(fileChooser, Cursor.DEFAULT_CURSOR);
<a name="l01797"></a>01797                     checkUpdate();
<a name="l01798"></a>01798                 }
<a name="l01799"></a>01799             }
<a name="l01800"></a>01800         });
<a name="l01801"></a>01801     }
<a name="l01802"></a>01802 
<a name="l01803"></a>01803     <span class="keyword">private</span> <span class="keywordtype">void</span> setCursor(<span class="keyword">final</span> JComponent comp, <span class="keyword">final</span> <span class="keywordtype">int</span> type) {
<a name="l01804"></a>01804         <span class="keywordflow">if</span> (!EventQueue.isDispatchThread()) {
<a name="l01805"></a>01805             EventQueue.invokeLater(<span class="keyword">new</span> Runnable() {
<a name="l01806"></a>01806                 @Override
<a name="l01807"></a>01807                 <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01808"></a>01808                     setCursor(comp, type);
<a name="l01809"></a>01809                 }
<a name="l01810"></a>01810             });
<a name="l01811"></a>01811         } <span class="keywordflow">else</span> {
<a name="l01812"></a>01812             Window window = SwingUtilities.getWindowAncestor(comp);
<a name="l01813"></a>01813             <span class="keywordflow">if</span> (window != null) {
<a name="l01814"></a>01814                 Cursor cursor = Cursor.getPredefinedCursor(type);
<a name="l01815"></a>01815                 window.setCursor(cursor);
<a name="l01816"></a>01816                 window.setFocusable(<span class="keyword">true</span>);
<a name="l01817"></a>01817             }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819             JRootPane pane = fileChooser.getRootPane();
<a name="l01820"></a>01820             <span class="keywordflow">if</span> (null == blocker)
<a name="l01821"></a>01821                 blocker = <span class="keyword">new</span> InputBlocker();
<a name="l01822"></a>01822 
<a name="l01823"></a>01823             <span class="keywordflow">if</span> (type == Cursor.WAIT_CURSOR) {
<a name="l01824"></a>01824                 blocker.block(pane);
<a name="l01825"></a>01825             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == Cursor.DEFAULT_CURSOR) {
<a name="l01826"></a>01826                 blocker.unBlock(pane);
<a name="l01827"></a>01827             }
<a name="l01828"></a>01828         }
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830 
<a name="l01831"></a>01831     <span class="comment">/*************** HELPER CLASSES ***************/</span>
<a name="l01832"></a>01832 
<a name="l01833"></a>01833     <span class="keyword">private</span> <span class="keyword">class </span>IconIndenter <span class="keyword">implements</span> Icon {
<a name="l01834"></a>01834         <span class="keyword">final</span> <span class="keyword">static</span> <span class="keywordtype">int</span> space = 10;
<a name="l01835"></a>01835         Icon icon = null;
<a name="l01836"></a>01836         <span class="keywordtype">int</span> depth = 0;
<a name="l01837"></a>01837 
<a name="l01838"></a>01838         @Override
<a name="l01839"></a>01839         <span class="keyword">public</span> <span class="keywordtype">void</span> paintIcon(Component c, Graphics g, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) {
<a name="l01840"></a>01840             <span class="keywordflow">if</span> (icon == null) {
<a name="l01841"></a>01841                 <span class="keywordflow">return</span>;
<a name="l01842"></a>01842             }
<a name="l01843"></a>01843             <span class="keywordflow">if</span> (c.getComponentOrientation().isLeftToRight()) {
<a name="l01844"></a>01844                 icon.paintIcon(c, g, x + depth * space, y);
<a name="l01845"></a>01845             } <span class="keywordflow">else</span> {
<a name="l01846"></a>01846                 icon.paintIcon(c, g, x, y);
<a name="l01847"></a>01847             }
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849 
<a name="l01850"></a>01850         @Override
<a name="l01851"></a>01851         <span class="keyword">public</span> <span class="keywordtype">int</span> getIconWidth() {
<a name="l01852"></a>01852             <span class="keywordflow">return</span> icon != null ? icon.getIconWidth() + depth * space : 0;
<a name="l01853"></a>01853         }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855         @Override
<a name="l01856"></a>01856         <span class="keyword">public</span> <span class="keywordtype">int</span> getIconHeight() {
<a name="l01857"></a>01857             <span class="keywordflow">return</span> icon != null ? icon.getIconHeight() : 0;
<a name="l01858"></a>01858         }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860     }
<a name="l01861"></a>01861 
<a name="l01862"></a>01862     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryComboBoxRenderer <span class="keyword">extends</span> JLabel implements ListCellRenderer, UIResource {
<a name="l01863"></a>01863         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01864"></a>01864 
<a name="l01865"></a>01865         IconIndenter indenter = <span class="keyword">new</span> IconIndenter();
<a name="l01866"></a>01866 
<a name="l01867"></a>01867         <span class="keyword">public</span> DirectoryComboBoxRenderer() {
<a name="l01868"></a>01868             setOpaque(<span class="keyword">true</span>);
<a name="l01869"></a>01869         }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871         @Override
<a name="l01872"></a>01872         <span class="keyword">public</span> Component getListCellRendererComponent(JList list, Object value, <span class="keywordtype">int</span> index, <span class="keywordtype">boolean</span> isSelected, <span class="keywordtype">boolean</span> cellHasFocus) {
<a name="l01873"></a>01873             <span class="comment">// #89393: GTK needs name to render cell renderer &quot;natively&quot;</span>
<a name="l01874"></a>01874             setName(<span class="stringliteral">&quot;ComboBox.listRenderer&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01875"></a>01875 
<a name="l01876"></a>01876             <span class="keywordflow">if</span> (value == null) {
<a name="l01877"></a>01877                 setText(<span class="stringliteral">&quot;&quot;</span>);
<a name="l01878"></a>01878                 <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l01879"></a>01879             }
<a name="l01880"></a>01880             File directory = (File) value;
<a name="l01881"></a>01881             setText(getFileChooser().getName(directory));
<a name="l01882"></a>01882             Icon icon = getFileChooser().getIcon(directory);
<a name="l01883"></a>01883             indenter.icon = icon;
<a name="l01884"></a>01884             indenter.depth = directoryComboBoxModel.getDepth(index);
<a name="l01885"></a>01885             setIcon(indenter);
<a name="l01886"></a>01886             <span class="keywordflow">if</span> (isSelected) {
<a name="l01887"></a>01887                 setBackground(list.getSelectionBackground());
<a name="l01888"></a>01888                 setForeground(list.getSelectionForeground());
<a name="l01889"></a>01889             } <span class="keywordflow">else</span> {
<a name="l01890"></a>01890                 setBackground(list.getBackground());
<a name="l01891"></a>01891                 setForeground(list.getForeground());
<a name="l01892"></a>01892             }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l01895"></a>01895         }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897         <span class="comment">// #89393: GTK needs name to render cell renderer &quot;natively&quot;</span>
<a name="l01898"></a>01898         @Override
<a name="l01899"></a>01899         <span class="keyword">public</span> String getName() {
<a name="l01900"></a>01900             String name = super.getName();
<a name="l01901"></a>01901             <span class="keywordflow">return</span> name == null ? <span class="stringliteral">&quot;ComboBox.renderer&quot;</span> : name; <span class="comment">// NOI18N</span>
<a name="l01902"></a>01902         }
<a name="l01903"></a>01903     } <span class="comment">// end of DirectoryComboBoxRenderer</span>
<a name="l01904"></a>01904 
<a name="l01908"></a>01908     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryComboBoxModel <span class="keyword">extends</span> AbstractListModel implements ComboBoxModel {
<a name="l01909"></a>01909         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01910"></a>01910 
<a name="l01911"></a>01911         Vector&lt;File&gt; directories = <span class="keyword">new</span> Vector&lt;File&gt;();
<a name="l01912"></a>01912         <span class="keywordtype">int</span>[] depths = null;
<a name="l01913"></a>01913         File selectedDirectory = null;
<a name="l01914"></a>01914 
<a name="l01915"></a>01915         <span class="keyword">public</span> DirectoryComboBoxModel() {
<a name="l01916"></a>01916             <span class="comment">// Add the current directory to the model, and make it the</span>
<a name="l01917"></a>01917             <span class="comment">// selectedDirectory</span>
<a name="l01918"></a>01918             File dir = getFileChooser().getCurrentDirectory();
<a name="l01919"></a>01919             <span class="keywordflow">if</span> (dir != null) {
<a name="l01920"></a>01920                 addItem(dir);
<a name="l01921"></a>01921             }
<a name="l01922"></a>01922         }
<a name="l01923"></a>01923 
<a name="l01929"></a>01929         <span class="keyword">private</span> <span class="keywordtype">void</span> addItem(File directory) {
<a name="l01930"></a>01930 
<a name="l01931"></a>01931             <span class="keywordflow">if</span> (directory == null) {
<a name="l01932"></a>01932                 <span class="keywordflow">return</span>;
<a name="l01933"></a>01933             }
<a name="l01934"></a>01934 
<a name="l01935"></a>01935             directories.clear();
<a name="l01936"></a>01936 
<a name="l01937"></a>01937             <span class="keywordflow">if</span> (useShellFolder) {
<a name="l01938"></a>01938                 directories.addAll(Arrays.asList(getShellFolderRoots()));
<a name="l01939"></a>01939             } <span class="keywordflow">else</span> {
<a name="l01940"></a>01940                 directories.addAll(Arrays.asList(fileChooser.getFileSystemView().getRoots()));
<a name="l01941"></a>01941             }
<a name="l01942"></a>01942 
<a name="l01943"></a>01943             <span class="comment">// Get the canonical (full) path. This has the side</span>
<a name="l01944"></a>01944             <span class="comment">// benefit of removing extraneous chars from the path,</span>
<a name="l01945"></a>01945             <span class="comment">// for example /foo/bar/ becomes /foo/bar</span>
<a name="l01946"></a>01946             File canonical = null;
<a name="l01947"></a>01947             <span class="keywordflow">try</span> {
<a name="l01948"></a>01948                 canonical = directory.getCanonicalFile();
<a name="l01949"></a>01949             } <span class="keywordflow">catch</span> (IOException e) {
<a name="l01950"></a>01950                 <span class="comment">// Maybe drive is not ready. Can&#39;t abort here.</span>
<a name="l01951"></a>01951                 canonical = directory;
<a name="l01952"></a>01952             }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954             <span class="comment">// create File instances of each directory leading up to the top</span>
<a name="l01955"></a>01955             File sf = useShellFolder ? getShellFolderForFile(canonical) : canonical;
<a name="l01956"></a>01956             File f = sf;
<a name="l01957"></a>01957             Vector&lt;File&gt; path = <span class="keyword">new</span> Vector&lt;File&gt;(10);
<a name="l01958"></a>01958 
<a name="l01959"></a>01959             <span class="comment">/*</span>
<a name="l01960"></a>01960 <span class="comment">             * Fix for IZ#122534 : NullPointerException at</span>
<a name="l01961"></a>01961 <span class="comment">             * org.netbeans.swing.dirchooser</span>
<a name="l01962"></a>01962 <span class="comment">             * .DirectoryChooserUI$DirectoryComboBoxModel.addItem</span>
<a name="l01963"></a>01963 <span class="comment">             */</span>
<a name="l01964"></a>01964             <span class="keywordflow">while</span> (f != null) {
<a name="l01965"></a>01965                 path.addElement(f);
<a name="l01966"></a>01966                 f = f.getParentFile();
<a name="l01967"></a>01967             }
<a name="l01968"></a>01968 
<a name="l01969"></a>01969             <span class="keywordtype">int</span> pathCount = path.size();
<a name="l01970"></a>01970             <span class="comment">// Insert chain at appropriate place in vector</span>
<a name="l01971"></a>01971             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; pathCount; i++) {
<a name="l01972"></a>01972                 f = path.get(i);
<a name="l01973"></a>01973                 <span class="keywordflow">if</span> (directories.contains(f)) {
<a name="l01974"></a>01974                     <span class="keywordtype">int</span> topIndex = directories.indexOf(f);
<a name="l01975"></a>01975                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = i - 1; j &gt;= 0; j--) {
<a name="l01976"></a>01976                         directories.insertElementAt(path.get(j), topIndex + i - j);
<a name="l01977"></a>01977                     }
<a name="l01978"></a>01978                     <span class="keywordflow">break</span>;
<a name="l01979"></a>01979                 }
<a name="l01980"></a>01980             }
<a name="l01981"></a>01981             calculateDepths();
<a name="l01982"></a>01982             setSelectedItem(sf);
<a name="l01983"></a>01983         }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985         <span class="keyword">private</span> <span class="keywordtype">void</span> calculateDepths() {
<a name="l01986"></a>01986             depths = <span class="keyword">new</span> <span class="keywordtype">int</span>[directories.size()];
<a name="l01987"></a>01987             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; depths.length; i++) {
<a name="l01988"></a>01988                 File dir = directories.get(i);
<a name="l01989"></a>01989                 File parent = dir.getParentFile();
<a name="l01990"></a>01990                 depths[i] = 0;
<a name="l01991"></a>01991                 <span class="keywordflow">if</span> (parent != null) {
<a name="l01992"></a>01992                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = i - 1; j &gt;= 0; j--) {
<a name="l01993"></a>01993                         <span class="keywordflow">if</span> (parent.equals(directories.get(j))) {
<a name="l01994"></a>01994                             depths[i] = depths[j] + 1;
<a name="l01995"></a>01995                             <span class="keywordflow">break</span>;
<a name="l01996"></a>01996                         }
<a name="l01997"></a>01997                     }
<a name="l01998"></a>01998                 }
<a name="l01999"></a>01999             }
<a name="l02000"></a>02000         }
<a name="l02001"></a>02001 
<a name="l02002"></a>02002         <span class="keyword">public</span> <span class="keywordtype">int</span> getDepth(<span class="keywordtype">int</span> i) {
<a name="l02003"></a>02003             <span class="keywordflow">return</span> (depths != null &amp;&amp; i &gt;= 0 &amp;&amp; i &lt; depths.length) ? depths[i] : 0;
<a name="l02004"></a>02004         }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006         @Override
<a name="l02007"></a>02007         <span class="keyword">public</span> <span class="keywordtype">void</span> setSelectedItem(Object selectedDirectory) {
<a name="l02008"></a>02008             this.selectedDirectory = (File) selectedDirectory;
<a name="l02009"></a>02009             fireContentsChanged(<span class="keyword">this</span>, -1, -1);
<a name="l02010"></a>02010         }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012         @Override
<a name="l02013"></a>02013         <span class="keyword">public</span> Object getSelectedItem() {
<a name="l02014"></a>02014             <span class="keywordflow">return</span> selectedDirectory;
<a name="l02015"></a>02015         }
<a name="l02016"></a>02016 
<a name="l02017"></a>02017         @Override
<a name="l02018"></a>02018         <span class="keyword">public</span> <span class="keywordtype">int</span> getSize() {
<a name="l02019"></a>02019             <span class="keywordflow">return</span> directories.size();
<a name="l02020"></a>02020         }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022         @Override
<a name="l02023"></a>02023         <span class="keyword">public</span> Object getElementAt(<span class="keywordtype">int</span> index) {
<a name="l02024"></a>02024             <span class="keywordflow">return</span> directories.elementAt(index);
<a name="l02025"></a>02025         }
<a name="l02026"></a>02026     }
<a name="l02027"></a>02027 
<a name="l02031"></a>02031     <span class="keyword">private</span> <span class="keyword">class </span>FilterComboBoxRenderer <span class="keyword">extends</span> JLabel implements ListCellRenderer, UIResource {
<a name="l02032"></a>02032         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l02033"></a>02033 
<a name="l02034"></a>02034         <span class="keyword">public</span> FilterComboBoxRenderer() {
<a name="l02035"></a>02035             setOpaque(<span class="keyword">true</span>);
<a name="l02036"></a>02036         }
<a name="l02037"></a>02037 
<a name="l02038"></a>02038         @Override
<a name="l02039"></a>02039         <span class="keyword">public</span> Component getListCellRendererComponent(JList list, Object value, <span class="keywordtype">int</span> index, <span class="keywordtype">boolean</span> isSelected, <span class="keywordtype">boolean</span> cellHasFocus) {
<a name="l02040"></a>02040 
<a name="l02041"></a>02041             <span class="comment">// #89393: GTK needs name to render cell renderer &quot;natively&quot;</span>
<a name="l02042"></a>02042             setName(<span class="stringliteral">&quot;ComboBox.listRenderer&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l02043"></a>02043 
<a name="l02044"></a>02044             <span class="keywordflow">if</span> (value != null &amp;&amp; value instanceof FileFilter) {
<a name="l02045"></a>02045                 setText(((FileFilter) value).getDescription());
<a name="l02046"></a>02046             }
<a name="l02047"></a>02047 
<a name="l02048"></a>02048             <span class="keywordflow">if</span> (isSelected) {
<a name="l02049"></a>02049                 setBackground(list.getSelectionBackground());
<a name="l02050"></a>02050                 setForeground(list.getSelectionForeground());
<a name="l02051"></a>02051             } <span class="keywordflow">else</span> {
<a name="l02052"></a>02052                 setBackground(list.getBackground());
<a name="l02053"></a>02053                 setForeground(list.getForeground());
<a name="l02054"></a>02054             }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l02057"></a>02057         }
<a name="l02058"></a>02058 
<a name="l02059"></a>02059         <span class="comment">// #89393: GTK needs name to render cell renderer &quot;natively&quot;</span>
<a name="l02060"></a>02060         @Override
<a name="l02061"></a>02061         <span class="keyword">public</span> String getName() {
<a name="l02062"></a>02062             String name = super.getName();
<a name="l02063"></a>02063             <span class="keywordflow">return</span> name == null ? <span class="stringliteral">&quot;ComboBox.renderer&quot;</span> : name; <span class="comment">// NOI18N</span>
<a name="l02064"></a>02064         }
<a name="l02065"></a>02065 
<a name="l02066"></a>02066     } <span class="comment">// end of FilterComboBoxRenderer</span>
<a name="l02067"></a>02067 
<a name="l02071"></a><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_filter_type_combo_box_model.html">02071</a>     <span class="keyword">protected</span> <span class="keyword">class </span><a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_filter_type_combo_box_model.html">FilterTypeComboBoxModel</a> <span class="keyword">extends</span> AbstractListModel implements ComboBoxModel, PropertyChangeListener {
<a name="l02072"></a>02072         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l02073"></a>02073 
<a name="l02074"></a>02074         <span class="keyword">protected</span> FileFilter[] filters;
<a name="l02075"></a>02075 
<a name="l02076"></a>02076         <span class="keyword">protected</span> <a class="code" href="classorg_1_1netbeans_1_1swing_1_1dirchooser_1_1_directory_chooser_u_i_1_1_filter_type_combo_box_model.html">FilterTypeComboBoxModel</a>() {
<a name="l02077"></a>02077             super();
<a name="l02078"></a>02078             filters = getFileChooser().getChoosableFileFilters();
<a name="l02079"></a>02079         }
<a name="l02080"></a>02080 
<a name="l02081"></a>02081         @Override
<a name="l02082"></a>02082         <span class="keyword">public</span> <span class="keywordtype">void</span> propertyChange(PropertyChangeEvent e) {
<a name="l02083"></a>02083             String prop = e.getPropertyName();
<a name="l02084"></a>02084             <span class="keywordflow">if</span> (prop == JFileChooser.CHOOSABLE_FILE_FILTER_CHANGED_PROPERTY) {
<a name="l02085"></a>02085                 filters = (FileFilter[]) e.getNewValue();
<a name="l02086"></a>02086                 fireContentsChanged(<span class="keyword">this</span>, -1, -1);
<a name="l02087"></a>02087             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prop == JFileChooser.FILE_FILTER_CHANGED_PROPERTY) {
<a name="l02088"></a>02088                 fireContentsChanged(<span class="keyword">this</span>, -1, -1);
<a name="l02089"></a>02089             }
<a name="l02090"></a>02090         }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092         @Override
<a name="l02093"></a>02093         <span class="keyword">public</span> <span class="keywordtype">void</span> setSelectedItem(Object filter) {
<a name="l02094"></a>02094             <span class="keywordflow">if</span> (filter != null) {
<a name="l02095"></a>02095                 getFileChooser().setFileFilter((FileFilter) filter);
<a name="l02096"></a>02096                 setFileName(null);
<a name="l02097"></a>02097                 fireContentsChanged(<span class="keyword">this</span>, -1, -1);
<a name="l02098"></a>02098             }
<a name="l02099"></a>02099         }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101         @Override
<a name="l02102"></a>02102         <span class="keyword">public</span> Object getSelectedItem() {
<a name="l02103"></a>02103             <span class="comment">// Ensure that the current filter is in the list.</span>
<a name="l02104"></a>02104             <span class="comment">// NOTE: we shouldnt&#39; have to do this, since JFileChooser adds</span>
<a name="l02105"></a>02105             <span class="comment">// the filter to the choosable filters list when the filter</span>
<a name="l02106"></a>02106             <span class="comment">// is set. Lets be paranoid just in case someone overrides</span>
<a name="l02107"></a>02107             <span class="comment">// setFileFilter in JFileChooser.</span>
<a name="l02108"></a>02108             FileFilter currentFilter = getFileChooser().getFileFilter();
<a name="l02109"></a>02109             <span class="keywordtype">boolean</span> found = <span class="keyword">false</span>;
<a name="l02110"></a>02110             <span class="keywordflow">if</span> (currentFilter != null) {
<a name="l02111"></a>02111                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; filters.length; i++) {
<a name="l02112"></a>02112                     <span class="keywordflow">if</span> (filters[i] == currentFilter) {
<a name="l02113"></a>02113                         found = <span class="keyword">true</span>;
<a name="l02114"></a>02114                     }
<a name="l02115"></a>02115                 }
<a name="l02116"></a>02116                 <span class="keywordflow">if</span> (found == <span class="keyword">false</span>) {
<a name="l02117"></a>02117                     getFileChooser().addChoosableFileFilter(currentFilter);
<a name="l02118"></a>02118                 }
<a name="l02119"></a>02119             }
<a name="l02120"></a>02120             <span class="keywordflow">return</span> getFileChooser().getFileFilter();
<a name="l02121"></a>02121         }
<a name="l02122"></a>02122 
<a name="l02123"></a>02123         @Override
<a name="l02124"></a>02124         <span class="keyword">public</span> <span class="keywordtype">int</span> getSize() {
<a name="l02125"></a>02125             <span class="keywordflow">if</span> (filters != null) {
<a name="l02126"></a>02126                 <span class="keywordflow">return</span> filters.length;
<a name="l02127"></a>02127             } <span class="keywordflow">else</span> {
<a name="l02128"></a>02128                 <span class="keywordflow">return</span> 0;
<a name="l02129"></a>02129             }
<a name="l02130"></a>02130         }
<a name="l02131"></a>02131 
<a name="l02132"></a>02132         @Override
<a name="l02133"></a>02133         <span class="keyword">public</span> Object getElementAt(<span class="keywordtype">int</span> index) {
<a name="l02134"></a>02134             <span class="keywordflow">if</span> (index &gt; getSize() - 1) {
<a name="l02135"></a>02135                 <span class="comment">// This shouldn&#39;t happen. Try to recover gracefully.</span>
<a name="l02136"></a>02136                 <span class="keywordflow">return</span> getFileChooser().getFileFilter();
<a name="l02137"></a>02137             }
<a name="l02138"></a>02138             <span class="keywordflow">if</span> (filters != null) {
<a name="l02139"></a>02139                 <span class="keywordflow">return</span> filters[index];
<a name="l02140"></a>02140             } <span class="keywordflow">else</span> {
<a name="l02141"></a>02141                 <span class="keywordflow">return</span> null;
<a name="l02142"></a>02142             }
<a name="l02143"></a>02143         }
<a name="l02144"></a>02144     }
<a name="l02145"></a>02145 
<a name="l02149"></a>02149     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryComboBoxAction <span class="keyword">implements</span> ActionListener {
<a name="l02150"></a>02150         @Override
<a name="l02151"></a>02151         <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l02152"></a>02152             File f = (File) directoryComboBox.getSelectedItem();
<a name="l02153"></a>02153             getFileChooser().setCurrentDirectory(f);
<a name="l02154"></a>02154         }
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156 
<a name="l02157"></a>02157     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryChooserFileView <span class="keyword">extends</span> BasicFileView {
<a name="l02158"></a>02158 
<a name="l02159"></a>02159         @Override
<a name="l02160"></a>02160         <span class="keyword">public</span> Icon getIcon(File f) {
<a name="l02161"></a>02161 
<a name="l02162"></a>02162             Icon icon = getCachedIcon(f);
<a name="l02163"></a>02163             <span class="keywordflow">if</span> (icon != null) {
<a name="l02164"></a>02164                 <span class="keywordflow">return</span> icon;
<a name="l02165"></a>02165             }
<a name="l02166"></a>02166 
<a name="l02167"></a>02167             <span class="keywordflow">if</span> (f != null) {
<a name="l02168"></a>02168                 <span class="keywordflow">try</span> {
<a name="l02169"></a>02169                     icon = fileChooser.getFileSystemView().getSystemIcon(f);
<a name="l02170"></a>02170                 } <span class="keywordflow">catch</span> (NullPointerException exc) {
<a name="l02171"></a>02171                     <span class="comment">// workaround for JDK bug 6357445, in IZ: 145832, please</span>
<a name="l02172"></a>02172                     <span class="comment">// remove when fixed</span>
<a name="l02173"></a>02173                     LOG.log(Level.FINE, <span class="stringliteral">&quot;JDK bug 6357445 encountered, NPE caught&quot;</span>, exc); <span class="comment">// NOI18N</span>
<a name="l02174"></a>02174                 }
<a name="l02175"></a>02175             }
<a name="l02176"></a>02176 
<a name="l02177"></a>02177             <span class="keywordflow">if</span> (icon == null) {
<a name="l02178"></a>02178                 icon = super.getIcon(f);
<a name="l02179"></a>02179             }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181             cacheIcon(f, icon);
<a name="l02182"></a>02182             <span class="keywordflow">return</span> icon;
<a name="l02183"></a>02183         }
<a name="l02184"></a>02184     }
<a name="l02185"></a>02185 
<a name="l02186"></a>02186     <span class="keyword">private</span> <span class="keyword">class </span>TextFieldKeyListener <span class="keyword">extends</span> KeyAdapter {
<a name="l02187"></a>02187         @Override
<a name="l02188"></a>02188         <span class="keyword">public</span> <span class="keywordtype">void</span> keyPressed(KeyEvent evt) {
<a name="l02189"></a>02189             showPopupCompletion = <span class="keyword">true</span>;
<a name="l02190"></a>02190             <span class="keywordtype">int</span> keyCode = evt.getKeyCode();
<a name="l02191"></a>02191             <span class="comment">// #105801: completionPopup might not be ready when</span>
<a name="l02192"></a>02192             <span class="comment">// updateCompletions not called (empty text field)</span>
<a name="l02193"></a>02193             <span class="keywordflow">if</span> (completionPopup != null &amp;&amp; !completionPopup.isVisible()) {
<a name="l02194"></a>02194                 <span class="keywordflow">if</span> (keyCode == KeyEvent.VK_ENTER) {
<a name="l02195"></a>02195                     File file = getFileChooser().getFileSystemView().createFileObject(filenameTextField.getText());
<a name="l02196"></a>02196                     <span class="keywordflow">if</span> (file.exists() &amp;&amp; file.isDirectory()) {
<a name="l02197"></a>02197                         setSelected(<span class="keyword">new</span> File[] { file });
<a name="l02198"></a>02198                         fileChooser.approveSelection();
<a name="l02199"></a>02199                     }
<a name="l02200"></a>02200                 }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202                 <span class="keywordflow">if</span> ((keyCode == KeyEvent.VK_TAB || keyCode == KeyEvent.VK_DOWN)
<a name="l02203"></a>02203                         || (keyCode == KeyEvent.VK_RIGHT &amp;&amp; (filenameTextField.getCaretPosition() &gt;= (filenameTextField.getDocument().getLength() - 1)))) {
<a name="l02204"></a>02204                     updateCompletions();
<a name="l02205"></a>02205                 }
<a name="l02206"></a>02206 
<a name="l02207"></a>02207             }
<a name="l02208"></a>02208 
<a name="l02209"></a>02209             <span class="keywordflow">if</span> (filenameTextField.isFocusOwner() &amp;&amp; (completionPopup == null || !completionPopup.isVisible()) &amp;&amp; keyCode == KeyEvent.VK_ESCAPE) {
<a name="l02210"></a>02210                 fileChooser.cancelSelection();
<a name="l02211"></a>02211             }
<a name="l02212"></a>02212         }
<a name="l02213"></a>02213     }
<a name="l02214"></a>02214 
<a name="l02215"></a>02215     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryHandler <span class="keyword">extends</span> MouseAdapter implements TreeSelectionListener, CellEditorListener, ActionListener, FocusListener, Runnable {
<a name="l02216"></a>02216         <span class="keyword">private</span> JFileChooser fileChooser;
<a name="l02218"></a>02218         <span class="keyword">private</span> WeakReference&lt;TreePath&gt; curSelPath;
<a name="l02220"></a>02220         <span class="keyword">private</span> Timer renameTimer;
<a name="l02222"></a>02222         <span class="keyword">private</span> Timer dblClickTimer;
<a name="l02224"></a>02224         <span class="keyword">private</span> TreePath pathToRename;
<a name="l02225"></a>02225 
<a name="l02226"></a>02226         <span class="keyword">public</span> DirectoryHandler(JFileChooser fileChooser) {
<a name="l02227"></a>02227             this.fileChooser = fileChooser;
<a name="l02228"></a>02228         }
<a name="l02229"></a>02229 
<a name="l02230"></a>02230         <span class="comment">/************ imple of TreeSelectionListener *******/</span>
<a name="l02231"></a>02231 
<a name="l02232"></a>02232         @Override
<a name="l02233"></a>02233         <span class="keyword">public</span> <span class="keywordtype">void</span> valueChanged(TreeSelectionEvent e) {
<a name="l02234"></a>02234             showPopupCompletion = <span class="keyword">false</span>;
<a name="l02235"></a>02235             JTree tree = (JTree) e.getSource();
<a name="l02236"></a>02236             TreePath path = tree.getSelectionPath();
<a name="l02237"></a>02237             TreePath curSel = e.getNewLeadSelectionPath();
<a name="l02238"></a>02238             curSelPath = (curSel != null) ? <span class="keyword">new</span> WeakReference&lt;TreePath&gt;(curSel) : null;
<a name="l02239"></a>02239 
<a name="l02240"></a>02240             <span class="keywordflow">if</span> (path != null) {
<a name="l02241"></a>02241 
<a name="l02242"></a>02242                 DirectoryNode node = (DirectoryNode) path.getLastPathComponent();
<a name="l02243"></a>02243                 File file = node.getFile();
<a name="l02244"></a>02244 
<a name="l02245"></a>02245                 <span class="keywordflow">if</span> (file != null) {
<a name="l02246"></a>02246                     setSelected(getSelectedNodes(tree.getSelectionPaths()));
<a name="l02247"></a>02247                     newFolderAction.setEnabled(canWrite(file) &amp;&amp; file.isDirectory());
<a name="l02248"></a>02248 
<a name="l02249"></a>02249                     <span class="keywordflow">if</span> (file.isDirectory()) {
<a name="l02250"></a>02250                         setDirectorySelected(<span class="keyword">true</span>);
<a name="l02251"></a>02251                     }
<a name="l02252"></a>02252                 }
<a name="l02253"></a>02253             }
<a name="l02254"></a>02254         }
<a name="l02255"></a>02255 
<a name="l02256"></a>02256         <span class="keyword">private</span> File[] getSelectedNodes(TreePath[] paths) {
<a name="l02257"></a>02257             List&lt;File&gt; files = <span class="keyword">new</span> LinkedList&lt;File&gt;();
<a name="l02258"></a>02258             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; paths.length; i++) {
<a name="l02259"></a>02259                 File file = ((DirectoryNode) paths[i].getLastPathComponent()).getFile();
<a name="l02260"></a>02260                 <span class="keywordflow">if</span> (file.isDirectory() &amp;&amp; fileChooser.isTraversable(file) &amp;&amp; !fileChooser.getFileSystemView().isFileSystem(file)) {
<a name="l02261"></a>02261                     <span class="keywordflow">continue</span>;
<a name="l02262"></a>02262                 }
<a name="l02263"></a>02263                 files.add(file);
<a name="l02264"></a>02264             }
<a name="l02265"></a>02265             <span class="keywordflow">return</span> files.toArray(<span class="keyword">new</span> File[files.size()]);
<a name="l02266"></a>02266         }
<a name="l02267"></a>02267 
<a name="l02268"></a>02268         <span class="comment">/********* impl of MouseListener ***********/</span>
<a name="l02269"></a>02269 
<a name="l02270"></a>02270         @Override
<a name="l02271"></a>02271         <span class="keyword">public</span> <span class="keywordtype">void</span> mouseClicked(MouseEvent e) {
<a name="l02272"></a>02272             <span class="keyword">final</span> JTree tree = (JTree) e.getSource();
<a name="l02273"></a>02273             <span class="keyword">final</span> <span class="keywordtype">int</span> x = e.getX();
<a name="l02274"></a>02274             <span class="keyword">final</span> <span class="keywordtype">int</span> y = e.getY();
<a name="l02275"></a>02275             <span class="keywordtype">int</span> row = tree.getRowForLocation(x, y);
<a name="l02276"></a>02276             TreePath path = tree.getPathForRow(row);
<a name="l02277"></a>02277 
<a name="l02278"></a>02278             <span class="keywordflow">if</span> (path != null) {
<a name="l02279"></a>02279 
<a name="l02280"></a>02280                 DirectoryNode node = (DirectoryNode) path.getLastPathComponent();
<a name="l02281"></a>02281                 newFolderAction.setEnabled(canWrite(node.getFile()));
<a name="l02282"></a>02282 
<a name="l02283"></a>02283                 <span class="keywordflow">if</span> (SwingUtilities.isLeftMouseButton(e) &amp;&amp; (e.getClickCount() == 2)) {
<a name="l02284"></a>02284                     handleDblClick(node);
<a name="l02285"></a>02285                     <span class="keywordflow">return</span>;
<a name="l02286"></a>02286                 }
<a name="l02287"></a>02287 
<a name="l02288"></a>02288                 <span class="comment">// handles click to rename feature</span>
<a name="l02289"></a>02289                 <span class="keywordflow">if</span> (SwingUtilities.isLeftMouseButton(e) &amp;&amp; (e.getClickCount() == 1)) {
<a name="l02290"></a>02290                     <span class="keywordflow">if</span> (pathToRename != null) {
<a name="l02291"></a>02291                         <span class="keywordflow">if</span> (dblClickTimer != null) {
<a name="l02292"></a>02292                             handleDblClick(node);
<a name="l02293"></a>02293                             <span class="keywordflow">return</span>;
<a name="l02294"></a>02294                         }
<a name="l02295"></a>02295                         <span class="comment">// start slow click rename timer</span>
<a name="l02296"></a>02296                         renameTimer = <span class="keyword">new</span> Timer(800, <span class="keyword">this</span>);
<a name="l02297"></a>02297                         renameTimer.setRepeats(<span class="keyword">false</span>);
<a name="l02298"></a>02298                         renameTimer.start();
<a name="l02299"></a>02299                         startDblClickTimer();
<a name="l02300"></a>02300                     }
<a name="l02301"></a>02301                 }
<a name="l02302"></a>02302 
<a name="l02303"></a>02303                 startDblClickTimer();
<a name="l02304"></a>02304                 ((DirectoryTreeModel) tree.getModel()).nodeChanged(node);
<a name="l02305"></a>02305                 <span class="keywordflow">if</span> (row == 0) {
<a name="l02306"></a>02306                     tree.revalidate();
<a name="l02307"></a>02307                     tree.repaint();
<a name="l02308"></a>02308                 }
<a name="l02309"></a>02309             }
<a name="l02310"></a>02310         }
<a name="l02311"></a>02311 
<a name="l02312"></a>02312         <span class="keyword">private</span> <span class="keywordtype">void</span> handleDblClick(DirectoryNode node) {
<a name="l02313"></a>02313             cancelRename();
<a name="l02314"></a>02314             cancelDblClick();
<a name="l02315"></a>02315 
<a name="l02316"></a>02316             <span class="keywordflow">if</span> (node.getFile().isFile() &amp;&amp; !node.getFile().getPath().endsWith(<span class="stringliteral">&quot;.lnk&quot;</span>)) {
<a name="l02317"></a>02317                 fileChooser.approveSelection();
<a name="l02318"></a>02318             }
<a name="l02319"></a>02319         }
<a name="l02320"></a>02320 
<a name="l02321"></a>02321         <span class="keyword">private</span> <span class="keywordtype">void</span> startDblClickTimer() {
<a name="l02322"></a>02322             cancelDblClick();
<a name="l02323"></a>02323             dblClickTimer = <span class="keyword">new</span> Timer(500, <span class="keyword">this</span>);
<a name="l02324"></a>02324             dblClickTimer.setRepeats(<span class="keyword">false</span>);
<a name="l02325"></a>02325             dblClickTimer.start();
<a name="l02326"></a>02326         }
<a name="l02327"></a>02327 
<a name="l02328"></a>02328         @Override
<a name="l02329"></a>02329         <span class="keyword">public</span> <span class="keywordtype">void</span> mousePressed(MouseEvent e) {
<a name="l02330"></a>02330             handlePopupMenu(e);
<a name="l02331"></a>02331         }
<a name="l02332"></a>02332 
<a name="l02333"></a>02333         @Override
<a name="l02334"></a>02334         <span class="keyword">public</span> <span class="keywordtype">void</span> mouseReleased(MouseEvent e) {
<a name="l02335"></a>02335             handlePopupMenu(e);
<a name="l02336"></a>02336         }
<a name="l02337"></a>02337 
<a name="l02338"></a>02338         <span class="keyword">private</span> <span class="keywordtype">void</span> handlePopupMenu(MouseEvent e) {
<a name="l02339"></a>02339             <span class="keywordflow">if</span> (!e.isPopupTrigger()) {
<a name="l02340"></a>02340                 <span class="keywordflow">return</span>;
<a name="l02341"></a>02341             }
<a name="l02342"></a>02342             <span class="keyword">final</span> JTree tree = (JTree) e.getSource();
<a name="l02343"></a>02343             <span class="keywordtype">int</span> x = e.getX();
<a name="l02344"></a>02344             <span class="keywordtype">int</span> y = e.getY();
<a name="l02345"></a>02345             <span class="keywordtype">int</span> row = tree.getRowForLocation(x, y);
<a name="l02346"></a>02346             TreePath path = tree.getPathForRow(row);
<a name="l02347"></a>02347 
<a name="l02348"></a>02348             <span class="keywordflow">if</span> (path != null) {
<a name="l02349"></a>02349                 DirectoryNode node = (DirectoryNode) path.getLastPathComponent();
<a name="l02350"></a>02350                 ((DirectoryTreeModel) tree.getModel()).nodeChanged(node);
<a name="l02351"></a>02351                 <span class="keywordflow">if</span> (!fileChooser.getFileSystemView().isFileSystem(node.getFile())) {
<a name="l02352"></a>02352                     <span class="keywordflow">return</span>;
<a name="l02353"></a>02353                 }
<a name="l02354"></a>02354 
<a name="l02355"></a>02355                 tree.setSelectionPath(path);
<a name="l02356"></a>02356                 popupMenu.show(tree, x, y);
<a name="l02357"></a>02357             }
<a name="l02358"></a>02358         }
<a name="l02359"></a>02359 
<a name="l02360"></a>02360         <span class="comment">/********** implementation of CellEditorListener ****************/</span>
<a name="l02361"></a>02361 
<a name="l02363"></a>02363         @Override
<a name="l02364"></a>02364         <span class="keyword">public</span> <span class="keywordtype">void</span> editingStopped(ChangeEvent e) {
<a name="l02365"></a>02365             DirectoryNode node = (DirectoryNode) tree.getLastSelectedPathComponent();
<a name="l02366"></a>02366             <span class="keywordflow">if</span> (node != null) {
<a name="l02367"></a>02367                 setFileName(getStringOfFileName(node.getFile()));
<a name="l02368"></a>02368             }
<a name="l02369"></a>02369         }
<a name="l02370"></a>02370 
<a name="l02371"></a>02371         @Override
<a name="l02372"></a>02372         <span class="keyword">public</span> <span class="keywordtype">void</span> editingCanceled(ChangeEvent e) {
<a name="l02373"></a>02373             <span class="comment">// no operation</span>
<a name="l02374"></a>02374         }
<a name="l02375"></a>02375 
<a name="l02376"></a>02376         <span class="comment">/********** ActionListener impl, slow-double-click rename ******/</span>
<a name="l02377"></a>02377 
<a name="l02378"></a>02378         @Override
<a name="l02379"></a>02379         <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l02380"></a>02380             <span class="keywordflow">if</span> (tree.isFocusOwner() &amp;&amp; isSelectionKept(pathToRename)) {
<a name="l02381"></a>02381                 <span class="keywordflow">if</span> (e.getSource() == renameTimer) {
<a name="l02382"></a>02382                     DirectoryNode node = (DirectoryNode) tree.getLastSelectedPathComponent();
<a name="l02383"></a>02383                     <span class="keywordflow">if</span> (node != null) {
<a name="l02384"></a>02384                         applyEdit(node);
<a name="l02385"></a>02385                     }
<a name="l02386"></a>02386                 }
<a name="l02387"></a>02387             }
<a name="l02388"></a>02388             <span class="comment">// clear</span>
<a name="l02389"></a>02389             <span class="keywordflow">if</span> (e.getSource() != dblClickTimer) {
<a name="l02390"></a>02390                 cancelRename();
<a name="l02391"></a>02391             }
<a name="l02392"></a>02392             cancelDblClick();
<a name="l02393"></a>02393         }
<a name="l02394"></a>02394 
<a name="l02395"></a>02395         <span class="keywordtype">void</span> preprocessMouseEvent(MouseEvent e) {
<a name="l02396"></a>02396             <span class="keywordflow">if</span> ((e.getID() != MouseEvent.MOUSE_PRESSED) || (e.getButton() != MouseEvent.BUTTON1)) {
<a name="l02397"></a>02397                 <span class="keywordflow">return</span>;
<a name="l02398"></a>02398             }
<a name="l02399"></a>02399             TreePath clickedPath = tree.getPathForLocation(e.getX(), e.getY());
<a name="l02400"></a>02400             <span class="keywordflow">if</span> (clickedPath != null &amp;&amp; isSelectionKept(clickedPath)) {
<a name="l02401"></a>02401                 pathToRename = clickedPath;
<a name="l02402"></a>02402             }
<a name="l02403"></a>02403         }
<a name="l02404"></a>02404 
<a name="l02405"></a>02405         <span class="keyword">private</span> <span class="keywordtype">boolean</span> isSelectionKept(TreePath selPath) {
<a name="l02406"></a>02406             <span class="keywordflow">if</span> (curSelPath != null) {
<a name="l02407"></a>02407                 TreePath oldSel = curSelPath.get();
<a name="l02408"></a>02408                 <span class="keywordflow">if</span> (oldSel != null &amp;&amp; oldSel.equals(selPath)) {
<a name="l02409"></a>02409                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02410"></a>02410                 }
<a name="l02411"></a>02411             }
<a name="l02412"></a>02412             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02413"></a>02413         }
<a name="l02414"></a>02414 
<a name="l02415"></a>02415         <span class="keyword">private</span> <span class="keywordtype">void</span> cancelRename() {
<a name="l02416"></a>02416             <span class="keywordflow">if</span> (renameTimer != null) {
<a name="l02417"></a>02417                 renameTimer.stop();
<a name="l02418"></a>02418                 renameTimer = null;
<a name="l02419"></a>02419             }
<a name="l02420"></a>02420             pathToRename = null;
<a name="l02421"></a>02421         }
<a name="l02422"></a>02422 
<a name="l02423"></a>02423         <span class="keyword">private</span> <span class="keywordtype">void</span> cancelDblClick() {
<a name="l02424"></a>02424             Timer t = dblClickTimer;
<a name="l02425"></a>02425             <span class="keywordflow">if</span> (t != null) {
<a name="l02426"></a>02426                 t.stop();
<a name="l02427"></a>02427                 dblClickTimer = null;
<a name="l02428"></a>02428             }
<a name="l02429"></a>02429         }
<a name="l02430"></a>02430 
<a name="l02431"></a>02431         <span class="comment">/******** implementation of focus listener, for slow click rename cancelling ******/</span>
<a name="l02432"></a>02432 
<a name="l02433"></a>02433         @Override
<a name="l02434"></a>02434         <span class="keyword">public</span> <span class="keywordtype">void</span> focusGained(FocusEvent e) {
<a name="l02435"></a>02435             <span class="comment">// don&#39;t allow to invoke click to rename immediatelly after focus</span>
<a name="l02436"></a>02436             <span class="comment">// gain</span>
<a name="l02437"></a>02437             <span class="comment">// what may happen is that tree gains focus by mouse</span>
<a name="l02438"></a>02438             <span class="comment">// click on selected item - on some platforms selected item</span>
<a name="l02439"></a>02439             <span class="comment">// is not visible without focus and click to rename will</span>
<a name="l02440"></a>02440             <span class="comment">// be unwanted and surprising for users</span>
<a name="l02441"></a>02441 
<a name="l02442"></a>02442             <span class="comment">// see run method</span>
<a name="l02443"></a>02443             SwingUtilities.invokeLater(<span class="keyword">this</span>);
<a name="l02444"></a>02444         }
<a name="l02445"></a>02445 
<a name="l02446"></a>02446         @Override
<a name="l02447"></a>02447         <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l02448"></a>02448             cancelRename();
<a name="l02449"></a>02449         }
<a name="l02450"></a>02450 
<a name="l02451"></a>02451         @Override
<a name="l02452"></a>02452         <span class="keyword">public</span> <span class="keywordtype">void</span> focusLost(FocusEvent e) {
<a name="l02453"></a>02453             cancelRename();
<a name="l02454"></a>02454         }
<a name="l02455"></a>02455 
<a name="l02456"></a>02456     }
<a name="l02457"></a>02457 
<a name="l02458"></a>02458     <span class="keyword">private</span> <span class="keyword">class </span>TreeExpansionHandler <span class="keyword">implements</span> TreeExpansionListener {
<a name="l02459"></a>02459         @Override
<a name="l02460"></a>02460         <span class="keyword">public</span> <span class="keywordtype">void</span> treeExpanded(TreeExpansionEvent evt) {
<a name="l02461"></a>02461             TreePath path = evt.getPath();
<a name="l02462"></a>02462             DirectoryNode node = (DirectoryNode) path.getLastPathComponent();
<a name="l02463"></a>02463             <span class="keywordflow">if</span> (!node.isLoaded()) {
<a name="l02464"></a>02464                 expandNode(fileChooser, path);
<a name="l02465"></a>02465             } <span class="keywordflow">else</span> {
<a name="l02466"></a>02466                 <span class="comment">// fixed #96954, to be able to add a new directory</span>
<a name="l02467"></a>02467                 <span class="comment">// when the node has been already loaded</span>
<a name="l02468"></a>02468                 <span class="keywordflow">if</span> (addNewDirectory) {
<a name="l02469"></a>02469                     addNewDirectory(path);
<a name="l02470"></a>02470                     addNewDirectory = <span class="keyword">false</span>;
<a name="l02471"></a>02471                 }
<a name="l02472"></a>02472                 <span class="comment">// Fix for IZ#123815 : Cannot refresh the tree content</span>
<a name="l02473"></a>02473                 refreshNode(path, node);
<a name="l02474"></a>02474             }
<a name="l02475"></a>02475         }
<a name="l02476"></a>02476 
<a name="l02477"></a>02477         @Override
<a name="l02478"></a>02478         <span class="keyword">public</span> <span class="keywordtype">void</span> treeCollapsed(TreeExpansionEvent event) {
<a name="l02479"></a>02479         }
<a name="l02480"></a>02480 
<a name="l02481"></a>02481     }
<a name="l02482"></a>02482 
<a name="l02483"></a>02483     <span class="comment">// Fix for IZ#123815 : Cannot refresh the tree content</span>
<a name="l02484"></a>02484     <span class="keyword">private</span> <span class="keywordtype">void</span> refreshNode(<span class="keyword">final</span> TreePath path, <span class="keyword">final</span> DirectoryNode node) {
<a name="l02485"></a>02485         <span class="keyword">final</span> File folder = node.getFile();
<a name="l02486"></a>02486 
<a name="l02487"></a>02487         <span class="comment">// Additional fixes for IZ#116859 [60cat] Node update bug in the</span>
<a name="l02488"></a>02488         <span class="comment">// &quot;open project&quot; panel while deleting directories</span>
<a name="l02489"></a>02489         <span class="keywordflow">if</span> (!folder.exists()) {
<a name="l02490"></a>02490             TreePath parentPath = path.getParentPath();
<a name="l02491"></a>02491             <span class="keywordtype">boolean</span> refreshTree = <span class="keyword">false</span>;
<a name="l02492"></a>02492 
<a name="l02493"></a>02493             <span class="keywordflow">if</span> (tree.isExpanded(path)) {
<a name="l02494"></a>02494                 tree.collapsePath(path);
<a name="l02495"></a>02495                 refreshTree = <span class="keyword">true</span>;
<a name="l02496"></a>02496             }
<a name="l02497"></a>02497             model.removeNodeFromParent(node);
<a name="l02498"></a>02498             <span class="keywordflow">if</span> (refreshTree) {
<a name="l02499"></a>02499                 tree.expandPath(parentPath);
<a name="l02500"></a>02500             }
<a name="l02501"></a>02501             <span class="keywordflow">return</span>;
<a name="l02502"></a>02502         }
<a name="l02503"></a>02503 
<a name="l02504"></a>02504         RequestProcessor.getDefault().post(<span class="keyword">new</span> Runnable() {
<a name="l02505"></a>02505             <span class="keyword">private</span> Set&lt;String&gt; realDirs;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507             @Override
<a name="l02508"></a>02508             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l02509"></a>02509                 <span class="keywordflow">if</span> (!EventQueue.isDispatchThread()) {
<a name="l02510"></a>02510                     <span class="comment">// first phase</span>
<a name="l02511"></a>02511                     realDirs = <span class="keyword">new</span> HashSet&lt;String&gt;();
<a name="l02512"></a>02512                     File[] files = folder.listFiles();
<a name="l02513"></a>02513                     files = files == null ? <span class="keyword">new</span> File[0] : files;
<a name="l02514"></a>02514                     <span class="keywordflow">for</span> (File file : files) {
<a name="l02515"></a>02515                         <span class="keywordflow">if</span> (!file.isDirectory()) {
<a name="l02516"></a>02516                             <span class="keywordflow">continue</span>;
<a name="l02517"></a>02517                         }
<a name="l02518"></a>02518                         String name = file.getName();
<a name="l02519"></a>02519                         realDirs.add(name);
<a name="l02520"></a>02520                     }
<a name="l02521"></a>02521                     SwingUtilities.invokeLater(<span class="keyword">this</span>);
<a name="l02522"></a>02522                 } <span class="keywordflow">else</span> {
<a name="l02523"></a>02523                     <span class="comment">// second phase, in EQ thread, invoked from first phase</span>
<a name="l02524"></a>02524                     <span class="keywordtype">int</span> count = node.getChildCount();
<a name="l02525"></a>02525                     Map&lt;String, DirectoryNode&gt; currentFiles = <span class="keyword">new</span> HashMap&lt;String, DirectoryNode&gt;();
<a name="l02526"></a>02526                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; i++) {
<a name="l02527"></a>02527                         TreeNode child = node.getChildAt(i);
<a name="l02528"></a>02528                         <span class="keywordflow">if</span> (child instanceof DirectoryNode) {
<a name="l02529"></a>02529                             File file = ((DirectoryNode) child).getFile();
<a name="l02530"></a>02530                             currentFiles.put(file.getName(), (DirectoryNode) child);
<a name="l02531"></a>02531                         }
<a name="l02532"></a>02532                     }
<a name="l02533"></a>02533 
<a name="l02534"></a>02534                     Set&lt;String&gt; realCloned = <span class="keyword">new</span> HashSet&lt;String&gt;(realDirs);
<a name="l02535"></a>02535                     <span class="keywordflow">if</span> (realCloned.removeAll(currentFiles.keySet())) {
<a name="l02536"></a>02536                         <span class="comment">// Handle added folders</span>
<a name="l02537"></a>02537                         <span class="keywordflow">for</span> (String name : realCloned) {
<a name="l02538"></a>02538                             DirectoryNode added = <span class="keyword">new</span> DirectoryNode(getFileChooser().getFileSystemView().createFileObject(folder, name));
<a name="l02539"></a>02539                             model.insertNodeInto(added, node, node.getChildCount());
<a name="l02540"></a>02540                         }
<a name="l02541"></a>02541                     }
<a name="l02542"></a>02542                     Set&lt;String&gt; currentNames = <span class="keyword">new</span> HashSet&lt;String&gt;(currentFiles.keySet());
<a name="l02543"></a>02543                     <span class="keywordflow">if</span> (currentNames.removeAll(realDirs)) {
<a name="l02544"></a>02544                         <span class="comment">// Handle deleted folders</span>
<a name="l02545"></a>02545                         <span class="keywordflow">for</span> (String name : currentNames) {
<a name="l02546"></a>02546                             DirectoryNode removed = currentFiles.get(name);
<a name="l02547"></a>02547                             model.removeNodeFromParent(removed);
<a name="l02548"></a>02548                         }
<a name="l02549"></a>02549                     }
<a name="l02550"></a>02550                 }
<a name="l02551"></a>02551             }
<a name="l02552"></a>02552         });
<a name="l02553"></a>02553     }
<a name="l02554"></a>02554 
<a name="l02555"></a>02555     <span class="keyword">private</span> <span class="keyword">class </span>NewDirectoryAction <span class="keyword">extends</span> AbstractAction {
<a name="l02556"></a>02556         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l02557"></a>02557 
<a name="l02558"></a>02558         @Override
<a name="l02559"></a>02559         <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
<a name="l02560"></a>02560             <span class="keyword">final</span> TreePath path = tree.getSelectionPath();
<a name="l02561"></a>02561 
<a name="l02562"></a>02562             <span class="keywordflow">if</span> (path == null) {
<a name="l02563"></a>02563                 <span class="comment">// if no nodes are selected, get the root node</span>
<a name="l02564"></a>02564                 <span class="comment">// fixed #96954, to be able to add a new directory</span>
<a name="l02565"></a>02565                 <span class="comment">// in the current directory shown in the tree</span>
<a name="l02566"></a>02566                 addNewDirectory(<span class="keyword">new</span> TreePath(model.getPathToRoot((DirectoryNode) tree.getModel().getRoot())));
<a name="l02567"></a>02567             }
<a name="l02568"></a>02568 
<a name="l02569"></a>02569             <span class="keywordflow">if</span> (path != null) {
<a name="l02570"></a>02570                 <span class="keywordflow">if</span> (tree.isExpanded(path)) {
<a name="l02571"></a>02571                     addNewDirectory(path);
<a name="l02572"></a>02572                 } <span class="keywordflow">else</span> {
<a name="l02573"></a>02573                     addNewDirectory = <span class="keyword">true</span>;
<a name="l02574"></a>02574                     tree.expandPath(path);
<a name="l02575"></a>02575                 }
<a name="l02576"></a>02576             }
<a name="l02577"></a>02577         }
<a name="l02578"></a>02578     }
<a name="l02579"></a>02579 
<a name="l02580"></a>02580     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryTreeRenderer <span class="keyword">implements</span> TreeCellRenderer {
<a name="l02581"></a>02581         DefaultTreeCellRenderer renderer = <span class="keyword">new</span> DefaultTreeCellRenderer();
<a name="l02582"></a>02582 
<a name="l02583"></a>02583         @Override
<a name="l02584"></a>02584         <span class="keyword">public</span> Component getTreeCellRendererComponent(JTree tree, Object value, <span class="keywordtype">boolean</span> isSelected, <span class="keywordtype">boolean</span> expanded, <span class="keywordtype">boolean</span> leaf, <span class="keywordtype">int</span> row, <span class="keywordtype">boolean</span> hasFocus) {
<a name="l02585"></a>02585 
<a name="l02586"></a>02586             Component stringDisplayer = renderer.getTreeCellRendererComponent(tree, value, isSelected, expanded, leaf, row, hasFocus);
<a name="l02587"></a>02587 
<a name="l02588"></a>02588             <span class="keywordflow">if</span> (value instanceof DirectoryNode) {
<a name="l02589"></a>02589                 tree.setShowsRootHandles(<span class="keyword">true</span>);
<a name="l02590"></a>02590                 DirectoryNode node = (DirectoryNode) value;
<a name="l02591"></a>02591                 ((JLabel) stringDisplayer).setIcon(getNodeIcon(node));
<a name="l02592"></a>02592                 ((JLabel) stringDisplayer).setText(getNodeText(node));
<a name="l02593"></a>02593             }
<a name="l02594"></a>02594             stringDisplayer.setPreferredSize(<span class="keyword">new</span> Dimension(stringDisplayer.getPreferredSize().width, 30));
<a name="l02595"></a>02595 
<a name="l02596"></a>02596             <span class="comment">// allow some space around icon of items</span>
<a name="l02597"></a>02597             ((JComponent) stringDisplayer).setBorder(BorderFactory.createEmptyBorder(1, 0, 1, 0));
<a name="l02598"></a>02598             stringDisplayer.setSize(stringDisplayer.getPreferredSize());
<a name="l02599"></a>02599 
<a name="l02600"></a>02600             <span class="keywordflow">return</span> stringDisplayer;
<a name="l02601"></a>02601         }
<a name="l02602"></a>02602 
<a name="l02603"></a>02603         <span class="keyword">private</span> Icon getNodeIcon(DirectoryNode node) {
<a name="l02604"></a>02604             <span class="keywordflow">return</span> node.getIcon(fileChooser);
<a name="l02605"></a>02605         }
<a name="l02606"></a>02606 
<a name="l02607"></a>02607         <span class="keyword">private</span> String getNodeText(DirectoryNode node) {
<a name="l02608"></a>02608             <span class="keywordflow">return</span> node.getText(fileChooser);
<a name="l02609"></a>02609         }
<a name="l02610"></a>02610     }
<a name="l02611"></a>02611 
<a name="l02612"></a>02612     <span class="keyword">private</span> <span class="keyword">class </span>DirectoryTreeModel <span class="keyword">extends</span> DefaultTreeModel {
<a name="l02613"></a>02613         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l02614"></a>02614 
<a name="l02615"></a>02615         <span class="keyword">public</span> DirectoryTreeModel(TreeNode root) {
<a name="l02616"></a>02616             super(root);
<a name="l02617"></a>02617         }
<a name="l02618"></a>02618 
<a name="l02619"></a>02619         @Override
<a name="l02620"></a>02620         <span class="keyword">public</span> <span class="keywordtype">void</span> valueForPathChanged(TreePath path, Object newValue) {
<a name="l02621"></a>02621             <span class="keywordtype">boolean</span> refreshTree = <span class="keyword">false</span>;
<a name="l02622"></a>02622             DirectoryNode node = (DirectoryNode) path.getLastPathComponent();
<a name="l02623"></a>02623             File f = node.getFile();
<a name="l02624"></a>02624             File newFile = getFileChooser().getFileSystemView().createFileObject(f.getParentFile(), (String) newValue);
<a name="l02625"></a>02625 
<a name="l02626"></a>02626             <span class="keywordflow">if</span> (f.renameTo(newFile)) {
<a name="l02627"></a>02627                 <span class="comment">// fix bug #97521, #96960</span>
<a name="l02628"></a>02628                 <span class="keywordflow">if</span> (tree.isExpanded(path)) {
<a name="l02629"></a>02629                     tree.collapsePath(path);
<a name="l02630"></a>02630                     refreshTree = <span class="keyword">true</span>;
<a name="l02631"></a>02631                 }
<a name="l02632"></a>02632 
<a name="l02633"></a>02633                 node.setFile(newFile);
<a name="l02634"></a>02634                 node.removeAllChildren();
<a name="l02635"></a>02635 
<a name="l02636"></a>02636                 ((DefaultTreeModel) tree.getModel()).nodeStructureChanged(node);
<a name="l02637"></a>02637                 <span class="keywordflow">if</span> (refreshTree) {
<a name="l02638"></a>02638                     tree.expandPath(path);
<a name="l02639"></a>02639                 }
<a name="l02640"></a>02640             }
<a name="l02641"></a>02641         }
<a name="l02642"></a>02642     }
<a name="l02643"></a>02643 
<a name="l02644"></a>02644     <span class="keyword">private</span> <span class="keyword">class </span>UpdateWorker <span class="keyword">implements</span> Runnable {
<a name="l02645"></a>02645         <span class="keyword">private</span> <span class="keyword">volatile</span> String lastUpdatePathName = null;
<a name="l02646"></a>02646         <span class="keyword">private</span> DirectoryChooserUI ui;
<a name="l02647"></a>02647         <span class="keyword">private</span> <span class="keyword">volatile</span> File work;
<a name="l02648"></a>02648 
<a name="l02649"></a>02649         <span class="keyword">public</span> <span class="keywordtype">void</span> updateTree(<span class="keyword">final</span> File file) {
<a name="l02650"></a>02650             work = file;
<a name="l02651"></a>02651             RP.post(<span class="keyword">this</span>);
<a name="l02652"></a>02652         }
<a name="l02653"></a>02653 
<a name="l02654"></a>02654         <span class="keyword">public</span> <span class="keywordtype">void</span> attachFileChooser(<span class="keyword">final</span> DirectoryChooserUI ui) {
<a name="l02655"></a>02655             this.ui = ui;
<a name="l02656"></a>02656             this.lastUpdatePathName = null;
<a name="l02657"></a>02657         }
<a name="l02658"></a>02658 
<a name="l02659"></a>02659         @Override
<a name="l02660"></a>02660         <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l02661"></a>02661             assert !EventQueue.isDispatchThread();
<a name="l02662"></a>02662             File file = work;
<a name="l02663"></a>02663             <span class="keywordflow">if</span> (file == null) {
<a name="l02664"></a>02664                 <span class="keywordflow">return</span>;
<a name="l02665"></a>02665             }
<a name="l02666"></a>02666             <span class="keywordflow">if</span> (lastUpdatePathName != null &amp;&amp; lastUpdatePathName.equals(file.getPath())) {
<a name="l02667"></a>02667                 restoreCursor();
<a name="l02668"></a>02668                 <span class="keywordflow">return</span>;
<a name="l02669"></a>02669             }
<a name="l02670"></a>02670             lastUpdatePathName = file.getPath();
<a name="l02671"></a>02671             ui.markStartTime();
<a name="l02672"></a>02672             ui.setCursor(fileChooser, Cursor.WAIT_CURSOR);
<a name="l02673"></a>02673             <span class="keyword">final</span> DirectoryNode node = <span class="keyword">new</span> DirectoryNode(file);
<a name="l02674"></a>02674             node.loadChildren(fileChooser, <span class="keyword">true</span>);
<a name="l02675"></a>02675 
<a name="l02676"></a>02676             <span class="comment">// update UI in EQ thread</span>
<a name="l02677"></a>02677             SwingUtilities.invokeLater(<span class="keyword">new</span> Runnable() {
<a name="l02678"></a>02678                 @Override
<a name="l02679"></a>02679                 <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l02680"></a>02680                     ui.model = <span class="keyword">new</span> DirectoryTreeModel(node);
<a name="l02681"></a>02681                     tree.setModel(ui.model);
<a name="l02682"></a>02682                     tree.repaint();
<a name="l02683"></a>02683                     ui.checkUpdate();
<a name="l02684"></a>02684                     restoreCursor();
<a name="l02685"></a>02685                 }
<a name="l02686"></a>02686             });
<a name="l02687"></a>02687         }
<a name="l02688"></a>02688 
<a name="l02689"></a>02689         <span class="keyword">private</span> <span class="keywordtype">void</span> restoreCursor() {
<a name="l02690"></a>02690             ui.setCursor(fileChooser, Cursor.DEFAULT_CURSOR);
<a name="l02691"></a>02691         }
<a name="l02692"></a>02692 
<a name="l02693"></a>02693     } <span class="comment">// end of UpdateWorker</span>
<a name="l02694"></a>02694 
<a name="l02695"></a>02695 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>DirectoryChooserUI.java</b>      </li>
      <li class="footer">Erzeugt am Thu Jun 7 2012 22:12:14 für (AB)² Simulation von&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Alle</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Klassen</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namensbereiche</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Funktionen</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variablen</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Aufzählungen</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
