<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>(AB)² Simulation: /home/andreas/git/SimulationBA/NetbeansDirchooser/src/org/openide/util/RequestProcessor.java Quellcode</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Erzeugt von Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Suchen');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="simulation.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">(AB)² Simulation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Hauptseite</span></a></li>
      <li><a href="pages.html"><span>Zusätzliche&#160;Informationen</span></a></li>
      <li><a href="namespaces.html"><span>Pakete</span></a></li>
      <li><a href="annotated.html"><span>Klassen</span></a></li>
      <li class="current"><a href="files.html"><span>Dateien</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Suchen" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Auflistung&#160;der&#160;Dateien</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_request_processor_8java.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>/home/andreas/git/SimulationBA/NetbeansDirchooser/src/org/openide/util/RequestProcessor.java</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright 1997-2010 Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Oracle and Java are registered trademarks of Oracle and/or its affiliates.</span>
<a name="l00007"></a>00007 <span class="comment"> * Other names may be trademarks of their respective owners.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * The contents of this file are subject to the terms of either the GNU</span>
<a name="l00010"></a>00010 <span class="comment"> * General Public License Version 2 only (&quot;GPL&quot;) or the Common</span>
<a name="l00011"></a>00011 <span class="comment"> * Development and Distribution License(&quot;CDDL&quot;) (collectively, the</span>
<a name="l00012"></a>00012 <span class="comment"> * &quot;License&quot;). You may not use this file except in compliance with the</span>
<a name="l00013"></a>00013 <span class="comment"> * License. You can obtain a copy of the License at</span>
<a name="l00014"></a>00014 <span class="comment"> * http://www.netbeans.org/cddl-gplv2.html</span>
<a name="l00015"></a>00015 <span class="comment"> * or nbbuild/licenses/CDDL-GPL-2-CP. See the License for the</span>
<a name="l00016"></a>00016 <span class="comment"> * specific language governing permissions and limitations under the</span>
<a name="l00017"></a>00017 <span class="comment"> * License.  When distributing the software, include this License Header</span>
<a name="l00018"></a>00018 <span class="comment"> * Notice in each file and include the License file at</span>
<a name="l00019"></a>00019 <span class="comment"> * nbbuild/licenses/CDDL-GPL-2-CP.  Oracle designates this</span>
<a name="l00020"></a>00020 <span class="comment"> * particular file as subject to the &quot;Classpath&quot; exception as provided</span>
<a name="l00021"></a>00021 <span class="comment"> * by Oracle in the GPL Version 2 section of the License file that</span>
<a name="l00022"></a>00022 <span class="comment"> * accompanied this code. If applicable, add the following below the</span>
<a name="l00023"></a>00023 <span class="comment"> * License Header, with the fields enclosed by brackets [] replaced by</span>
<a name="l00024"></a>00024 <span class="comment"> * your own identifying information:</span>
<a name="l00025"></a>00025 <span class="comment"> * &quot;Portions Copyrighted [year] [name of copyright owner]&quot;</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * Contributor(s):</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * The Original Software is NetBeans. The Initial Developer of the Original</span>
<a name="l00030"></a>00030 <span class="comment"> * Software is Sun Microsystems, Inc. Portions Copyright 1997-2006 Sun</span>
<a name="l00031"></a>00031 <span class="comment"> * Microsystems, Inc. All Rights Reserved.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * If you wish your version of this file to be governed by only the CDDL</span>
<a name="l00034"></a>00034 <span class="comment"> * or only the GPL Version 2, indicate your decision by adding</span>
<a name="l00035"></a>00035 <span class="comment"> * &quot;[Contributor] elects to include this software in this distribution</span>
<a name="l00036"></a>00036 <span class="comment"> * under the [CDDL or GPL Version 2] license.&quot; If you do not indicate a</span>
<a name="l00037"></a>00037 <span class="comment"> * single choice of license, a recipient has the option to distribute</span>
<a name="l00038"></a>00038 <span class="comment"> * your version of this file under either the CDDL, the GPL Version 2 or</span>
<a name="l00039"></a>00039 <span class="comment"> * to extend the choice of license to its licensees as provided above.</span>
<a name="l00040"></a>00040 <span class="comment"> * However, if you add GPL Version 2 code and therefore, elected the GPL</span>
<a name="l00041"></a>00041 <span class="comment"> * Version 2 license, then the option applies only if the new code is</span>
<a name="l00042"></a>00042 <span class="comment"> * made subject to such option by the copyright holder.</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keyword">package </span>org.openide.util;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">import</span> java.lang.reflect.Method;
<a name="l00048"></a>00048 <span class="keyword">import</span> java.util.ArrayList;
<a name="l00049"></a>00049 <span class="keyword">import</span> java.util.Arrays;
<a name="l00050"></a>00050 <span class="keyword">import</span> java.util.Collection;
<a name="l00051"></a>00051 <span class="keyword">import</span> java.util.Collections;
<a name="l00052"></a>00052 <span class="keyword">import</span> java.util.Comparator;
<a name="l00053"></a>00053 <span class="keyword">import</span> java.util.HashSet;
<a name="l00054"></a>00054 <span class="keyword">import</span> java.util.LinkedList;
<a name="l00055"></a>00055 <span class="keyword">import</span> java.util.List;
<a name="l00056"></a>00056 <span class="keyword">import</span> java.util.ListIterator;
<a name="l00057"></a>00057 <span class="keyword">import</span> java.util.Map;
<a name="l00058"></a>00058 <span class="keyword">import</span> java.util.PriorityQueue;
<a name="l00059"></a>00059 <span class="keyword">import</span> java.util.Set;
<a name="l00060"></a>00060 <span class="keyword">import</span> java.util.Stack;
<a name="l00061"></a>00061 <span class="keyword">import</span> java.util.WeakHashMap;
<a name="l00062"></a>00062 <span class="keyword">import</span> java.util.concurrent.Callable;
<a name="l00063"></a>00063 <span class="keyword">import</span> java.util.concurrent.CancellationException;
<a name="l00064"></a>00064 <span class="keyword">import</span> java.util.concurrent.CountDownLatch;
<a name="l00065"></a>00065 <span class="keyword">import</span> java.util.concurrent.Delayed;
<a name="l00066"></a>00066 <span class="keyword">import</span> java.util.concurrent.ExecutionException;
<a name="l00067"></a>00067 <span class="keyword">import</span> java.util.concurrent.Executor;
<a name="l00068"></a>00068 <span class="keyword">import</span> java.util.concurrent.Future;
<a name="l00069"></a>00069 <span class="keyword">import</span> java.util.concurrent.FutureTask;
<a name="l00070"></a>00070 <span class="keyword">import</span> java.util.concurrent.RejectedExecutionException;
<a name="l00071"></a>00071 <span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;
<a name="l00072"></a>00072 <span class="keyword">import</span> java.util.concurrent.ScheduledFuture;
<a name="l00073"></a>00073 <span class="keyword">import</span> java.util.concurrent.TimeUnit;
<a name="l00074"></a>00074 <span class="keyword">import</span> java.util.concurrent.TimeoutException;
<a name="l00075"></a>00075 <span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;
<a name="l00076"></a>00076 <span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;
<a name="l00077"></a>00077 <span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;
<a name="l00078"></a>00078 <span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;
<a name="l00079"></a>00079 <span class="keyword">import</span> java.util.logging.Level;
<a name="l00080"></a>00080 <span class="keyword">import</span> java.util.logging.Logger;
<a name="l00081"></a>00081 
<a name="l00188"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">00188</a> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class </span><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a> <span class="keyword">implements</span> ScheduledExecutorService {
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keyword">static</span> {
<a name="l00191"></a>00191         Processor.class.hashCode(); <span class="comment">// ensure loaded; cf. FELIX-2128</span>
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00195"></a>00195     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a> DEFAULT = <span class="keyword">new</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a53404ac6d321a0f3856a594b80ef9aa4">RequestProcessor</a>();
<a name="l00196"></a>00196 
<a name="l00198"></a>00198     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a178c96a4d305e683e0c6337e1773bf47">logger</a> = Logger.getLogger(<span class="stringliteral">&quot;org.openide.util.RequestProcessor&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l00199"></a>00199 
<a name="l00201"></a>00201     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a> UNLIMITED;
<a name="l00203"></a>00203     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> counter = 0;
<a name="l00204"></a>00204     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">boolean</span> SLOW;
<a name="l00205"></a>00205     <span class="keyword">static</span> {
<a name="l00206"></a>00206         <span class="keywordtype">boolean</span> slow = <span class="keyword">false</span>;
<a name="l00207"></a>00207         assert slow = <span class="keyword">true</span>;
<a name="l00208"></a>00208         SLOW = slow;
<a name="l00209"></a>00209         <span class="comment">// 50: a conservative value, just for case of misuse</span>
<a name="l00210"></a>00210         UNLIMITED = <span class="keyword">new</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a53404ac6d321a0f3856a594b80ef9aa4">RequestProcessor</a>(<span class="stringliteral">&quot;Default RequestProcessor&quot;</span>, 50, <span class="keyword">false</span>, SLOW, SLOW ? 3 : 0); <span class="comment">// NOI18N</span>
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212 
<a name="l00214"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">00214</a>     String <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>;
<a name="l00215"></a>00215 
<a name="l00218"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae63a217ef7812afa58939db052cdd8cc">00218</a>     <span class="keyword">volatile</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae63a217ef7812afa58939db052cdd8cc">stopped</a> = <span class="keyword">false</span>;
<a name="l00219"></a>00219     
<a name="l00222"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a1b8702c1abb65daf7dc1ac7aada89711">00222</a>     <span class="keyword">volatile</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a1b8702c1abb65daf7dc1ac7aada89711">finishAwaitingTasks</a> = <span class="keyword">false</span>;
<a name="l00223"></a>00223 
<a name="l00226"></a>00226     <span class="keyword">private</span> <span class="keyword">final</span> Object processorLock = <span class="keyword">new</span> Object();
<a name="l00227"></a>00227 
<a name="l00229"></a>00229     <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Processor&gt; processors = <span class="keyword">new</span> HashSet&lt;Processor&gt;();
<a name="l00230"></a>00230 
<a name="l00236"></a>00236     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Item&gt; queue = <span class="keyword">new</span> LinkedList&lt;Item&gt;();
<a name="l00237"></a>00237 
<a name="l00241"></a>00241     <span class="keyword">private</span> <span class="keywordtype">int</span> running = 0;
<a name="l00242"></a>00242 
<a name="l00245"></a>00245     <span class="keyword">private</span> <span class="keywordtype">int</span> throughput;
<a name="l00247"></a>00247     <span class="keyword">private</span> Map&lt;Class&lt;? extends Runnable&gt;,AtomicInteger&gt; inParallel;
<a name="l00249"></a>00249     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keywordtype">int</span> warnParallel;
<a name="l00250"></a>00250     
<a name="l00252"></a>00252     <span class="keyword">private</span> <span class="keywordtype">boolean</span> interruptThread;
<a name="l00254"></a>00254     <span class="keyword">private</span> <span class="keywordtype">boolean</span> enableStackTraces;
<a name="l00255"></a>00255 
<a name="l00257"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a53404ac6d321a0f3856a594b80ef9aa4">00257</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a53404ac6d321a0f3856a594b80ef9aa4">RequestProcessor</a>() {
<a name="l00258"></a>00258         <span class="keyword">this</span>(null, 1);
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00263"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a9d0c3d8dec05ff01ec1ccc07fe828df7">00263</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a9d0c3d8dec05ff01ec1ccc07fe828df7">RequestProcessor</a>(String <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>) {
<a name="l00264"></a>00264         <span class="keyword">this</span>(<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, 1);
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266 
<a name="l00280"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aa316eb71748105e93d82f1582c04d745">00280</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aa316eb71748105e93d82f1582c04d745">RequestProcessor</a>(Class&lt;?&gt; forClass) {
<a name="l00281"></a>00281         <span class="keyword">this</span>(forClass.getName());
<a name="l00282"></a>00282     }
<a name="l00283"></a>00283 
<a name="l00290"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a7b81d3df9c3c9ae4e6e16d928f38f96a">00290</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a7b81d3df9c3c9ae4e6e16d928f38f96a">RequestProcessor</a>(String <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, <span class="keywordtype">int</span> throughput) {
<a name="l00291"></a>00291         <span class="keyword">this</span>(<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, throughput, <span class="keyword">false</span>);
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293 
<a name="l00319"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#abb1bc7f167d77d279a95a38fb627af11">00319</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#abb1bc7f167d77d279a95a38fb627af11">RequestProcessor</a>(String <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, <span class="keywordtype">int</span> throughput, <span class="keywordtype">boolean</span> interruptThread) {
<a name="l00320"></a>00320         <span class="keyword">this</span>(<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, throughput, interruptThread, SLOW);
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00341"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#adcbeed6a5b1f985258d08cc4ee236b9e">00341</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#adcbeed6a5b1f985258d08cc4ee236b9e">RequestProcessor</a>(String <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, <span class="keywordtype">int</span> throughput, <span class="keywordtype">boolean</span> interruptThread, <span class="keywordtype">boolean</span> enableStackTraces) {
<a name="l00342"></a>00342         <span class="keyword">this</span>(<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, throughput, interruptThread, enableStackTraces, 0);
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="keyword">private</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a53404ac6d321a0f3856a594b80ef9aa4">RequestProcessor</a>(String <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a12a3e6df94b34ac806b8cc43e29d271b">name</a>, <span class="keywordtype">int</span> throughput, <span class="keywordtype">boolean</span> interruptThread, <span class="keywordtype">boolean</span> enableStackTraces, <span class="keywordtype">int</span> warnParallel) {
<a name="l00346"></a>00346         this.throughput = throughput;
<a name="l00347"></a>00347         this.name = (name != null) ? name : (<span class="stringliteral">&quot;OpenIDE-request-processor-&quot;</span> + (counter++));
<a name="l00348"></a>00348         this.interruptThread = interruptThread;
<a name="l00349"></a>00349         this.enableStackTraces = enableStackTraces;
<a name="l00350"></a>00350         this.warnParallel = warnParallel;
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     
<a name="l00402"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a2c1439d990fbcb839595359a052b100a">00402</a>     <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a2c1439d990fbcb839595359a052b100a">getDefault</a>() {
<a name="l00403"></a>00403         <span class="keywordflow">return</span> UNLIMITED;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405 
<a name="l00411"></a>00411     @Override
<a name="l00412"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a69d6ae971b799790400e2d7a54c5c290">00412</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a69d6ae971b799790400e2d7a54c5c290">execute</a>(Runnable command) {
<a name="l00413"></a>00413         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(command);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415     
<a name="l00422"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">00422</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(Runnable run) {
<a name="l00423"></a>00423         <span class="keywordflow">return</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(run, 0, Thread.MIN_PRIORITY);
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00433"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae309af036a79eb01c40fb65556321c2c">00433</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae309af036a79eb01c40fb65556321c2c">post</a>(<span class="keyword">final</span> Runnable run, <span class="keywordtype">int</span> timeToWait) {
<a name="l00434"></a>00434         <span class="keywordflow">return</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(run, timeToWait, Thread.MIN_PRIORITY);
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436 
<a name="l00450"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#abbde92635bff4d88b1ecde059c945708">00450</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#abbde92635bff4d88b1ecde059c945708">post</a>(<span class="keyword">final</span> Runnable run, <span class="keywordtype">int</span> timeToWait, <span class="keywordtype">int</span> priority) {
<a name="l00451"></a>00451         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>.Task task = <span class="keyword">new</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a>(run, priority);
<a name="l00452"></a>00452         task.schedule(timeToWait);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="keywordflow">return</span> task;
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 
<a name="l00466"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acfe8a3bcca7e5767bbf5b1d2623b7919">00466</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acfe8a3bcca7e5767bbf5b1d2623b7919">create</a>(Runnable run) {
<a name="l00467"></a>00467         <span class="keywordflow">return</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acfe8a3bcca7e5767bbf5b1d2623b7919">create</a>(run, <span class="keyword">false</span>);
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469     
<a name="l00481"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a881e19d2e817cb4da307549794c5933f">00481</a>     <span class="keyword">public</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a881e19d2e817cb4da307549794c5933f">create</a>(Runnable run, <span class="keywordtype">boolean</span> initiallyFinished) {
<a name="l00482"></a>00482         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> t = <span class="keyword">new</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a>(run);
<a name="l00483"></a>00483         t.markCreated();
<a name="l00484"></a>00484         <span class="keywordflow">if</span> (initiallyFinished) {
<a name="l00485"></a>00485             t.<a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#af31e5ee8dda43bae9a6d2fc48569448d">notifyFinished</a>();
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487         <span class="keywordflow">return</span> t;
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489     
<a name="l00490"></a>00490 
<a name="l00499"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acc56c69a8f235f70cded1b1e7a6345a8">00499</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acc56c69a8f235f70cded1b1e7a6345a8">isRequestProcessorThread</a>() {
<a name="l00500"></a>00500         Thread c = Thread.currentThread();
<a name="l00501"></a>00501         <span class="keyword">synchronized</span> (processorLock) {
<a name="l00502"></a>00502             <span class="keywordflow">return</span> c instanceof Processor &amp;&amp; processors.contains((Processor) c);
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 
<a name="l00509"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aecabda79b5fccb78febed4b166beb11d">00509</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aecabda79b5fccb78febed4b166beb11d">stop</a>() {
<a name="l00510"></a>00510         <span class="keywordflow">if</span> ((<span class="keyword">this</span> == UNLIMITED) || (<span class="keyword">this</span> == DEFAULT)) {
<a name="l00511"></a>00511             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">&quot;Can&#39;t stop shared RP&#39;s&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l00512"></a>00512         }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514         <span class="keyword">synchronized</span> (processorLock) {
<a name="l00515"></a>00515             <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae63a217ef7812afa58939db052cdd8cc">stopped</a> = <span class="keyword">true</span>;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517             <span class="keywordflow">for</span> (Processor p : processors) {
<a name="l00518"></a>00518                 p.interrupt();
<a name="l00519"></a>00519             }
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="comment">//</span>
<a name="l00524"></a>00524     <span class="comment">// Static methods communicating with default request processor</span>
<a name="l00525"></a>00525     <span class="comment">//</span>
<a name="l00526"></a>00526 
<a name="l00536"></a>00536     @Deprecated
<a name="l00537"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#afa3e25eca8a38ee479653f96d90a86c9">00537</a>     <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#afa3e25eca8a38ee479653f96d90a86c9">postRequest</a>(Runnable run) {
<a name="l00538"></a>00538         <span class="keywordflow">return</span> DEFAULT.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(run);
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540 
<a name="l00552"></a>00552     @Deprecated
<a name="l00553"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#abc64a527da67b99ff6fe654510798f99">00553</a>     <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#abc64a527da67b99ff6fe654510798f99">postRequest</a>(<span class="keyword">final</span> Runnable run, <span class="keywordtype">int</span> timeToWait) {
<a name="l00554"></a>00554         <span class="keywordflow">return</span> DEFAULT.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(run, timeToWait);
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556 
<a name="l00568"></a>00568     @Deprecated
<a name="l00569"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a387ba7fbfdef67ff5cc9af41bd7c2089">00569</a>     <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a387ba7fbfdef67ff5cc9af41bd7c2089">postRequest</a>(<span class="keyword">final</span> Runnable run, <span class="keywordtype">int</span> timeToWait, <span class="keywordtype">int</span> priority) {
<a name="l00570"></a>00570         <span class="keywordflow">return</span> DEFAULT.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a122d8ff63f697cd04f650504268db121">post</a>(run, timeToWait, priority);
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00582"></a>00582     @Deprecated
<a name="l00583"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a0b65cd4b445304250313f0471b6376b8">00583</a>     <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a0b65cd4b445304250313f0471b6376b8">createRequest</a>(Runnable run) {
<a name="l00584"></a>00584         <span class="keywordflow">return</span> DEFAULT.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#acfe8a3bcca7e5767bbf5b1d2623b7919">create</a>(run);
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586 
<a name="l00589"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a178c96a4d305e683e0c6337e1773bf47">00589</a>     <span class="keyword">static</span> Logger <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a178c96a4d305e683e0c6337e1773bf47">logger</a>() {
<a name="l00590"></a>00590         <span class="keywordflow">return</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a178c96a4d305e683e0c6337e1773bf47">logger</a>;
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00594"></a>00594     <span class="comment">// The pending queue management implementation</span>
<a name="l00595"></a>00595     <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00596"></a>00596 
<a name="l00601"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a3650a7258047c55a4dfe039074d17b92">00601</a>     <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a3650a7258047c55a4dfe039074d17b92">enqueue</a>(Item item) {
<a name="l00602"></a>00602         Logger em = <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a178c96a4d305e683e0c6337e1773bf47">logger</a>();
<a name="l00603"></a>00603         <span class="keywordtype">boolean</span> loggable = em.isLoggable(Level.FINE);
<a name="l00604"></a>00604         <span class="keywordtype">boolean</span> wasNull;
<a name="l00605"></a>00605         
<a name="l00606"></a>00606         <span class="keyword">synchronized</span> (processorLock) {
<a name="l00607"></a>00607             wasNull = item.getTask() == null;
<a name="l00608"></a>00608             <span class="keywordflow">if</span> (!wasNull) {
<a name="l00609"></a>00609                 prioritizedEnqueue(item);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611                 <span class="keywordflow">if</span> (running &lt; throughput) {
<a name="l00612"></a>00612                     running++;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614                     Processor proc = Processor.get();
<a name="l00615"></a>00615                     processors.add(proc);
<a name="l00616"></a>00616                     proc.setName(name);
<a name="l00617"></a>00617                     proc.attachTo(<span class="keyword">this</span>);
<a name="l00618"></a>00618                 }
<a name="l00619"></a>00619             }
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621         <span class="keywordflow">if</span> (loggable) {
<a name="l00622"></a>00622             <span class="keywordflow">if</span> (wasNull) {
<a name="l00623"></a>00623                 em.log(Level.FINE, <span class="stringliteral">&quot;Null task for item {0}&quot;</span>, item); <span class="comment">// NOI18N</span>
<a name="l00624"></a>00624             } <span class="keywordflow">else</span> {
<a name="l00625"></a>00625                 em.log(Level.FINE, <span class="stringliteral">&quot;Item enqueued: {0} status: {1}&quot;</span>, <span class="keyword">new</span> Object[]{item.action, item.enqueued}); <span class="comment">// NOI18N</span>
<a name="l00626"></a>00626             }
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="comment">// call it under queue lock i.e. processorLock</span>
<a name="l00631"></a>00631     <span class="keyword">private</span> <span class="keywordtype">void</span> prioritizedEnqueue(Item item) {
<a name="l00632"></a>00632         <span class="keywordtype">int</span> iprio = item.getPriority();
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         <span class="keywordflow">if</span> (getQueue().isEmpty()) {
<a name="l00635"></a>00635             getQueue().add(item);
<a name="l00636"></a>00636             item.enqueued = <span class="keyword">true</span>;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638             <span class="keywordflow">return</span>;
<a name="l00639"></a>00639         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iprio &lt;= getQueue().<span class="keyword">get</span>(getQueue().size() - 1).getPriority()) {
<a name="l00640"></a>00640             getQueue().add(item);
<a name="l00641"></a>00641             item.enqueued = <span class="keyword">true</span>;
<a name="l00642"></a>00642         } <span class="keywordflow">else</span> {
<a name="l00643"></a>00643             <span class="keywordflow">for</span> (ListIterator&lt;Item&gt; it = getQueue().listIterator(); it.hasNext();) {
<a name="l00644"></a>00644                 Item next = it.next();
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                 <span class="keywordflow">if</span> (iprio &gt; next.getPriority()) {
<a name="l00647"></a>00647                     it.set(item);
<a name="l00648"></a>00648                     it.add(next);
<a name="l00649"></a>00649                     item.enqueued = <span class="keyword">true</span>;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651                     <span class="keywordflow">return</span>;
<a name="l00652"></a>00652                 }
<a name="l00653"></a>00653             }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="stringliteral">&quot;Prioritized enqueue failed!&quot;</span>);
<a name="l00656"></a>00656         }
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     Task askForWork(Processor worker, String debug) {
<a name="l00660"></a>00660         <span class="keywordflow">if</span> (getQueue().isEmpty() || (stopped &amp;&amp; !finishAwaitingTasks)) { <span class="comment">// no more work in this burst, return him</span>
<a name="l00661"></a>00661             processors.remove(worker);
<a name="l00662"></a>00662             Processor.put(worker, debug);
<a name="l00663"></a>00663             running--;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665             <span class="keywordflow">return</span> null;
<a name="l00666"></a>00666         } <span class="keywordflow">else</span> { <span class="comment">// we have some work for the worker, pass it</span>
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             Item i = getQueue().remove(0);
<a name="l00669"></a>00669             Task t = i.getTask();
<a name="l00670"></a>00670             i.clear(worker);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672             <span class="keywordflow">return</span> t;
<a name="l00673"></a>00673         }
<a name="l00674"></a>00674     }
<a name="l00675"></a>00675 
<a name="l00682"></a>00682     @Override
<a name="l00683"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a5fd4749b53165e36544faf00fe9846db">00683</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a5fd4749b53165e36544faf00fe9846db">shutdown</a>() {
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (<span class="keyword">this</span> == UNLIMITED) {
<a name="l00685"></a>00685             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException (<span class="stringliteral">&quot;Cannot shut down the default &quot;</span> + <span class="comment">//NOI18N</span>
<a name="l00686"></a>00686                     <span class="stringliteral">&quot;request processor&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688         stopped = <span class="keyword">true</span>;
<a name="l00689"></a>00689         finishAwaitingTasks = <span class="keyword">true</span>;
<a name="l00690"></a>00690     }
<a name="l00691"></a>00691 
<a name="l00698"></a>00698     @Override
<a name="l00699"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ac2c9dbc2113abf7a4d226853116d136c">00699</a>     <span class="keyword">public</span> List&lt;Runnable&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ac2c9dbc2113abf7a4d226853116d136c">shutdownNow</a>() {
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (<span class="keyword">this</span> == UNLIMITED) {
<a name="l00701"></a>00701             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException (<span class="stringliteral">&quot;Cannot shut down the default &quot;</span> + <span class="comment">//NOI18N</span>
<a name="l00702"></a>00702                     <span class="stringliteral">&quot;request processor&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704         <span class="comment">//XX X more aggressive shutdown?</span>
<a name="l00705"></a>00705         stop();
<a name="l00706"></a>00706         <span class="keyword">synchronized</span> (processorLock) {
<a name="l00707"></a>00707             List&lt;Runnable&gt; result = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;(getQueue().size());
<a name="l00708"></a>00708             <span class="keywordflow">for</span> (Item item : getQueue()) {
<a name="l00709"></a>00709                 <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> task = item.getTask();
<a name="l00710"></a>00710                 <span class="keywordflow">if</span> (task != null &amp;&amp; task.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a96511a0a88fca9ef55c7f12f609a6864">run</a> != null) {
<a name="l00711"></a>00711                     Runnable r = task.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a96511a0a88fca9ef55c7f12f609a6864">run</a>;
<a name="l00712"></a>00712                     <span class="keywordflow">if</span> (r instanceof RunnableWrapper) {
<a name="l00713"></a>00713                         Runnable other = ((RunnableWrapper) r).getRunnable();
<a name="l00714"></a>00714                         r = other == null ? r : other;
<a name="l00715"></a>00715                     }
<a name="l00716"></a>00716                     result.add(r);
<a name="l00717"></a>00717                 }
<a name="l00718"></a>00718             }
<a name="l00719"></a>00719             <span class="keywordflow">return</span> result;
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722 
<a name="l00727"></a>00727     @Override
<a name="l00728"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ab2d24e3362471bd70350cabcd9a88919">00728</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ab2d24e3362471bd70350cabcd9a88919">isShutdown</a>() {
<a name="l00729"></a>00729         <span class="keywordflow">return</span> stopped;
<a name="l00730"></a>00730     }
<a name="l00731"></a>00731 
<a name="l00736"></a>00736     @Override
<a name="l00737"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#afd60d4b463e1304d70fbd4e0f18cad68">00737</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#afd60d4b463e1304d70fbd4e0f18cad68">isTerminated</a>() {
<a name="l00738"></a>00738         <span class="keywordtype">boolean</span> result = <span class="keyword">true</span>;
<a name="l00739"></a>00739         Set&lt;Processor&gt; <span class="keyword">set</span> = collectProcessors(<span class="keyword">new</span> HashSet&lt;Processor&gt;());
<a name="l00740"></a>00740         <span class="keywordflow">for</span> (Processor p : <span class="keyword">set</span>) {
<a name="l00741"></a>00741             <span class="keywordflow">if</span> (p.isAlive() &amp;&amp; p.belongsTo(<span class="keyword">this</span>)) {
<a name="l00742"></a>00742                 result = <span class="keyword">false</span>;
<a name="l00743"></a>00743                 <span class="keywordflow">break</span>;
<a name="l00744"></a>00744             }
<a name="l00745"></a>00745         }
<a name="l00746"></a>00746         <span class="keywordflow">return</span> result;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748 
<a name="l00753"></a>00753     @Override
<a name="l00754"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae2c9dd4843214a44293330ca834adb9b">00754</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae2c9dd4843214a44293330ca834adb9b">awaitTermination</a>(<span class="keywordtype">long</span> timeout, TimeUnit unit) <span class="keywordflow">throws</span> InterruptedException {
<a name="l00755"></a>00755         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;unit&quot;</span>, unit); <span class="comment">//NOI18N</span>
<a name="l00756"></a>00756         <span class="keywordtype">long</span> timeoutMillis = TimeUnit.MILLISECONDS.convert(timeout, unit);
<a name="l00757"></a>00757         <span class="keywordtype">boolean</span> result = stopped;
<a name="l00758"></a>00758         <span class="keywordtype">long</span> doneTime = System.currentTimeMillis() + timeoutMillis;
<a name="l00759"></a>00759         Set&lt;Processor&gt; procs = <span class="keyword">new</span> HashSet&lt;Processor&gt;();
<a name="l00760"></a>00760 outer:  <span class="keywordflow">do</span> {
<a name="l00761"></a>00761             procs = collectProcessors(procs);
<a name="l00762"></a>00762             <span class="keywordflow">if</span> (procs.isEmpty()) {
<a name="l00763"></a>00763                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00764"></a>00764             }
<a name="l00765"></a>00765             <span class="keywordflow">for</span> (Processor p : procs) {
<a name="l00766"></a>00766                 <span class="keywordtype">long</span> remaining = doneTime - System.currentTimeMillis();
<a name="l00767"></a>00767                 <span class="keywordflow">if</span> (remaining &lt;= 0) {
<a name="l00768"></a>00768                     result = collectProcessors(procs).isEmpty();
<a name="l00769"></a>00769                     <span class="keywordflow">break</span> outer;
<a name="l00770"></a>00770                 }
<a name="l00771"></a>00771                 <span class="keywordflow">if</span> (p.belongsTo(<span class="keyword">this</span>)) {
<a name="l00772"></a>00772                     p.join(remaining);
<a name="l00773"></a>00773                 }
<a name="l00774"></a>00774                 result = !p.isAlive() || !p.belongsTo(<span class="keyword">this</span>);
<a name="l00775"></a>00775             }
<a name="l00776"></a>00776             procs.clear();
<a name="l00777"></a>00777         } <span class="keywordflow">while</span> (!procs.isEmpty());
<a name="l00778"></a>00778         <span class="keywordflow">return</span> result;
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781     <span class="keyword">private</span> Set&lt;Processor&gt; collectProcessors (Set&lt;Processor&gt; procs) {
<a name="l00782"></a>00782         procs.clear();
<a name="l00783"></a>00783         <span class="keyword">synchronized</span> (processorLock) {
<a name="l00784"></a>00784             <span class="keywordflow">for</span> (Processor p : processors) {
<a name="l00785"></a>00785                 <span class="keywordflow">if</span> (p.belongsTo(<span class="keyword">this</span>)) {
<a name="l00786"></a>00786                     procs.add(p);
<a name="l00787"></a>00787                 }
<a name="l00788"></a>00788             }
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790         <span class="keywordflow">return</span> procs;
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792 
<a name="l00803"></a>00803     @Override
<a name="l00804"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a834c82092c5ca1cab1d7efbf66cc9b88">00804</a>     public &lt;T&gt; Future&lt;T&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a834c82092c5ca1cab1d7efbf66cc9b88">submit</a>(Callable&lt;T&gt; task) {
<a name="l00805"></a>00805         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;task&quot;</span>, task); <span class="comment">//NOI18N</span>
<a name="l00806"></a>00806         <span class="keywordflow">if</span> (stopped) {
<a name="l00807"></a>00807             <span class="keywordflow">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="stringliteral">&quot;Request Processor already &quot;</span> + <span class="comment">//NOI18N</span>
<a name="l00808"></a>00808                     <span class="stringliteral">&quot;stopped&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l00809"></a>00809         }
<a name="l00810"></a>00810         RPFutureTask&lt;T&gt; result = <span class="keyword">new</span> RPFutureTask&lt;T&gt;(task);
<a name="l00811"></a>00811         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> t = create(result);
<a name="l00812"></a>00812         result.setTask(t);
<a name="l00813"></a>00813         t.schedule(0);
<a name="l00814"></a>00814         <span class="keywordflow">return</span> result;
<a name="l00815"></a>00815     }
<a name="l00825"></a>00825     @Override
<a name="l00826"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#afd14c52de26c35ef4342ac910098ea83">00826</a>     public &lt;T&gt; Future&lt;T&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#afd14c52de26c35ef4342ac910098ea83">submit</a>(Runnable task, T predefinedResult) {
<a name="l00827"></a>00827         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;task&quot;</span>, task); <span class="comment">//NOI18N</span>
<a name="l00828"></a>00828         <span class="keywordflow">if</span> (stopped) {
<a name="l00829"></a>00829             <span class="keywordflow">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="stringliteral">&quot;Request Processor already &quot;</span> + <span class="comment">//NOI18N</span>
<a name="l00830"></a>00830                     <span class="stringliteral">&quot;stopped&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l00831"></a>00831         }
<a name="l00832"></a>00832         RPFutureTask&lt;T&gt; result = <span class="keyword">new</span> RPFutureTask&lt;T&gt;(task, predefinedResult);
<a name="l00833"></a>00833         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> t = create(result);
<a name="l00834"></a>00834         result.setTask(t);
<a name="l00835"></a>00835         t.schedule(0);
<a name="l00836"></a>00836         <span class="keywordflow">return</span> result;
<a name="l00837"></a>00837     }
<a name="l00838"></a>00838 
<a name="l00849"></a>00849     @Override
<a name="l00850"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a2dd80cbe1437488db24d147c4fb6f7eb">00850</a>     <span class="keyword">public</span> Future&lt;?&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a2dd80cbe1437488db24d147c4fb6f7eb">submit</a>(Runnable task) {
<a name="l00851"></a>00851         <span class="keywordflow">return</span> this.&lt;Void&gt;submit (task, null);
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853 
<a name="l00858"></a>00858     @Override
<a name="l00859"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a14527a1d1e98e74ceb1440948ab59704">00859</a>     public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a14527a1d1e98e74ceb1440948ab59704">invokeAll</a>(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException {
<a name="l00860"></a>00860         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;tasks&quot;</span>, tasks); <span class="comment">//NOI18N</span>
<a name="l00861"></a>00861         List&lt;Future&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;Future&lt;T&gt;&gt;(tasks.size());
<a name="l00862"></a>00862         CountDownLatch wait = <span class="keyword">new</span> CountDownLatch(tasks.size());
<a name="l00863"></a>00863         <span class="keywordflow">for</span> (Callable&lt;T&gt; c : tasks) {
<a name="l00864"></a>00864             <span class="keywordflow">if</span> (c == null) {
<a name="l00865"></a>00865                     <span class="keywordflow">throw</span> <span class="keyword">new</span> NullPointerException (<span class="stringliteral">&quot;Contains null tasks: &quot;</span> +  <span class="comment">//NOI18N</span>
<a name="l00866"></a>00866                             tasks);
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868             Callable&lt;T&gt; delegate = <span class="keyword">new</span> WaitableCallable&lt;T&gt;(c, wait);
<a name="l00869"></a>00869             result.add (submit(delegate));
<a name="l00870"></a>00870         }
<a name="l00871"></a>00871         wait.await();
<a name="l00872"></a>00872         <span class="keywordflow">return</span> result;
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874 
<a name="l00883"></a>00883     @Override
<a name="l00884"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a341a608b047057defe002e8ebea0e739">00884</a>     public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a341a608b047057defe002e8ebea0e739">invokeAll</a>(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="keywordtype">long</span> timeout, TimeUnit unit) <span class="keywordflow">throws</span> InterruptedException {
<a name="l00885"></a>00885         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;unit&quot;</span>, unit); <span class="comment">//NOI18N</span>
<a name="l00886"></a>00886         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;tasks&quot;</span>, tasks); <span class="comment">//NOI18N</span>
<a name="l00887"></a>00887         CountDownLatch wait = <span class="keyword">new</span> CountDownLatch(tasks.size());
<a name="l00888"></a>00888         List&lt;Future&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;Future&lt;T&gt;&gt;(tasks.size());
<a name="l00889"></a>00889         <span class="keywordflow">for</span> (Callable&lt;T&gt; c : tasks) {
<a name="l00890"></a>00890             <span class="keywordflow">if</span> (c == null) {
<a name="l00891"></a>00891                 <span class="keywordflow">throw</span> <span class="keyword">new</span> NullPointerException (<span class="stringliteral">&quot;Contains null tasks: &quot;</span> + tasks); <span class="comment">//NOI18N</span>
<a name="l00892"></a>00892             }
<a name="l00893"></a>00893             Callable&lt;T&gt; delegate = <span class="keyword">new</span> WaitableCallable&lt;T&gt;(c, wait);
<a name="l00894"></a>00894             result.add (submit(delegate));
<a name="l00895"></a>00895         }
<a name="l00896"></a>00896         <span class="keywordflow">if</span> (!wait.await(timeout, unit)) {
<a name="l00897"></a>00897             <span class="keywordflow">for</span> (Future&lt;T&gt; f : result) {
<a name="l00898"></a>00898                 RPFutureTask&lt;?&gt; ft = (RPFutureTask&lt;?&gt;) f;
<a name="l00899"></a>00899                 ft.cancel(<span class="keyword">true</span>);
<a name="l00900"></a>00900             }
<a name="l00901"></a>00901         }
<a name="l00902"></a>00902         <span class="keywordflow">return</span> result;
<a name="l00903"></a>00903     }
<a name="l00911"></a>00911     @Override
<a name="l00912"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae6ff689f15ec9faf2602ae3630fdaf34">00912</a>     public &lt;T&gt; T <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#ae6ff689f15ec9faf2602ae3630fdaf34">invokeAny</a>(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException, ExecutionException {
<a name="l00913"></a>00913         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;tasks&quot;</span>, tasks); <span class="comment">//NOI18N</span>
<a name="l00914"></a>00914         CountDownLatch wait = <span class="keyword">new</span> CountDownLatch(1);
<a name="l00915"></a>00915         List&lt;Future&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;Future&lt;T&gt;&gt;(tasks.size());
<a name="l00916"></a>00916         AtomicReference&lt;T&gt; ref = <span class="keyword">new</span> AtomicReference&lt;T&gt;();
<a name="l00917"></a>00917         <span class="keywordflow">try</span> {
<a name="l00918"></a>00918             <span class="keywordflow">for</span> (Callable&lt;T&gt; c : tasks) {
<a name="l00919"></a>00919                 <span class="keywordflow">if</span> (c == null) {
<a name="l00920"></a>00920                     <span class="keywordflow">throw</span> <span class="keyword">new</span> NullPointerException (<span class="stringliteral">&quot;Contains null tasks: &quot;</span> +  <span class="comment">//NOI18N</span>
<a name="l00921"></a>00921                             tasks);
<a name="l00922"></a>00922                 }
<a name="l00923"></a>00923                 Callable&lt;T&gt; delegate = <span class="keyword">new</span> WaitableCallable&lt;T&gt;(c, ref, wait);
<a name="l00924"></a>00924                 result.add (submit(delegate));
<a name="l00925"></a>00925             }
<a name="l00926"></a>00926             wait.await();
<a name="l00927"></a>00927         } <span class="keywordflow">finally</span> {
<a name="l00928"></a>00928             <span class="keywordflow">for</span> (Future&lt;T&gt; f : result) {
<a name="l00929"></a>00929                 RPFutureTask&lt;?&gt; ft = (RPFutureTask&lt;?&gt;) f;
<a name="l00930"></a>00930                 ft.cancel(<span class="keyword">true</span>);
<a name="l00931"></a>00931             }
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933         <span class="keywordflow">return</span> ref.get();
<a name="l00934"></a>00934     }
<a name="l00949"></a>00949     @Override
<a name="l00950"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a49eda48df6797892bf2f34ea29ad5d8d">00950</a>     public &lt;T&gt; T <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a49eda48df6797892bf2f34ea29ad5d8d">invokeAny</a>(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="keywordtype">long</span> timeout, TimeUnit unit) <span class="keywordflow">throws</span> InterruptedException, ExecutionException, TimeoutException {
<a name="l00951"></a>00951         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;unit&quot;</span>, unit); <span class="comment">//NOI18N</span>
<a name="l00952"></a>00952         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;tasks&quot;</span>, tasks); <span class="comment">//NOI18N</span>
<a name="l00953"></a>00953         CountDownLatch wait = <span class="keyword">new</span> CountDownLatch(1);
<a name="l00954"></a>00954         List&lt;Future&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;Future&lt;T&gt;&gt;(tasks.size());
<a name="l00955"></a>00955         AtomicReference&lt;T&gt; ref = <span class="keyword">new</span> AtomicReference&lt;T&gt;();
<a name="l00956"></a>00956         <span class="keywordflow">try</span> {
<a name="l00957"></a>00957             <span class="keywordflow">for</span> (Callable&lt;T&gt; c : tasks) {
<a name="l00958"></a>00958                 <span class="keywordflow">if</span> (c == null) {
<a name="l00959"></a>00959                     <span class="keywordflow">throw</span> <span class="keyword">new</span> NullPointerException (<span class="stringliteral">&quot;Contains null tasks: &quot;</span> +  <span class="comment">//NOI18N</span>
<a name="l00960"></a>00960                             tasks);
<a name="l00961"></a>00961                 }
<a name="l00962"></a>00962                 Callable&lt;T&gt; delegate = <span class="keyword">new</span> WaitableCallable&lt;T&gt;(c, ref, wait);
<a name="l00963"></a>00963                 result.add (submit(delegate));
<a name="l00964"></a>00964             }
<a name="l00965"></a>00965             wait.await(timeout, unit);
<a name="l00966"></a>00966         } <span class="keywordflow">finally</span> {
<a name="l00967"></a>00967             <span class="keywordflow">for</span> (Future&lt;T&gt; f : result) {
<a name="l00968"></a>00968                 RPFutureTask&lt;?&gt; ft = (RPFutureTask&lt;?&gt;) f;
<a name="l00969"></a>00969                 ft.cancel(<span class="keyword">true</span>);
<a name="l00970"></a>00970             }
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972         <span class="keywordflow">return</span> ref.get();
<a name="l00973"></a>00973     }
<a name="l00974"></a>00974 
<a name="l00979"></a>00979     @Override
<a name="l00980"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#adf7731c91b2e2a8d0c58ac14ff1a1a35">00980</a>     <span class="keyword">public</span> ScheduledFuture&lt;?&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#adf7731c91b2e2a8d0c58ac14ff1a1a35">schedule</a>(Runnable command, <span class="keywordtype">long</span> delay, TimeUnit unit) {
<a name="l00981"></a>00981         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;command&quot;</span>, command); <span class="comment">//NOI18N</span>
<a name="l00982"></a>00982         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;unit&quot;</span>, unit); <span class="comment">//NOI18N</span>
<a name="l00983"></a>00983         <span class="keywordflow">if</span> (delay &lt; 0) {
<a name="l00984"></a>00984             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException (<span class="stringliteral">&quot;Negative delay: &quot;</span> + delay);
<a name="l00985"></a>00985         }
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (stopped) {
<a name="l00987"></a>00987             <span class="keywordflow">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="stringliteral">&quot;Request Processor already stopped&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l00988"></a>00988         }
<a name="l00989"></a>00989         <span class="keywordtype">long</span> delayMillis = TimeUnit.MILLISECONDS.convert(delay, unit);
<a name="l00990"></a>00990         ScheduledRPFutureTask&lt;Void&gt; result = <span class="keyword">new</span> ScheduledRPFutureTask&lt;Void&gt;(command, null, delayMillis);
<a name="l00991"></a>00991         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> t = create(result);
<a name="l00992"></a>00992         result.setTask(t);
<a name="l00993"></a>00993         t.schedule(delayMillis);
<a name="l00994"></a>00994         <span class="keywordflow">return</span> result;
<a name="l00995"></a>00995     }
<a name="l01000"></a>01000     @Override
<a name="l01001"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aa609726c5610a6220b27000e9654ebaa">01001</a>     public &lt;T&gt; ScheduledFuture&lt;T&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aa609726c5610a6220b27000e9654ebaa">schedule</a>(Callable&lt;T&gt; callable, <span class="keywordtype">long</span> delay, TimeUnit unit) {
<a name="l01002"></a>01002         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;unit&quot;</span>, unit); <span class="comment">//NOI18N</span>
<a name="l01003"></a>01003         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;callable&quot;</span>, callable); <span class="comment">//NOI18N</span>
<a name="l01004"></a>01004         <span class="keywordflow">if</span> (delay &lt; 0) {
<a name="l01005"></a>01005             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException (<span class="stringliteral">&quot;Negative delay: &quot;</span> + delay);
<a name="l01006"></a>01006         }
<a name="l01007"></a>01007         <span class="keywordflow">if</span> (stopped) {
<a name="l01008"></a>01008             <span class="keywordflow">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="stringliteral">&quot;Request Processor already &quot;</span> + <span class="comment">//NOI18N</span>
<a name="l01009"></a>01009                     <span class="stringliteral">&quot;stopped&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l01010"></a>01010         }
<a name="l01011"></a>01011         <span class="keywordtype">long</span> delayMillis = TimeUnit.MILLISECONDS.convert(delay, unit);
<a name="l01012"></a>01012         ScheduledRPFutureTask&lt;T&gt; result = <span class="keyword">new</span> ScheduledRPFutureTask&lt;T&gt;(callable, delayMillis);
<a name="l01013"></a>01013         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> t = create(result);
<a name="l01014"></a>01014         result.setTask(t);
<a name="l01015"></a>01015         t.schedule(delayMillis);
<a name="l01016"></a>01016         <span class="keywordflow">return</span> result;
<a name="l01017"></a>01017     }
<a name="l01018"></a>01018 
<a name="l01028"></a>01028     @Override
<a name="l01029"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a40dcb33014c437bff73d0e26c6d10f14">01029</a>     <span class="keyword">public</span> ScheduledFuture&lt;?&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#a40dcb33014c437bff73d0e26c6d10f14">scheduleAtFixedRate</a>(Runnable command, <span class="keywordtype">long</span> initialDelay, <span class="keywordtype">long</span> period, TimeUnit unit) {
<a name="l01030"></a>01030         <span class="keywordflow">return</span> scheduleFixed(command, initialDelay, period, unit, <span class="keyword">false</span>);
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 
<a name="l01041"></a>01041     @Override
<a name="l01042"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aa02be81330ccef24b838b8286b3fd853">01042</a>     <span class="keyword">public</span> ScheduledFuture&lt;?&gt; <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html#aa02be81330ccef24b838b8286b3fd853">scheduleWithFixedDelay</a>(Runnable command, <span class="keywordtype">long</span> initialDelay, <span class="keywordtype">long</span> delay, TimeUnit unit) {
<a name="l01043"></a>01043         <span class="keywordflow">return</span> scheduleFixed(command, initialDelay, delay, unit, <span class="keyword">true</span>);
<a name="l01044"></a>01044     }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     <span class="keyword">private</span> ScheduledFuture&lt;?&gt; scheduleFixed (Runnable command, <span class="keywordtype">long</span> initialDelay, <span class="keywordtype">long</span> period, TimeUnit unit, <span class="keywordtype">boolean</span> fixedDelay) {
<a name="l01047"></a>01047         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;unit&quot;</span>, unit); <span class="comment">//NOI18N</span>
<a name="l01048"></a>01048         <a class="code" href="classorg_1_1openide_1_1util_1_1_parameters.html">Parameters</a>.notNull(<span class="stringliteral">&quot;command&quot;</span>, command); <span class="comment">//NOI18N</span>
<a name="l01049"></a>01049         <span class="keywordflow">if</span> (period &lt; 0) {
<a name="l01050"></a>01050             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException (<span class="stringliteral">&quot;Negative delay: &quot;</span> + period); <span class="comment">//NOI18N</span>
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052         <span class="keywordflow">if</span> (initialDelay &lt; 0) {
<a name="l01053"></a>01053             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException (<span class="stringliteral">&quot;Negative initialDelay: &quot;</span>  <span class="comment">//NOI18N</span>
<a name="l01054"></a>01054                     + initialDelay);
<a name="l01055"></a>01055         }
<a name="l01056"></a>01056         <span class="keywordflow">if</span> (stopped) {
<a name="l01057"></a>01057             <span class="keywordflow">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="stringliteral">&quot;Request Processor already &quot;</span> + <span class="comment">//NOI18N</span>
<a name="l01058"></a>01058                     <span class="stringliteral">&quot;stopped&quot;</span>); <span class="comment">//NOI18N</span>
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060         <span class="keywordtype">long</span> initialDelayMillis = TimeUnit.MILLISECONDS.convert(initialDelay, unit);
<a name="l01061"></a>01061         <span class="keywordtype">long</span> periodMillis = TimeUnit.MILLISECONDS.convert(period, unit);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         TaskFutureWrapper wrap = fixedDelay ? 
<a name="l01064"></a>01064             <span class="keyword">new</span> FixedDelayTask(command, initialDelayMillis, periodMillis) :
<a name="l01065"></a>01065             new FixedRateTask(command, initialDelay, periodMillis);
<a name="l01066"></a>01066         Task t = create(wrap);
<a name="l01067"></a>01067         wrap.t = t;
<a name="l01068"></a>01068         t.cancelled = wrap.cancelled;
<a name="l01069"></a>01069         t.schedule (initialDelayMillis);
<a name="l01070"></a>01070 
<a name="l01071"></a>01071         <span class="keywordflow">return</span> wrap;
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074     <span class="keyword">private</span> List&lt;Item&gt; getQueue() {
<a name="l01075"></a>01075         assert Thread.holdsLock(processorLock);
<a name="l01076"></a>01076         <span class="keywordflow">return</span> queue;
<a name="l01077"></a>01077     }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class </span>TaskFutureWrapper <span class="keyword">implements</span> ScheduledFuture&lt;Void&gt;, Runnable, RunnableWrapper {
<a name="l01080"></a>01080         <span class="keyword">volatile</span> Task t;
<a name="l01081"></a>01081         <span class="keyword">protected</span> <span class="keyword">final</span> Runnable toRun;
<a name="l01082"></a>01082         <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keywordtype">long</span> initialDelay;
<a name="l01083"></a>01083         <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keywordtype">long</span> period;
<a name="l01084"></a>01084         <span class="keyword">final</span> AtomicBoolean cancelled = <span class="keyword">new</span> AtomicBoolean();
<a name="l01085"></a>01085         TaskFutureWrapper(Runnable run, <span class="keywordtype">long</span> initialDelay, <span class="keywordtype">long</span> period) {
<a name="l01086"></a>01086             this.toRun = run;
<a name="l01087"></a>01087             this.initialDelay = initialDelay;
<a name="l01088"></a>01088             this.period = period;
<a name="l01089"></a>01089         }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091         @Override
<a name="l01092"></a>01092         <span class="keyword">public</span> <span class="keyword">final</span> Runnable getRunnable() {
<a name="l01093"></a>01093             <span class="keywordflow">return</span> toRun;
<a name="l01094"></a>01094         }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         @Override
<a name="l01097"></a>01097         <span class="keyword">public</span> <span class="keywordtype">int</span> compareTo(Delayed o) {
<a name="l01098"></a>01098             <span class="keywordtype">long</span> other = o.getDelay(TimeUnit.MILLISECONDS);
<a name="l01099"></a>01099             <span class="keywordtype">long</span> ours = getDelay(TimeUnit.MILLISECONDS);
<a name="l01100"></a>01100             <span class="comment">//Might overflow on, say, ms compared to Long.MAX_VALUE, TimeUnit.DAYS</span>
<a name="l01101"></a>01101             <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) (ours - other);
<a name="l01102"></a>01102         }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104         @Override
<a name="l01105"></a>01105         <span class="keyword">public</span> <span class="keywordtype">boolean</span> cancel(<span class="keywordtype">boolean</span> mayInterruptIfRunning) {
<a name="l01106"></a>01106             <span class="keywordtype">boolean</span> result = <span class="keyword">true</span>;
<a name="l01107"></a>01107             <span class="keywordflow">if</span> (toRun instanceof Cancellable) {
<a name="l01108"></a>01108                 result = ((Cancellable) toRun).cancel();
<a name="l01109"></a>01109             }
<a name="l01110"></a>01110             <span class="keywordflow">if</span> (result) {
<a name="l01111"></a>01111                 <span class="comment">//will invoke cancelled.set(true)</span>
<a name="l01112"></a>01112                 result = t.cancel(mayInterruptIfRunning);
<a name="l01113"></a>01113             }
<a name="l01114"></a>01114             <span class="keywordflow">return</span> result;
<a name="l01115"></a>01115         }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         @Override
<a name="l01118"></a>01118         <span class="keyword">public</span> <span class="keywordtype">boolean</span> isCancelled() {
<a name="l01119"></a>01119             <span class="keywordflow">return</span> cancelled.get();
<a name="l01120"></a>01120         }
<a name="l01121"></a>01121 
<a name="l01122"></a>01122         @Override
<a name="l01123"></a>01123         <span class="keyword">public</span> <span class="keywordtype">boolean</span> isDone() {
<a name="l01124"></a>01124             <span class="keywordflow">return</span> cancelled.get() || t.isFinished();
<a name="l01125"></a>01125         }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127         @Override
<a name="l01128"></a>01128         <span class="keyword">public</span> Void <span class="keyword">get</span>() <span class="keywordflow">throws</span> InterruptedException, ExecutionException {
<a name="l01129"></a>01129             <span class="keywordflow">if</span> (cancelled.get()) {
<a name="l01130"></a>01130                 <span class="keywordflow">throw</span> <span class="keyword">new</span> CancellationException();
<a name="l01131"></a>01131             }
<a name="l01132"></a>01132             t.waitFinished();
<a name="l01133"></a>01133             <span class="keywordflow">if</span> (cancelled.get()) {
<a name="l01134"></a>01134                 <span class="keywordflow">throw</span> <span class="keyword">new</span> CancellationException();
<a name="l01135"></a>01135             }
<a name="l01136"></a>01136             <span class="keywordflow">return</span> null;
<a name="l01137"></a>01137         }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139         @Override
<a name="l01140"></a>01140         <span class="keyword">public</span> Void <span class="keyword">get</span>(<span class="keywordtype">long</span> timeout, TimeUnit unit) <span class="keywordflow">throws</span> InterruptedException, ExecutionException, TimeoutException {
<a name="l01141"></a>01141             <span class="keywordflow">if</span> (cancelled.get()) {
<a name="l01142"></a>01142                 <span class="keywordflow">throw</span> <span class="keyword">new</span> CancellationException();
<a name="l01143"></a>01143             }
<a name="l01144"></a>01144             <span class="keywordtype">long</span> millis = TimeUnit.MILLISECONDS.convert(timeout, unit);
<a name="l01145"></a>01145             t.waitFinished(millis);
<a name="l01146"></a>01146             <span class="keywordflow">if</span> (cancelled.get()) {
<a name="l01147"></a>01147                 <span class="keywordflow">throw</span> <span class="keyword">new</span> CancellationException();
<a name="l01148"></a>01148             }
<a name="l01149"></a>01149             <span class="keywordflow">return</span> null;
<a name="l01150"></a>01150         }
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class </span>FixedRateTask <span class="keyword">extends</span> TaskFutureWrapper {
<a name="l01154"></a>01154         <span class="keyword">private</span> <span class="keyword">final</span> Object runLock = <span class="keyword">new</span> Object();
<a name="l01155"></a>01155         <span class="keyword">private</span> <span class="keyword">final</span> Object timeLock = <span class="keyword">new</span> Object();
<a name="l01156"></a>01156         <span class="comment">//must be accessed holding timeLock</span>
<a name="l01157"></a>01157         <span class="keyword">private</span> <span class="keywordtype">int</span> runCount;
<a name="l01158"></a>01158         <span class="keyword">private</span> <span class="keywordtype">long</span> nextRunTime;
<a name="l01159"></a>01159         <span class="keyword">private</span> <span class="keywordtype">long</span> start = Long.MIN_VALUE;
<a name="l01160"></a>01160         <span class="keyword">volatile</span> <span class="keywordtype">boolean</span> firstRun = <span class="keyword">true</span>;
<a name="l01161"></a>01161         FixedRateTask (Runnable run, <span class="keywordtype">long</span> initialDelay, <span class="keywordtype">long</span> period) {
<a name="l01162"></a>01162             super (run, initialDelay, period);
<a name="l01163"></a>01163         }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165         @Override
<a name="l01166"></a>01166         <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01167"></a>01167             <span class="keywordflow">if</span> (firstRun) {
<a name="l01168"></a>01168                 <span class="keyword">synchronized</span> (timeLock) {
<a name="l01169"></a>01169                     start = System.currentTimeMillis();
<a name="l01170"></a>01170                     firstRun = <span class="keyword">false</span>;
<a name="l01171"></a>01171                 }
<a name="l01172"></a>01172             }
<a name="l01173"></a>01173             <span class="keywordflow">try</span> {
<a name="l01174"></a>01174                 <span class="keyword">synchronized</span>(runLock) {
<a name="l01175"></a>01175                     toRun.run();
<a name="l01176"></a>01176                 }
<a name="l01177"></a>01177             } <span class="keywordflow">catch</span> (RuntimeException e) {
<a name="l01178"></a>01178                 cancel(<span class="keyword">true</span>);
<a name="l01179"></a>01179                 <span class="keywordflow">throw</span> e;
<a name="l01180"></a>01180             }
<a name="l01181"></a>01181             reschedule();
<a name="l01182"></a>01182         }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184         <span class="keyword">private</span> <span class="keywordtype">void</span> reschedule() {
<a name="l01185"></a>01185             <span class="comment">//All access to nextRunTime &amp; runCount under lock.</span>
<a name="l01186"></a>01186             <span class="keywordtype">long</span> interval;
<a name="l01187"></a>01187             <span class="keyword">synchronized</span> (timeLock) {
<a name="l01188"></a>01188                 nextRunTime = start + (initialDelay + period * runCount);
<a name="l01189"></a>01189                 runCount++;
<a name="l01190"></a>01190                 interval = Math.max(0,  nextRunTime - System.currentTimeMillis());
<a name="l01191"></a>01191             }
<a name="l01192"></a>01192             <span class="keywordtype">boolean</span> canContinue = !cancelled.get() &amp;&amp; !Thread.currentThread().isInterrupted();
<a name="l01193"></a>01193             <span class="keywordflow">if</span> (canContinue) {
<a name="l01194"></a>01194                 t.schedule(interval);
<a name="l01195"></a>01195             }
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         @Override
<a name="l01199"></a>01199         <span class="keyword">public</span> <span class="keywordtype">long</span> getDelay(TimeUnit unit) {
<a name="l01200"></a>01200             <span class="keywordflow">if</span> (isCancelled()) {
<a name="l01201"></a>01201                 <span class="keywordflow">return</span> Long.MAX_VALUE;
<a name="l01202"></a>01202             }
<a name="l01203"></a>01203             <span class="keywordtype">long</span> delay;
<a name="l01204"></a>01204             <span class="keyword">synchronized</span> (timeLock) {
<a name="l01205"></a>01205                 delay = Math.min(0, nextRunTime - System.currentTimeMillis());
<a name="l01206"></a>01206             }
<a name="l01207"></a>01207             <span class="keywordflow">return</span> unit.convert(delay, TimeUnit.MILLISECONDS);
<a name="l01208"></a>01208         }
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class </span>FixedDelayTask <span class="keyword">extends</span> TaskFutureWrapper {
<a name="l01212"></a>01212         <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong nextRunTime = <span class="keyword">new</span> AtomicLong();
<a name="l01213"></a>01213         FixedDelayTask(Runnable run, <span class="keywordtype">long</span> initialDelay, <span class="keywordtype">long</span> period)  {
<a name="l01214"></a>01214             super (run, initialDelay, period);
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217         @Override
<a name="l01218"></a>01218         <span class="keyword">public</span> <span class="keywordtype">long</span> getDelay(TimeUnit unit) {
<a name="l01219"></a>01219             <span class="keywordtype">long</span> next = nextRunTime.get();
<a name="l01220"></a>01220             <span class="keywordflow">return</span> unit.convert (next - System.currentTimeMillis(), TimeUnit.MILLISECONDS);
<a name="l01221"></a>01221         }
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         @Override
<a name="l01224"></a>01224         <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
<a name="l01225"></a>01225             <span class="keywordflow">if</span> (!fini()) {
<a name="l01226"></a>01226                 toRun.run();
<a name="l01227"></a>01227             }
<a name="l01228"></a>01228             <span class="keywordflow">if</span> (!fini()) {
<a name="l01229"></a>01229                 reschedule();
<a name="l01230"></a>01230             }
<a name="l01231"></a>01231         }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233         <span class="keyword">private</span> <span class="keywordtype">boolean</span> fini() {
<a name="l01234"></a>01234             <span class="keywordtype">boolean</span> result = cancelled.get() || Thread.currentThread().isInterrupted();
<a name="l01235"></a>01235             <span class="keywordflow">return</span> result;
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         <span class="keyword">private</span> <span class="keywordtype">void</span> reschedule() {
<a name="l01239"></a>01239             nextRunTime.set(System.currentTimeMillis() + period);
<a name="l01240"></a>01240             <span class="keywordflow">if</span> (!fini()) {
<a name="l01241"></a>01241                 t.schedule((<span class="keywordtype">int</span>) period);
<a name="l01242"></a>01242             }
<a name="l01243"></a>01243         }
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     <span class="keyword">private</span> interface RunnableWrapper {
<a name="l01247"></a>01247         Runnable getRunnable();
<a name="l01248"></a>01248     }
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class </span>WaitableCallable&lt;T&gt; <span class="keyword">implements</span> Callable&lt;T&gt;, Cancellable {
<a name="l01251"></a>01251         <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch countdown;
<a name="l01252"></a>01252         <span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;T&gt; delegate;
<a name="l01253"></a>01253         <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;T&gt; ref;
<a name="l01254"></a>01254         <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keywordtype">boolean</span> failed;
<a name="l01255"></a>01255         WaitableCallable(Callable&lt;T&gt; delegate, CountDownLatch countdown) {
<a name="l01256"></a>01256             <span class="keyword">this</span> (delegate, null, countdown);
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259         WaitableCallable(Callable&lt;T&gt; delegate, AtomicReference&lt;T&gt; ref, CountDownLatch countdown) {
<a name="l01260"></a>01260             this.delegate = delegate;
<a name="l01261"></a>01261             this.countdown = countdown;
<a name="l01262"></a>01262             this.ref = ref;
<a name="l01263"></a>01263         }
<a name="l01264"></a>01264 
<a name="l01265"></a>01265         @Override
<a name="l01266"></a>01266         <span class="keyword">public</span> T call() throws Exception {
<a name="l01267"></a>01267             <span class="keywordflow">try</span> {
<a name="l01268"></a>01268                 T result = delegate.call();
<a name="l01269"></a>01269                 <span class="keywordflow">if</span> (ref != null) {
<a name="l01270"></a>01270                     ref.set(result);
<a name="l01271"></a>01271                 }
<a name="l01272"></a>01272                 <span class="keywordflow">return</span> result;
<a name="l01273"></a>01273             } <span class="keywordflow">catch</span> (RuntimeException e) {
<a name="l01274"></a>01274                 failed = <span class="keyword">true</span>;
<a name="l01275"></a>01275                 <span class="keywordflow">throw</span> e;
<a name="l01276"></a>01276             } <span class="keywordflow">catch</span> (Error e) {
<a name="l01277"></a>01277                 failed = <span class="keyword">true</span>;
<a name="l01278"></a>01278                 <span class="keywordflow">throw</span> e;
<a name="l01279"></a>01279             } <span class="keywordflow">finally</span> {
<a name="l01280"></a>01280                 <span class="keywordflow">if</span> (!failed || ref == null) {
<a name="l01281"></a>01281                     countdown.countDown();
<a name="l01282"></a>01282                 }
<a name="l01283"></a>01283             }
<a name="l01284"></a>01284         }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         @Override
<a name="l01287"></a>01287         <span class="keyword">public</span> <span class="keywordtype">boolean</span> cancel() {
<a name="l01288"></a>01288             <span class="keywordflow">return</span> delegate instanceof Cancellable ? ((Cancellable) delegate).cancel() : <span class="keyword">true</span>;
<a name="l01289"></a>01289         }
<a name="l01290"></a>01290     }
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span>RPFutureTask&lt;T&gt; <span class="keyword">extends</span> FutureTask&lt;T&gt; implements RunnableWrapper {
<a name="l01293"></a>01293         <span class="keyword">protected</span> <span class="keyword">volatile</span> Task task;
<a name="l01294"></a>01294         <span class="keyword">private</span> <span class="keyword">final</span> Runnable runnable;
<a name="l01295"></a>01295         <span class="keyword">private</span> <span class="keyword">final</span> Cancellable cancellable;
<a name="l01296"></a>01296         RPFutureTask(Callable&lt;T&gt; c) {
<a name="l01297"></a>01297             super (c);
<a name="l01298"></a>01298             this.runnable = null;
<a name="l01299"></a>01299             this.cancellable = c instanceof Cancellable ? (Cancellable) c : null;
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302         RPFutureTask(Runnable r, T result) {
<a name="l01303"></a>01303             super (r, result);
<a name="l01304"></a>01304             this.runnable = r;
<a name="l01305"></a>01305             this.cancellable = r instanceof Cancellable ? (Cancellable) r : null;
<a name="l01306"></a>01306         }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308         <span class="keywordtype">void</span> setTask(Task task) {
<a name="l01309"></a>01309             this.task = task;
<a name="l01310"></a>01310         }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312         @Override
<a name="l01313"></a>01313         <span class="keyword">public</span> <span class="keywordtype">boolean</span> cancel(<span class="keywordtype">boolean</span> mayInterruptIfRunning) {
<a name="l01314"></a>01314             <span class="keywordtype">boolean</span> result = cancellable == null ? <span class="keyword">true</span> : cancellable.cancel();
<a name="l01315"></a>01315             <span class="keywordflow">if</span> (result) {
<a name="l01316"></a>01316                 <span class="keywordtype">boolean</span> taskCancelled = task.cancel();
<a name="l01317"></a>01317                 <span class="keywordtype">boolean</span> superCancel = super.cancel(mayInterruptIfRunning); <span class="comment">//must call both!</span>
<a name="l01318"></a>01318                 result = taskCancelled &amp;&amp; superCancel;
<a name="l01319"></a>01319             }
<a name="l01320"></a>01320             <span class="keywordflow">return</span> result;
<a name="l01321"></a>01321         }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323         @Override
<a name="l01324"></a>01324         <span class="keyword">public</span> Runnable getRunnable() {
<a name="l01325"></a>01325             <span class="keywordflow">return</span> this.runnable;
<a name="l01326"></a>01326         }
<a name="l01327"></a>01327     }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class </span>ScheduledRPFutureTask&lt;T&gt; <span class="keyword">extends</span> RPFutureTask&lt;T&gt; implements ScheduledFuture&lt;T&gt; {
<a name="l01330"></a>01330         <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keywordtype">long</span> delayMillis;
<a name="l01331"></a>01331         ScheduledRPFutureTask(Callable&lt;T&gt; c, <span class="keywordtype">long</span> delayMillis) {
<a name="l01332"></a>01332             super (c);
<a name="l01333"></a>01333             this.delayMillis = delayMillis;
<a name="l01334"></a>01334         }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336         ScheduledRPFutureTask(Runnable r, T result, <span class="keywordtype">long</span> delayMillis) {
<a name="l01337"></a>01337             super (r, result);
<a name="l01338"></a>01338             this.delayMillis = delayMillis;
<a name="l01339"></a>01339         }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341         
<a name="l01342"></a>01342         @Override
<a name="l01343"></a>01343         <span class="keyword">public</span> <span class="keywordtype">long</span> getDelay(TimeUnit unit) {
<a name="l01344"></a>01344             <span class="keywordflow">return</span> unit.convert(delayMillis, TimeUnit.MILLISECONDS);
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         @Override
<a name="l01348"></a>01348         <span class="keyword">public</span> <span class="keywordtype">int</span> compareTo(Delayed o) {
<a name="l01349"></a>01349             <span class="comment">//Can overflow, if one delay is, say, days, and the other, microseconds</span>
<a name="l01350"></a>01350             <span class="keywordtype">long</span> otherDelayMillis = o.getDelay(TimeUnit.MILLISECONDS);
<a name="l01351"></a>01351             <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) (delayMillis - otherDelayMillis);
<a name="l01352"></a>01352         }
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01359"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">01359</a>     <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class </span><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> <span class="keyword">extends</span> org.openide.util.<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a> implements Cancellable {
<a name="l01360"></a>01360         <span class="keyword">private</span> Item item;
<a name="l01361"></a>01361         <span class="keyword">private</span> <span class="keywordtype">int</span> priority = Thread.MIN_PRIORITY;
<a name="l01362"></a>01362         <span class="keyword">private</span> <span class="keywordtype">long</span> time = 0;
<a name="l01363"></a>01363         <span class="keyword">private</span> Thread lastThread = null;
<a name="l01364"></a>01364         <span class="keyword">private</span> AtomicBoolean cancelled;
<a name="l01365"></a>01365 
<a name="l01370"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a3ac61261c1865e5e74291dfca8116cc3">01370</a>         <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a3ac61261c1865e5e74291dfca8116cc3">Task</a>(Runnable <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#a6cdd94a593dabc5755ee7277098620f8">run</a>) {
<a name="l01371"></a>01371             super(run);
<a name="l01372"></a>01372         }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#a4f53be93cc1090f6b66975db2b184434">Task</a>(Runnable <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#a6cdd94a593dabc5755ee7277098620f8">run</a>, <span class="keywordtype">int</span> priority) {
<a name="l01375"></a>01375             super(run);
<a name="l01376"></a>01376 
<a name="l01377"></a>01377             <span class="keywordflow">if</span> (priority &lt; Thread.MIN_PRIORITY) {
<a name="l01378"></a>01378                 priority = Thread.MIN_PRIORITY;
<a name="l01379"></a>01379             }
<a name="l01380"></a>01380 
<a name="l01381"></a>01381             <span class="keywordflow">if</span> (priority &gt; Thread.MAX_PRIORITY) {
<a name="l01382"></a>01382                 priority = Thread.MAX_PRIORITY;
<a name="l01383"></a>01383             }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385             this.priority = priority;
<a name="l01386"></a>01386         }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         @Override
<a name="l01389"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a96511a0a88fca9ef55c7f12f609a6864">01389</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a96511a0a88fca9ef55c7f12f609a6864">run</a>() {
<a name="l01390"></a>01390             <span class="keywordflow">try</span> {
<a name="l01391"></a>01391                 <span class="keyword">synchronized</span> (<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a>.class) {
<a name="l01392"></a>01392                     <span class="keywordflow">while</span> (lastThread != null) {
<a name="l01393"></a>01393                         <span class="keywordflow">try</span> {
<a name="l01394"></a>01394                             <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a>.class.wait();
<a name="l01395"></a>01395                         } <span class="keywordflow">catch</span> (InterruptedException ex) {
<a name="l01396"></a>01396                             <span class="comment">// OK wait again</span>
<a name="l01397"></a>01397                         }
<a name="l01398"></a>01398                     }
<a name="l01399"></a>01399                     lastThread = Thread.currentThread();
<a name="l01400"></a>01400                 }
<a name="l01401"></a>01401                 <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#a0be6853ac207d4db173440433f6b7fa1">notifyRunning</a>();
<a name="l01402"></a>01402                 run.run();
<a name="l01403"></a>01403             } <span class="keywordflow">finally</span> {
<a name="l01404"></a>01404                 Item scheduled = this.item;
<a name="l01405"></a>01405                 <span class="keywordflow">if</span> (scheduled != null &amp;&amp; !scheduled.isNew() &amp;&amp; scheduled.getTask() == <span class="keyword">this</span>) {
<a name="l01406"></a>01406                     <span class="comment">// do not mark as finished, we are scheduled for future</span>
<a name="l01407"></a>01407                 } <span class="keywordflow">else</span> {
<a name="l01408"></a>01408                     <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#af31e5ee8dda43bae9a6d2fc48569448d">notifyFinished</a>();
<a name="l01409"></a>01409                 }
<a name="l01410"></a>01410                 <span class="keyword">synchronized</span> (<a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a>.class) {
<a name="l01411"></a>01411                     lastThread = null;
<a name="l01412"></a>01412                     <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html">Task</a>.class.notifyAll();
<a name="l01413"></a>01413                 }
<a name="l01414"></a>01414             }
<a name="l01415"></a>01415         }
<a name="l01416"></a>01416 
<a name="l01421"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a88a147398b58ff71d57ad10f7807742c">01421</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a88a147398b58ff71d57ad10f7807742c">getDelay</a>() {
<a name="l01422"></a>01422             <span class="keywordtype">long</span> delay = time - System.currentTimeMillis();
<a name="l01423"></a>01423 
<a name="l01424"></a>01424             <span class="keywordflow">if</span> (delay &lt; 0L) {
<a name="l01425"></a>01425                 <span class="keywordflow">return</span> 0;
<a name="l01426"></a>01426             }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428             <span class="keywordflow">if</span> (delay &gt; (<span class="keywordtype">long</span>) Integer.MAX_VALUE) {
<a name="l01429"></a>01429                 <span class="keywordflow">return</span> Integer.MAX_VALUE;
<a name="l01430"></a>01430             }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432             <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) delay;
<a name="l01433"></a>01433         }
<a name="l01434"></a>01434 
<a name="l01442"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a685f38865eebf567a7b47d41ff778ec0">01442</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a685f38865eebf567a7b47d41ff778ec0">schedule</a>(<span class="keywordtype">int</span> delay) {
<a name="l01443"></a>01443             schedule((<span class="keywordtype">long</span>) delay);
<a name="l01444"></a>01444         }
<a name="l01445"></a>01445 
<a name="l01446"></a>01446         <span class="keywordtype">void</span> schedule(<span class="keywordtype">long</span> delay) {
<a name="l01447"></a>01447             <span class="keywordflow">if</span> (stopped) {
<a name="l01448"></a>01448                 <span class="keywordflow">return</span>;
<a name="l01449"></a>01449             }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451             time = System.currentTimeMillis() + delay;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453             <span class="keyword">final</span> Item localItem;
<a name="l01454"></a>01454 
<a name="l01455"></a>01455             <span class="keyword">synchronized</span> (processorLock) {
<a name="l01456"></a>01456                 <span class="keywordflow">if</span> (cancelled != null) {
<a name="l01457"></a>01457                     cancelled.set(<span class="keyword">false</span>);
<a name="l01458"></a>01458                 }
<a name="l01459"></a>01459                 <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#a0be6853ac207d4db173440433f6b7fa1">notifyRunning</a>();
<a name="l01460"></a>01460 
<a name="l01461"></a>01461                 <span class="keywordflow">if</span> (item != null) {
<a name="l01462"></a>01462                     item.clear(null);
<a name="l01463"></a>01463                 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465                 item = enableStackTraces ?
<a name="l01466"></a>01466                     <span class="keyword">new</span> SlowItem(<span class="keyword">this</span>, RequestProcessor.this) :
<a name="l01467"></a>01467                     new FastItem(this, RequestProcessor.this);
<a name="l01468"></a>01468                 localItem = item;
<a name="l01469"></a>01469             }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471             <span class="keywordflow">if</span> (delay == 0) { <span class="comment">// Place it to pending queue immediatelly</span>
<a name="l01472"></a>01472                 enqueue(localItem);
<a name="l01473"></a>01473             } <span class="keywordflow">else</span> { <span class="comment">// Post the starter</span>
<a name="l01474"></a>01474                 TickTac.schedule(localItem, delay);
<a name="l01475"></a>01475             }
<a name="l01476"></a>01476         }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478         <span class="keyword">private</span> <span class="keywordtype">void</span> markCreated() {
<a name="l01479"></a>01479             assert item == null;
<a name="l01480"></a>01480             item = <span class="keyword">new</span> CreatedItem(<span class="keyword">this</span>, null);
<a name="l01481"></a>01481         }
<a name="l01482"></a>01482 
<a name="l01488"></a>01488         @Override
<a name="l01489"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#afa7e4f09a949327bbe2416e62989b4ac">01489</a>         <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#afa7e4f09a949327bbe2416e62989b4ac">cancel</a>() {
<a name="l01490"></a>01490             <span class="keywordflow">return</span> cancelOrNew(<span class="keyword">false</span>);
<a name="l01491"></a>01491         }
<a name="l01492"></a>01492         
<a name="l01493"></a>01493         <span class="keyword">private</span> <span class="keywordtype">boolean</span> cancelOrNew(<span class="keywordtype">boolean</span> canBeNew) {
<a name="l01494"></a>01494             <span class="keyword">synchronized</span> (processorLock) {
<a name="l01495"></a>01495                 <span class="keywordtype">boolean</span> success;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497                 <span class="keywordflow">if</span> (item == null) {
<a name="l01498"></a>01498                     success = <span class="keyword">false</span>;
<a name="l01499"></a>01499                 } <span class="keywordflow">else</span> {
<a name="l01500"></a>01500                     Processor p = item.getProcessor();
<a name="l01501"></a>01501                     success = item.clearOrNew(canBeNew);
<a name="l01502"></a>01502 
<a name="l01503"></a>01503                     <span class="keywordflow">if</span> (p != null) {
<a name="l01504"></a>01504                         p.interruptTask(<span class="keyword">this</span>, <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>.this);
<a name="l01505"></a>01505                         item = null;
<a name="l01506"></a>01506                     }
<a name="l01507"></a>01507                     
<a name="l01508"></a>01508                     <span class="keywordflow">if</span> (success) {
<a name="l01509"></a>01509                         item = null;
<a name="l01510"></a>01510                     }
<a name="l01511"></a>01511                 }
<a name="l01512"></a>01512 
<a name="l01513"></a>01513                 <span class="keywordflow">if</span> (success) {
<a name="l01514"></a>01514                     <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#af31e5ee8dda43bae9a6d2fc48569448d">notifyFinished</a>(); <span class="comment">// mark it as finished</span>
<a name="l01515"></a>01515                 }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517                 <span class="keywordflow">return</span> success;
<a name="l01518"></a>01518             }
<a name="l01519"></a>01519         }
<a name="l01520"></a>01520 
<a name="l01528"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#ac530078c99a011d9aff38dbebc43a1ee">01528</a>         <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#ac530078c99a011d9aff38dbebc43a1ee">cancel</a> (<span class="keywordtype">boolean</span> interrupt) {
<a name="l01529"></a>01529             <span class="keyword">synchronized</span> (processorLock) {
<a name="l01530"></a>01530                 <span class="keywordflow">if</span> (cancelled != null) {
<a name="l01531"></a>01531                     <span class="keywordtype">boolean</span> wasCancelled = !cancelled.getAndSet(<span class="keyword">true</span>);
<a name="l01532"></a>01532                     <span class="keywordflow">if</span> (wasCancelled) {
<a name="l01533"></a>01533                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01534"></a>01534                     }
<a name="l01535"></a>01535                 }
<a name="l01536"></a>01536                 <span class="keywordtype">boolean</span> success;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538                 <span class="keywordflow">if</span> (item == null) {
<a name="l01539"></a>01539                     success = <span class="keyword">false</span>;
<a name="l01540"></a>01540                 } <span class="keywordflow">else</span> {
<a name="l01541"></a>01541                     Processor p = item.getProcessor();
<a name="l01542"></a>01542                     success = item.clear(null);
<a name="l01543"></a>01543 
<a name="l01544"></a>01544                     <span class="keywordflow">if</span> (p != null) {
<a name="l01545"></a>01545                         <span class="keywordflow">if</span> (interrupt) {
<a name="l01546"></a>01546                             success = p.interrupt(<span class="keyword">this</span>, <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>.this);
<a name="l01547"></a>01547                         } <span class="keywordflow">else</span> {
<a name="l01548"></a>01548                             <span class="comment">//despite its name, will not actually interrupt</span>
<a name="l01549"></a>01549                             <span class="comment">//unless the RP specifies that it should</span>
<a name="l01550"></a>01550                             p.interruptTask(<span class="keyword">this</span>, <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>.this);
<a name="l01551"></a>01551                         }
<a name="l01552"></a>01552                         <span class="keywordflow">if</span> (success) {
<a name="l01553"></a>01553                             item = null;
<a name="l01554"></a>01554                         }
<a name="l01555"></a>01555                     }
<a name="l01556"></a>01556                 }
<a name="l01557"></a>01557                 <span class="keywordflow">if</span> (success) {
<a name="l01558"></a>01558                     <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#af31e5ee8dda43bae9a6d2fc48569448d">notifyFinished</a>(); <span class="comment">// mark it as finished</span>
<a name="l01559"></a>01559                 }
<a name="l01560"></a>01560                 <span class="keywordflow">return</span> success;
<a name="l01561"></a>01561             }
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563 
<a name="l01567"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a69c3e73b5edf296645f0fa6bcc923121">01567</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a69c3e73b5edf296645f0fa6bcc923121">getPriority</a>() {
<a name="l01568"></a>01568             <span class="keywordflow">return</span> priority;
<a name="l01569"></a>01569         }
<a name="l01570"></a>01570 
<a name="l01574"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#ad9db5b606f181a1306f0ea2549571be0">01574</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#ad9db5b606f181a1306f0ea2549571be0">setPriority</a>(<span class="keywordtype">int</span> priority) {
<a name="l01575"></a>01575             <span class="keywordflow">if</span> (this.priority == priority) {
<a name="l01576"></a>01576                 <span class="keywordflow">return</span>;
<a name="l01577"></a>01577             }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579             <span class="keywordflow">if</span> (priority &lt; Thread.MIN_PRIORITY) {
<a name="l01580"></a>01580                 priority = Thread.MIN_PRIORITY;
<a name="l01581"></a>01581             }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583             <span class="keywordflow">if</span> (priority &gt; Thread.MAX_PRIORITY) {
<a name="l01584"></a>01584                 priority = Thread.MAX_PRIORITY;
<a name="l01585"></a>01585             }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587             this.priority = priority;
<a name="l01588"></a>01588 
<a name="l01589"></a>01589             <span class="comment">// update queue position accordingly</span>
<a name="l01590"></a>01590             <span class="keyword">synchronized</span> (processorLock) {
<a name="l01591"></a>01591                 <span class="keywordflow">if</span> (item == null) {
<a name="l01592"></a>01592                     <span class="keywordflow">return</span>;
<a name="l01593"></a>01593                 }
<a name="l01594"></a>01594 
<a name="l01595"></a>01595                 <span class="keywordflow">if</span> (getQueue().remove(item)) {
<a name="l01596"></a>01596                     prioritizedEnqueue(item);
<a name="l01597"></a>01597                 }
<a name="l01598"></a>01598             }
<a name="l01599"></a>01599         }
<a name="l01600"></a>01600 
<a name="l01606"></a>01606         @Override
<a name="l01607"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a13828703e6a8c8990fd8f1273371913a">01607</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#a13828703e6a8c8990fd8f1273371913a">waitFinished</a>() {
<a name="l01608"></a>01608             <span class="keywordflow">if</span> (isRequestProcessorThread()) { <span class="comment">//System.err.println(</span>
<a name="l01609"></a>01609                 <span class="keywordtype">boolean</span> runAtAll;
<a name="l01610"></a>01610                 <span class="keywordtype">boolean</span> toRun;
<a name="l01611"></a>01611                 
<a name="l01612"></a>01612                 Logger em = logger();
<a name="l01613"></a>01613                 <span class="keywordtype">boolean</span> loggable = em.isLoggable(Level.FINE);
<a name="l01614"></a>01614                 
<a name="l01615"></a>01615                 <span class="keywordflow">if</span> (loggable) {
<a name="l01616"></a>01616                     em.log(Level.FINE, <span class="stringliteral">&quot;Task.waitFinished on {0} from other task in RP: {1}&quot;</span>, <span class="keyword">new</span> Object[]{<span class="keyword">this</span>, Thread.currentThread().getName()}); <span class="comment">// NOI18N</span>
<a name="l01617"></a>01617                 }
<a name="l01618"></a>01618                 
<a name="l01619"></a>01619 
<a name="l01620"></a>01620                 <span class="keyword">synchronized</span> (processorLock) {
<a name="l01621"></a>01621                     <span class="comment">// correct line:    toRun = (item == null) ? !isFinished (): (item.clear() &amp;&amp; !isFinished ());</span>
<a name="l01622"></a>01622                     <span class="comment">// the same:        toRun = !isFinished () &amp;&amp; (item == null ? true : item.clear ());</span>
<a name="l01623"></a>01623                     runAtAll = cancelOrNew(<span class="keyword">true</span>);
<a name="l01624"></a>01624                     toRun = runAtAll &amp;&amp; ((item == null) || item.clear(null));
<a name="l01625"></a>01625                     <span class="keywordflow">if</span> (loggable) {
<a name="l01626"></a>01626                         em.log(Level.FINE, <span class="stringliteral">&quot;    ## finished: {0}&quot;</span>, <a class="code" href="classorg_1_1openide_1_1util_1_1_task.html#a630d34b278b2c43028eafe191c1a7314">isFinished</a>()); <span class="comment">// NOI18N</span>
<a name="l01627"></a>01627                         em.log(Level.FINE, <span class="stringliteral">&quot;    ## item: {0}&quot;</span>, item); <span class="comment">// NOI18N</span>
<a name="l01628"></a>01628                     }
<a name="l01629"></a>01629                 }
<a name="l01630"></a>01630 
<a name="l01631"></a>01631                 <span class="keywordflow">if</span> (toRun) { 
<a name="l01632"></a>01632                     <span class="keywordflow">if</span> (loggable) {
<a name="l01633"></a>01633                         em.fine(<span class="stringliteral">&quot;    ## running it synchronously&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01634"></a>01634                     }
<a name="l01635"></a>01635                     Processor processor = (Processor)Thread.currentThread();
<a name="l01636"></a>01636                     processor.doEvaluate (<span class="keyword">this</span>, processorLock, <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor.html">RequestProcessor</a>.this);
<a name="l01637"></a>01637                 } <span class="keywordflow">else</span> { <span class="comment">// it is already running in other thread of this RP</span>
<a name="l01638"></a>01638                     <span class="keywordflow">if</span> (loggable) {
<a name="l01639"></a>01639                         em.fine(<span class="stringliteral">&quot;    ## not running it synchronously&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01640"></a>01640                     }
<a name="l01641"></a>01641 
<a name="l01642"></a>01642                     <span class="keywordflow">if</span> (runAtAll &amp;&amp; lastThread != Thread.currentThread()) {
<a name="l01643"></a>01643                         <span class="keywordflow">if</span> (loggable) {
<a name="l01644"></a>01644                             em.log(Level.FINE, <span class="stringliteral">&quot;    ## waiting for it to be finished: {0} now: {1}&quot;</span>, <span class="keyword">new</span> Object[]{lastThread, Thread.currentThread()}); <span class="comment">// NOI18N</span>
<a name="l01645"></a>01645                         }
<a name="l01646"></a>01646                         super.waitFinished();
<a name="l01647"></a>01647                     }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649                     <span class="comment">//                    else {</span>
<a name="l01650"></a>01650                     <span class="comment">//System.err.println(&quot;Thread waiting for itself!!!!! - semantics broken!!!&quot;);</span>
<a name="l01651"></a>01651                     <span class="comment">//Thread.dumpStack();</span>
<a name="l01652"></a>01652                     <span class="comment">//                    }</span>
<a name="l01653"></a>01653                 }
<a name="l01654"></a>01654                 <span class="keywordflow">if</span> (loggable) {
<a name="l01655"></a>01655                     em.fine(<span class="stringliteral">&quot;    ## exiting waitFinished&quot;</span>); <span class="comment">// NOI18N</span>
<a name="l01656"></a>01656                 }
<a name="l01657"></a>01657             } <span class="keywordflow">else</span> {
<a name="l01658"></a>01658                 super.waitFinished();
<a name="l01659"></a>01659             }
<a name="l01660"></a>01660         }
<a name="l01661"></a>01661 
<a name="l01675"></a>01675         @Override
<a name="l01676"></a><a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#af5285729bbe091983ddb1320099ccac9">01676</a>         <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classorg_1_1openide_1_1util_1_1_request_processor_1_1_task.html#af5285729bbe091983ddb1320099ccac9">waitFinished</a>(<span class="keywordtype">long</span> timeout) <span class="keywordflow">throws</span> InterruptedException {
<a name="l01677"></a>01677             <span class="keywordflow">if</span> (isRequestProcessorThread()) {
<a name="l01678"></a>01678                 <span class="keywordtype">boolean</span> toRun;
<a name="l01679"></a>01679 
<a name="l01680"></a>01680                 <span class="keyword">synchronized</span> (processorLock) {
<a name="l01681"></a>01681                     toRun = cancelOrNew(<span class="keyword">true</span>);
<a name="l01682"></a>01682                 }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684                 <span class="keywordflow">if</span> (toRun) {
<a name="l01685"></a>01685                     <span class="keywordflow">throw</span> <span class="keyword">new</span> InterruptedException(
<a name="l01686"></a>01686                         <span class="stringliteral">&quot;Cannot wait with timeout &quot;</span> + timeout + <span class="stringliteral">&quot; from the RequestProcessor thread for task: &quot;</span> + <span class="keyword">this</span>
<a name="l01687"></a>01687                     ); <span class="comment">// NOI18N</span>
<a name="l01688"></a>01688                 } <span class="keywordflow">else</span> { <span class="comment">// it is already running in other thread of this RP</span>
<a name="l01689"></a>01689 
<a name="l01690"></a>01690                     <span class="keywordflow">if</span> (lastThread != Thread.currentThread()) {
<a name="l01691"></a>01691                         <span class="keywordflow">return</span> super.waitFinished(timeout);
<a name="l01692"></a>01692                     } <span class="keywordflow">else</span> {
<a name="l01693"></a>01693                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01694"></a>01694                     }
<a name="l01695"></a>01695                 }
<a name="l01696"></a>01696             } <span class="keywordflow">else</span> {
<a name="l01697"></a>01697                 <span class="keywordflow">return</span> super.waitFinished(timeout);
<a name="l01698"></a>01698             }
<a name="l01699"></a>01699         }
<a name="l01700"></a>01700 
<a name="l01701"></a>01701         @Override
<a name="l01702"></a>01702         <span class="keyword">public</span> String toString() {
<a name="l01703"></a>01703             <span class="keywordflow">return</span> <span class="stringliteral">&quot;RequestProcessor.Task [&quot;</span> + name + <span class="stringliteral">&quot;, &quot;</span> + priority + <span class="stringliteral">&quot;] for &quot;</span> + super.toString(); <span class="comment">// NOI18N</span>
<a name="l01704"></a>01704         }
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     <span class="comment">/* One item representing the task pending in the pending queue */</span>
<a name="l01708"></a>01708     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span>Item <span class="keyword">extends</span> Exception {
<a name="l01709"></a>01709         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01710"></a>01710 
<a name="l01711"></a>01711         <span class="keyword">private</span> <span class="keyword">final</span> RequestProcessor owner;
<a name="l01712"></a>01712         Object action;
<a name="l01713"></a>01713         <span class="keywordtype">boolean</span> enqueued;
<a name="l01714"></a>01714         String message;
<a name="l01716"></a>01716         <span class="keywordtype">long</span> when;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         Item(Task task, RequestProcessor rp) {
<a name="l01719"></a>01719             action = task;
<a name="l01720"></a>01720             owner = rp;
<a name="l01721"></a>01721         }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723         <span class="keyword">final</span> Task getTask() {
<a name="l01724"></a>01724             Object a = action;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726             <span class="keywordflow">return</span> (a instanceof Task) ? (Task) a : null;
<a name="l01727"></a>01727         }
<a name="l01728"></a>01728         
<a name="l01729"></a>01729         <span class="keywordtype">boolean</span> clearOrNew(<span class="keywordtype">boolean</span> canBeNew) {
<a name="l01730"></a>01730             <span class="keywordflow">return</span> clear(null);
<a name="l01731"></a>01731         }
<a name="l01732"></a>01732 
<a name="l01736"></a>01736         <span class="keywordtype">boolean</span> clear(Processor processor) {
<a name="l01737"></a>01737             <span class="keywordtype">boolean</span> ret;
<a name="l01738"></a>01738             <span class="keyword">synchronized</span> (owner.processorLock) {
<a name="l01739"></a>01739                 action = processor;
<a name="l01740"></a>01740                 ret = enqueued ? owner.getQueue().remove(<span class="keyword">this</span>) : <span class="keyword">true</span>;
<a name="l01741"></a>01741             }
<a name="l01742"></a>01742             TickTac.cancel(<span class="keyword">this</span>);
<a name="l01743"></a>01743             <span class="keywordflow">return</span> ret;
<a name="l01744"></a>01744         }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746         <span class="keywordtype">boolean</span> isNew() {
<a name="l01747"></a>01747             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01748"></a>01748         }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750         <span class="keyword">final</span> Processor getProcessor() {
<a name="l01751"></a>01751             Object a = action;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753             <span class="keywordflow">return</span> (a instanceof Processor) ? (Processor) a : null;
<a name="l01754"></a>01754         }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756         <span class="keyword">final</span> <span class="keywordtype">int</span> getPriority() {
<a name="l01757"></a>01757             <span class="keywordflow">return</span> getTask().getPriority();
<a name="l01758"></a>01758         }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         <span class="keyword">public</span> <span class="keyword">final</span> @Override String getMessage() {
<a name="l01761"></a>01761             <span class="keywordflow">return</span> message;
<a name="l01762"></a>01762         }
<a name="l01763"></a>01763     }
<a name="l01764"></a>01764     
<a name="l01765"></a>01765     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span>CreatedItem <span class="keyword">extends</span> Item {
<a name="l01766"></a>01766         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         <span class="keyword">public</span> CreatedItem(Task task, RequestProcessor rp) {
<a name="l01769"></a>01769             super(task, rp);
<a name="l01770"></a>01770         }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772         @Override
<a name="l01773"></a>01773         <span class="keywordtype">boolean</span> clearOrNew(<span class="keywordtype">boolean</span> canBeNew) {
<a name="l01774"></a>01774             <span class="keywordflow">return</span> canBeNew;
<a name="l01775"></a>01775         }
<a name="l01776"></a>01776         
<a name="l01777"></a>01777         @Override
<a name="l01778"></a>01778         <span class="keywordtype">boolean</span> clear(Processor processor) {
<a name="l01779"></a>01779             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01780"></a>01780         }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782         @Override
<a name="l01783"></a>01783         <span class="keywordtype">boolean</span> isNew() {
<a name="l01784"></a>01784             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01785"></a>01785         }
<a name="l01786"></a>01786     } <span class="comment">// end of CreatedItem</span>
<a name="l01787"></a>01787 
<a name="l01788"></a>01788     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span>FastItem <span class="keyword">extends</span> Item {
<a name="l01789"></a>01789         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01790"></a>01790 
<a name="l01791"></a>01791         FastItem(Task task, RequestProcessor rp) {
<a name="l01792"></a>01792             super(task, rp);
<a name="l01793"></a>01793         }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795         @Override
<a name="l01796"></a>01796         <span class="keyword">public</span> Throwable fillInStackTrace() {
<a name="l01797"></a>01797             <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l01798"></a>01798         }
<a name="l01799"></a>01799     }
<a name="l01800"></a>01800     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span>SlowItem <span class="keyword">extends</span> Item {
<a name="l01801"></a>01801         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803         SlowItem(Task task, RequestProcessor rp) {
<a name="l01804"></a>01804             super(task, rp);
<a name="l01805"></a>01805         }
<a name="l01806"></a>01806 
<a name="l01807"></a>01807         @Override
<a name="l01808"></a>01808         <span class="keyword">public</span> Throwable fillInStackTrace() {
<a name="l01809"></a>01809             Throwable ret = super.fillInStackTrace();
<a name="l01810"></a>01810             StackTraceElement[] arr = ret.getStackTrace();
<a name="l01811"></a>01811             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; arr.length; i++) {
<a name="l01812"></a>01812                 <span class="keywordflow">if</span> (arr[i].getClassName().startsWith(<span class="stringliteral">&quot;java.lang&quot;</span>)) {
<a name="l01813"></a>01813                     <span class="keywordflow">continue</span>;
<a name="l01814"></a>01814                 }
<a name="l01815"></a>01815                 <span class="keywordflow">if</span> (arr[i].getClassName().startsWith(RequestProcessor.class.getName())) {
<a name="l01816"></a>01816                     <span class="keywordflow">continue</span>;
<a name="l01817"></a>01817                 }
<a name="l01818"></a>01818                 ret.setStackTrace(Arrays.asList(arr).subList(i - 1, arr.length).toArray(<span class="keyword">new</span> StackTraceElement[0]));
<a name="l01819"></a>01819                 <span class="keywordflow">break</span>;
<a name="l01820"></a>01820             }
<a name="l01821"></a>01821             <span class="keywordflow">return</span> ret;
<a name="l01822"></a>01822         }
<a name="l01823"></a>01823     }
<a name="l01824"></a>01824 
<a name="l01825"></a>01825     <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l01826"></a>01826     <span class="comment">// The Processor management implementation</span>
<a name="l01827"></a>01827     <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l01828"></a>01828 
<a name="l01834"></a>01834 
<a name="l01836"></a>01836 
<a name="l01839"></a>01839 
<a name="l01845"></a>01845 
<a name="l01849"></a>01849 
<a name="l01853"></a>01853 
<a name="l01866"></a>01866 
<a name="l01893"></a>01893 
<a name="l01903"></a>01903 
<a name="l01915"></a>01915 
<a name="l01932"></a>01932 
<a name="l02030"></a>02030 
<a name="l02051"></a>02051 
<a name="l02072"></a>02072 
<a name="l02089"></a>02089 </pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>RequestProcessor.java</b>      </li>
      <li class="footer">Erzeugt am Thu Jun 7 2012 22:12:14 für (AB)² Simulation von&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Alle</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Klassen</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namensbereiche</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Funktionen</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variablen</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Aufzählungen</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
